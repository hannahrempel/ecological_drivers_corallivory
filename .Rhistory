tidy()
KW_test_coral_cover
Dunn_test_coral_cover <- fish_corals_site_level %>%
rstatix::dunn_test(mean_pct_coral_cover ~ region, p.adjust.method = "BH", detailed = FALSE)
Dunn_test_coral_cover
model_scar_density_region <- aov(log(mean_scars_m2_coral)~region, data = fish_corals_site_level)
#Testing model assumptions: outliers by region via IQR method (none)
fish_corals_site_level %>%
group_by(region) %>%
mutate(lm_mean_scars_m2_coral=log(mean_scars_m2_coral)) %>%
rstatix::identify_outliers(lm_mean_scars_m2_coral)
#Testing model assumptions: no significant violations of homogeneity of variance
fish_corals_site_level %>%
mutate(lm_mean_scars_m2_coral=log(mean_scars_m2_coral)) %>%
rstatix::levene_test(lm_mean_scars_m2_coral ~ region)
#Testing model assumptions: no significant violations of normality assumption by region
fish_corals_site_level %>%
group_by(region) %>%
mutate(lm_mean_scars_m2_coral=log(mean_scars_m2_coral)) %>%
rstatix::shapiro_test(lm_mean_scars_m2_coral)
#Testing model assumptions: no significant violations of normality assumption for overall model
rstatix::shapiro_test(residuals(model_scar_density_region))
#Testing model assumptions: visual assessment of residuals
plot(model_scar_density_region)
#Model meets assumptions, so proceeding with interpreting model output
summary(model_scar_density_region)
#Testing for pairwise differences in scar density by region and estimated marginal means
TukeyHSD(model_scar_density_region) %>% broom::tidy()
model_pct_grazed_region <- aov(log(mean_pct_coral_grazed)~region, data = fish_corals_site_level)
#Testing model assumptions: significant violations of normality assumption for overall model
rstatix::shapiro_test(residuals(model_pct_grazed_region))
#Testing model assumptions: significant violations of normality assumption by region for St. Croix
fish_corals_site_level %>%
group_by(region) %>%
mutate(lm_mean_pct_coral_grazed=log(mean_pct_coral_grazed)) %>%
rstatix::shapiro_test(lm_mean_pct_coral_grazed)
#Testing model assumptions: outliers by region via IQR method (Teague Bay in St. Croix sig. outlier)
fish_corals_site_level %>%
group_by(region) %>%
mutate(lm_mean_pct_coral_grazed=log(mean_pct_coral_grazed)) %>%
rstatix::identify_outliers(lm_mean_pct_coral_grazed)
#Testing model assumptions: no significant violations of homogeneity of variance
fish_corals_site_level %>% mutate(ln_mean_pct_coral_grazed=log(mean_pct_coral_grazed)) %>% rstatix::levene_test(ln_mean_pct_coral_grazed ~ region)
#Using non-parametric test instead due to normality violations
#Kruskal-Wallis test of percent coral grazed by region and post-hoc Dunn test
KW_test_pct_coral_grazed <- kruskal.test(mean_pct_coral_grazed ~ region, data=fish_corals_site_level) %>%
tidy()
KW_test_pct_coral_grazed
#post hoc test
Dunn_test_pct_coral_grazed <- fish_corals_site_level %>%
rstatix::dunn_test(mean_pct_coral_grazed ~ region, p.adjust.method = "BH", detailed = FALSE)
Dunn_test_pct_coral_grazed
#raw selectivity data
selectivity_df_genus <- coral_scar_df %>%
mutate(coral_genus=gsub("\\s.*", "", coral_species),
coral_genus=case_when(coral_genus=="Branching"~"Porites",
TRUE~as.character(coral_genus))) %>%
group_by(region, site, coral_genus) %>%
dplyr::reframe(total_n_scars=sum(n_new_scars),
total_n_colonies=n(),
total_scar_area=sum(total_grazed_cm2),
total_colony_area=sum(col_area_cm2)) %>%
#Vanderploeg and Scavia’s relativised electivity, E*
mutate(n_elect_vs= electivity::vs_electivity(total_n_scars, total_n_colonies),
area_elect_vs= electivity::vs_electivity(total_scar_area, total_colony_area),
percent_cover=(total_colony_area/300000)*100) %>%
mutate(region_short=case_when(region=="Panamá"~"PAN",
region=="St. Croix"~"STX",
region=="Florida"~"FLA",
region=="Bonaire"~"BON",
TRUE~as.character(region)),
region_short=factor(region_short, levels = c("PAN", "FLA", "STX", "BON")))
#mean selectivity and 95% confidence intervals
selectivity_summary_stats_genus <- selectivity_df_genus %>%
group_by(region, region_short, coral_genus) %>%
dplyr::reframe(mean_n_elect_vs=mean(n_elect_vs),
sd_n_elect_vs= sd(n_elect_vs),
mean_area_elect_vs=mean(area_elect_vs),
sd_area_elect_vs= sd(area_elect_vs),
n=n()) %>%
#calculating mean and 95% CI
mutate(ci_lower_n_elect=mean_n_elect_vs-(qnorm(0.975)*sd_n_elect_vs/sqrt(n)),
ci_upper_n_elect=mean_n_elect_vs+(qnorm(0.975)*sd_n_elect_vs/sqrt(n)),
ci_lower_area_elect=mean_area_elect_vs-(qnorm(0.975)*sd_area_elect_vs/sqrt(n)),
ci_upper_area_elect=mean_area_elect_vs+(qnorm(0.975)*sd_area_elect_vs/sqrt(n))) %>%
#limiting bounds to between -1 and 1 (as values beyond this have no meanining in the electivity index)
mutate(ci_lower_n_elect=case_when(ci_lower_n_elect < -1 ~ -1,
TRUE~as.double(ci_lower_n_elect)),
ci_upper_n_elect=case_when(ci_upper_n_elect > 1 ~ 1,
TRUE~as.double(ci_upper_n_elect)),
ci_lower_area_elect=case_when(ci_lower_area_elect < -1 ~ -1,
TRUE~as.double(ci_lower_area_elect)),
ci_upper_area_elect=case_when(ci_upper_area_elect > 1 ~ 1,
TRUE~as.double(ci_upper_area_elect))) %>%
#determing significance (sig. avoidance if 95% CIs are <0, sig. preference if >0, neutral if the 95% CI crosses 0)
mutate(abundance_selectivity_sig=case_when(ci_lower_n_elect <0 & ci_upper_n_elect>0~"NS",
ci_lower_n_elect <0 & ci_upper_n_elect<0~"Avoidance",
ci_lower_n_elect >0 & ci_upper_n_elect>0~"Preference"),
area_selectivity_sig=case_when(ci_lower_area_elect <0 & ci_upper_area_elect>0~"NS",
ci_lower_area_elect <0 & ci_upper_area_elect<0~"Avoidance",
ci_lower_area_elect >0 & ci_upper_area_elect>0~"Preference"))
#creating longer form selectivity summary stats and raw data
abundance_subset_genus <- selectivity_summary_stats_genus %>%
select(region_short, coral_genus, mean_electivity=mean_n_elect_vs, ci_lower=ci_lower_n_elect, ci_upper=ci_upper_n_elect) %>%
mutate(metric="Abundance-based")
area_subset_genus <-selectivity_summary_stats_genus %>%
select(region_short, coral_genus, mean_electivity=mean_area_elect_vs, ci_lower=ci_lower_area_elect, ci_upper=ci_upper_area_elect) %>%
mutate(metric="Area-based")
combined_selectivity_summary_genus <- bind_rows(abundance_subset_genus, area_subset_genus)
selectivity_raw_genus <- selectivity_df_genus %>%
ungroup() %>%
select(region_short, site, coral_genus, n_elect_vs, area_elect_vs) %>%
pivot_longer(n_elect_vs:area_elect_vs, names_to = "index", values_to="electivity") %>%
mutate(metric=case_when(grepl("n_elect", index)~"Abundance-based",
grepl("area_elect", index)~"Area-based")) %>%
select(-index)
#creating preliminary figure
selectivity_genus_temp <- ggplot()+
geom_point(data=selectivity_raw_genus, aes(y=region_short, x=electivity, color=region_short), alpha=0.5, position=position_jitter(height=0.1))+ #raw data points
geom_pointrange(data=combined_selectivity_summary_genus, aes(y=region_short, x=mean_electivity, xmin=ci_lower, xmax=ci_upper, fill=region_short), color="black", pch=21, size=0.5)+ #mean and 95% CI
scale_x_discrete(limits = rev)+ #so regions are in same order as in previous figs
scale_colour_manual(values=region_palette)+
scale_fill_manual(values=region_palette)+
xlim(-1.1,1.1)+ #slightly larger than -1 and 1 so that jitter isn't out of bounds
geom_vline(xintercept=0,linetype=2)+ #dashed line at 0 (no electivity)
theme_bw()+
labs(x="V.S. relativized electivity (E*)", y="Region")+
facet_grid(metric~coral_genus)+
coord_flip()+
theme(legend.position = "none")
#reading in coral genus icons
agaricia_image <- magick::image_read(path=here("figures_tables/reef_images", "Agaricia_tenuifolia.png"), density = NULL, depth = NULL, strip = TRUE)
madracis_image <- magick::image_read(path=here("figures_tables/reef_images", "Madracis_decactis.png"), density = NULL, depth = NULL, strip = TRUE)
orbicella_image <- magick::image_read(path=here("figures_tables/reef_images", "Orbicella_annularis.png"), density = NULL, depth = NULL, strip = TRUE)
porites_image <- magick::image_read(path=here("figures_tables/reef_images", "Porites_astreoides.png"), density = NULL, depth = NULL, strip = TRUE)
siderastrea_image <- magick::image_read(path=here("figures_tables/reef_images", "Siderastrea_siderea.png"), density = NULL, depth = NULL, strip = TRUE)
stephanocinea_image <- magick::image_read(path=here("figures_tables/reef_images", "Stephanocoenia_intersepta.png"), density = NULL, depth = NULL, strip = TRUE)
#adding coral images to figure (image placement is off in R, but good in ggsave generated png)
selectivity_genus_final <- cowplot::ggdraw() +
draw_plot(selectivity_genus_temp)+ #adds the plot (order matters to overlay the layers correctly)
draw_image(agaricia_image, x = -0.32, y = 0.385, scale=0.11)+
draw_image(madracis_image, x = -0.17, y = 0.385, scale=0.082)+
draw_image(orbicella_image, x = -0.02, y = 0.38, scale=0.064)+
draw_image(porites_image, x = 0.13, y = 0.386, scale=0.059)+
draw_image(siderastrea_image, x = 0.28, y = 0.387, scale=0.049)+
draw_image(stephanocinea_image, x = 0.429, y = 0.387, scale=0.059)
selectivity_genus_final
#saving figure
ggsave(plot=selectivity_genus_final, filename=here("figures_tables/fig3_selectivity_by_genera.jpg"), width = 215, height = 110, dpi = 600, units = "mm")
selectivity_summary_stats_genus %>%
select(region, coral_genus, abundance_selectivity_sig, area_selectivity_sig)
#Total number of colonies grazed (for coral taxa with 3+ predated cols across observations)
n_grazed_cols <- coral_scar_df %>%
filter(n_new_scars>0) %>%
distinct(colony_id) %>%
nrow()
#Number of grazed colonies by taxa
coral_scar_df %>%
filter(n_new_scars>0) %>%
group_by(coral_species) %>%
tally() %>%
arrange(-n)
#Total number of colonies grazed for top four predated species
n_top_4_grazed <- coral_scar_df %>%
filter(n_new_scars>0) %>%
filter(coral_species %in% c("Orbicella annularis", "Branching Porites spp.", "Porites astreoides", "Siderastrea siderea")) %>%
distinct(colony_id) %>%
nrow()
#>80% of observed predation was on these four coral species
n_top_4_grazed/n_grazed_cols*100
#raw selectivity data
selectivity_df_species <- coral_scar_df %>%
filter(coral_species %in% c("Orbicella annularis", "Branching Porites spp.", "Porites astreoides", "Siderastrea siderea")) %>%
mutate(coral_species=factor(coral_species, levels = c("Orbicella annularis", "Branching Porites spp.", "Porites astreoides", "Siderastrea siderea"))) %>%
group_by(region, site, coral_species) %>%
dplyr::reframe(total_n_scars=sum(n_new_scars),
total_n_colonies=n(),
total_scar_area=sum(total_grazed_cm2),
total_colony_area=sum(col_area_cm2)) %>%
#Vanderploeg and Scavia’s relativised electivity, E*
mutate(n_elect_vs= electivity::vs_electivity(total_n_scars, total_n_colonies),
area_elect_vs= electivity::vs_electivity(total_scar_area, total_colony_area),
percent_cover=(total_colony_area/300000)*100) %>%
mutate(region_short=case_when(region=="Panamá"~"PAN",
region=="St. Croix"~"STX",
region=="Florida"~"FLA",
region=="Bonaire"~"BON",
TRUE~as.character(region)),
region_short=factor(region_short, levels = c("PAN", "FLA", "STX", "BON"))) %>%
mutate(n_elect_vs=case_when(n_elect_vs=="NaN"~-1,
TRUE~as.double(n_elect_vs)),
area_elect_vs=case_when(area_elect_vs=="NaN"~-1,
TRUE~as.double(n_elect_vs))) %>%
ungroup()
#mean selectivity and 95% confidence intervals
species_selectivity_summary_stats <- selectivity_df_species %>%
group_by(region, region_short, coral_species) %>%
dplyr::reframe(mean_n_elect_vs=mean(n_elect_vs),
sd_n_elect_vs= sd(n_elect_vs),
mean_area_elect_vs=mean(area_elect_vs),
sd_area_elect_vs= sd(area_elect_vs),
n=n()) %>%
#calculating mean and 95% CI
mutate(ci_lower_n_elect=mean_n_elect_vs-(qnorm(0.975)*sd_n_elect_vs/sqrt(n)),
ci_upper_n_elect=mean_n_elect_vs+(qnorm(0.975)*sd_n_elect_vs/sqrt(n)),
ci_lower_area_elect=mean_area_elect_vs-(qnorm(0.975)*sd_area_elect_vs/sqrt(n)),
ci_upper_area_elect=mean_area_elect_vs+(qnorm(0.975)*sd_area_elect_vs/sqrt(n))) %>%
#limiting bounds to between -1 and 1 (as values beyond this have no meanining in the electivity index)
mutate(ci_lower_n_elect=case_when(ci_lower_n_elect < -1 ~ -1,
TRUE~as.double(ci_lower_n_elect)),
ci_upper_n_elect=case_when(ci_upper_n_elect > 1 ~ 1,
TRUE~as.double(ci_upper_n_elect)),
ci_lower_area_elect=case_when(ci_lower_area_elect < -1 ~ -1,
TRUE~as.double(ci_lower_area_elect)),
ci_upper_area_elect=case_when(ci_upper_area_elect > 1 ~ 1,
TRUE~as.double(ci_upper_area_elect))) %>%
#determing significance (sig. avoidance if 95% CIs are <0, sig. preference if >0, neutral if the 95% CI crosses 0)
mutate(abundance_selectivity_sig=case_when(ci_lower_n_elect <0 & ci_upper_n_elect>0~"NS",
ci_lower_n_elect <0 & ci_upper_n_elect<0~"Avoidance",
ci_lower_n_elect >0 & ci_upper_n_elect>0~"Preference"),
area_selectivity_sig=case_when(ci_lower_area_elect <0 & ci_upper_area_elect>0~"NS",
ci_lower_area_elect <0 & ci_upper_area_elect<0~"Avoidance",
ci_lower_area_elect >0 & ci_upper_area_elect>0~"Preference")) %>%
ungroup()
#creating longer form selectivity summary stats and raw data
abundance_subset <- species_selectivity_summary_stats %>%
select(region_short, coral_species, mean_electivity=mean_n_elect_vs, ci_lower=ci_lower_n_elect, ci_upper=ci_upper_n_elect) %>%
mutate(metric="Abundance-based")
area_subset <-species_selectivity_summary_stats %>%
select(region_short, coral_species, mean_electivity=mean_area_elect_vs, ci_lower=ci_lower_area_elect, ci_upper=ci_upper_area_elect) %>%
mutate(metric="Area-based")
combined_selectivity_summary <- bind_rows(abundance_subset, area_subset)
selectivity_raw <- selectivity_df_species %>%
ungroup() %>%
select(region_short, site, coral_species, n_elect_vs, area_elect_vs) %>%
pivot_longer(n_elect_vs:area_elect_vs, names_to = "index", values_to="electivity") %>%
mutate(metric=case_when(grepl("n_elect", index)~"Abundance-based",
grepl("area_elect", index)~"Area-based")) %>%
select(-index)
#creating preliminary figure
selectivity_combo_fig <- ggplot()+
geom_point(data=selectivity_raw, aes(y=region_short, x=electivity, color=region_short), alpha=0.5, position=position_jitter(height=0.1))+ #raw data points
geom_pointrange(data=combined_selectivity_summary, aes(y=region_short, x=mean_electivity, xmin=ci_lower, xmax=ci_upper, fill=region_short), color="black", pch=21, size=0.5)+ #mean and 95% CI
scale_x_discrete(limits = rev)+ #so regions are in same order as in previous figs
scale_colour_manual(values=region_palette)+
scale_fill_manual(values=region_palette)+
xlim(-1.1,1.1)+ #slightly larger than -1 and 1 so that jitter isn't out of bounds
geom_vline(xintercept=0,linetype=2)+ #dashed line at 0 (no electivity)
theme_bw()+
labs(x="V.S. relativized electivity (E*)", y="Region")+
facet_grid(metric~coral_species)+
coord_flip()+
theme(legend.position = "none")
#reading in coral genus icons
branching_porties_image <- magick::image_read(path=here("figures_tables/reef_images", "Branching_porties.png"), density = NULL, depth = NULL, strip = TRUE)
orbicella_image <- magick::image_read(path=here("figures_tables/reef_images", "Orbicella_annularis.png"), density = NULL, depth = NULL, strip = TRUE)
porites_astreoides_image <- magick::image_read(path=here("figures_tables/reef_images", "Porites_astreoides.png"), density = NULL, depth = NULL, strip = TRUE)
siderastrea_image <- magick::image_read(path=here("figures_tables/reef_images", "Siderastrea_siderea.png"), density = NULL, depth = NULL, strip = TRUE)
#adding coral images to figure (image placement is off in R, but good in ggsave generated png)
selectivity_combo_final <- cowplot::ggdraw() +
draw_plot(selectivity_combo_fig)+ #adds the plot (order matters to overlay the layers correctly)
draw_image(orbicella_image, x = -0.245, y = 0.377, scale=0.07)+
draw_image(branching_porties_image, x = -0.019, y = 0.375, scale=0.09)+
draw_image(porites_astreoides_image, x = 0.205, y = 0.38, scale=0.07)+
draw_image(siderastrea_image, x = 0.43, y = 0.38, scale=0.06)
selectivity_combo_final
#saving figure
ggsave(plot=selectivity_combo_final, filename=here("supplements/fig_s1_selectivity_by_species.png"), width = 215, height = 110, dpi = 600, units = "mm")
#scar density ~ corallivore density
site_level_scar_density_by_corallivore_density <- fish_corals_site_level %>%
ggplot()+
geom_smooth(aes(x=mean_density_major_corallivores, y=mean_scars_m2_coral, color=region),method="lm")+
geom_point(aes(x=mean_density_major_corallivores, y=mean_scars_m2_coral, color=region), alpha=0.7)+
scale_color_manual(values=region_palette)+
scale_y_continuous(trans = scales::log_trans(),
breaks= c(0.1, 1, 10, 100),
labels= c(0.1, 1, 10, 100))+
scale_x_continuous(expand = c(0.1, 0))+ #values near 0 cutoff, expands x-axis to resolve issue
labs(x=expression(paste("Major corallivore density (n 100 ", m^-2, ")")),
y=expression(paste("Scar density (n ", m^-2, " coral)")),
color="Region")  +
theme_bw()+
rremove("x.title") +
rremove("x.ticks") +
rremove("x.text")
#coral area grazed ~ corallivore density
site_level_coral_area_grazed_by_corallivore_density <- fish_corals_site_level %>%
ggplot()+
geom_smooth(aes(x=mean_density_major_corallivores, y=mean_pct_coral_grazed, color=region), method="lm")+
geom_point(aes(x=mean_density_major_corallivores, y=mean_pct_coral_grazed, color=region), alpha=0.7)+
scale_color_manual(values=region_palette)+
scale_y_continuous(trans = scales::log_trans(),
breaks= c(0.00025, 0.0025, 0.025, 0.25, 2.5, 0.25),
labels= c(0.00025, 0.0025, 0.025, 0.25, 2.5, 0.25))+
scale_x_continuous(expand = c(0.1, 0))+ #values near 0 cutoff, expands x-axis to resolve issue
labs(x=expression(paste("Major corallivore density (n 100 ", m^-2, ")")),
y=expression(paste("Coral area predated (%)")),
color="Region") +
theme_bw()
#scar density ~ coral cover
site_level_scar_density_by_coral_cover <- fish_corals_site_level %>%
ggplot()+
geom_smooth(aes(y=mean_scars_m2_coral, x=mean_pct_coral_cover, color=region), method="lm")+
geom_jitter(aes(y=mean_scars_m2_coral, x=mean_pct_coral_cover, color=region), alpha=0.7)+
scale_colour_manual(values=region_palette)+
scale_y_continuous(trans = scales::log_trans(),
breaks= c(0.1, 1, 10, 100),
labels= c(0.1, 1, 10, 100))+
labs(y=expression(paste("Scar density (n ", m^-2, " coral)")), x="Coral cover (%)", color="Region")+
theme_bw()+
theme(legend.position = "top")+
rremove("x.title") +
rremove("x.ticks") +
rremove("x.text")+
rremove("y.title") +
rremove("y.ticks") +
rremove("y.text")
#coral area grazed ~ coral cover
site_level_coral_area_grazed_by_coral_cover <- fish_corals_site_level %>%
ggplot()+
geom_smooth(aes(y=mean_pct_coral_grazed, x=mean_pct_coral_cover, color=region), method="lm")+
geom_jitter(aes(y=mean_pct_coral_grazed, x=mean_pct_coral_cover, color=region), alpha=0.7)+
scale_colour_manual(values=region_palette)+
scale_y_continuous(trans = scales::log_trans(),
breaks= c(0.00025, 0.0025, 0.025, 0.25, 2.5, 0.25),
labels= c(0.00025, 0.0025, 0.025, 0.25, 2.5, 0.25))+
labs(y="Coral area predated (%)", x="Coral cover (%)", color="Region")+
theme_bw()+
theme(legend.position = "top")+
rremove("y.title") +
rremove("y.ticks") +
rremove("y.text")
#a regular ggarrange plot with all four fig panels had weird spacing, this is a hacky get around for that
site_level_corallivory_patterns_ac <- ggpubr::ggarrange(site_level_scar_density_by_corallivore_density +
theme(plot.margin =unit(c(t = 5, r = 5, b = 5, l = 25), "pt"))+
rremove("legend"),
site_level_coral_area_grazed_by_corallivore_density+
theme(plot.margin =unit(c(t = 5, r = 5, b = 5, l = 25), "pt"),
axis.title.x = element_text(margin = margin(t = 2.5, r = 0, b = 0, l = 0)))+
rremove("legend"),
nrow=2,
ncol=1,
align="v",
labels=c("a", "c"),
heights=c(1, 1.15))
site_level_corallivory_patterns_bd <- ggpubr::ggarrange(site_level_scar_density_by_coral_cover+
theme(plot.margin =unit(c(t = 0, r = 5, b = 5, l = 25), "pt"))+
rremove("legend"),
site_level_coral_area_grazed_by_coral_cover+
theme(plot.margin =unit(c(t = 5, r = 5, b = 0, l = 25), "pt"),
axis.title.x = element_text(
margin = margin(t = 7.5, r = 0, b = 0, l = 0)))+
rremove("legend"),
nrow=2,
ncol=1,
align="v",
labels=c("b", "d"),
heights=c(1, 1.15))
site_level_corallivory_patterns_temp <- ggpubr::ggarrange(site_level_corallivory_patterns_ac,
site_level_corallivory_patterns_bd+
theme(plot.margin =unit(c(5, 5, 5, 5), "pt")),
widths=c(1.2, 1))
common_legend <- ggpubr::get_legend(site_level_scar_density_by_coral_cover) %>%
as_ggplot()
site_level_corallivory_patterns <- ggpubr::ggarrange(common_legend,
site_level_corallivory_patterns_temp,
nrow=2,
ncol=1,
heights = c(1,10))
site_level_corallivory_patterns
site_level_corallivory_patterns_with_images <- cowplot::ggdraw() +
draw_plot(site_level_corallivory_patterns)+
draw_image(major_corallivore_icon,  x = -0.38, y = -0.47, scale=0.08) + #adds the major pf icon
draw_image(coral_icon, x = 0.175, y = -0.47, scale=0.055)+ #adds the coral
draw_image(corallivory_icon,  x = -0.448, y = 0.379, scale=0.055) + #adds corallivory icon
draw_image(corallivory_icon,  x = -0.448, y = -0.05, scale=0.055) #adds corallivory icon
ggsave(plot=site_level_corallivory_patterns_with_images,
filename=here("figures_tables/fig4_corallivory_by_coral_and_fish.jpg"),
width = 215, height = 160, dpi = 600, units = "mm")
set.seed(1945) #for reproducible results from random simulations of residuals
#Random-slope and intercept model with interaction
scar_density_m1_randslope_interaction <- glmmTMB::glmmTMB(log(mean_scars_m2_coral) ~ mean_density_major_corallivores*mean_pct_coral_cover + (mean_density_major_corallivores + mean_pct_coral_cover | region), #transects nested within sites within regions
data = fish_corals_site_level,
family=gaussian)
#high correlation of random slopes, using random-intercept only model
scar_density_m1_randslope_interaction %>% summary()
#Random-intercept model with interaction
scar_density_m1_interaction <- glmmTMB::glmmTMB(log(mean_scars_m2_coral) ~ mean_density_major_corallivores*mean_pct_coral_cover +
(1 | region), #transects nested within sites within regions
data = fish_corals_site_level,
family=gaussian)
#interaction NS, dropping interaction term and rerunning model without
scar_density_m1_interaction %>% summary()
#Random-intercept model without interaction
scar_density_m1 <- glmmTMB::glmmTMB(log(mean_scars_m2_coral) ~ mean_density_major_corallivores+mean_pct_coral_cover +
(1 | region), #transects nested within sites within regions
data = fish_corals_site_level,
family=gaussian)
#evaluating model fit
scar_density_m1_residuals <- DHARMa::simulateResiduals(scar_density_m1, n = 10000, use.u = T)
DHARMa::testDispersion(scar_density_m1_residuals, plot=F) #no significant overdispersion
plot(scar_density_m1_residuals) #KS test significant
hist(fish_corals_site_level$mean_density_major_corallivores) #skewness may be influencing KS test significance
hist(sqrt(fish_corals_site_level$mean_density_major_corallivores)) #not perfect, but less skewness with sqrt transformation
#rerunning model with square-root tranformation of corallivore density to attempt to address KS test issues
scar_density_m2 <- glmmTMB::glmmTMB(log(mean_scars_m2_coral) ~ sqrt(mean_density_major_corallivores)*(mean_pct_coral_cover) +
(1 | region), #transects nested within sites within regions
data = fish_corals_site_level,
family=gaussian)
#evaluating model fit
scar_density_m2_residuals <- DHARMa::simulateResiduals(scar_density_m2, n = 10000, use.u = T)
DHARMa::testDispersion(scar_density_m2_residuals, plot=F) #no significant overdispersion
plot(scar_density_m2_residuals) #KS test no longer significant following transformation
#viewing model results
scar_density_m2 %>% summary()
#tidying model output and calculating confidence intervals
scar_density_m1_ci <- confint(scar_density_m1) %>%
as_tibble() %>%
select(-Estimate)
scar_density_model_output <- scar_density_m1 %>%
broom.mixed::tidy() %>%
filter(term != "sd__Observation") %>%
bind_cols(scar_density_m1_ci) %>%
filter(effect!="ran_pars") %>%
janitor::clean_names() %>%
rename(ci_2.5 = x2_5_percent, ci_97.5=x97_5_percent) %>%
mutate(estimate_backtransformed = case_when(term=="(Intercept)"~exp(estimate),
TRUE~as.double(100*(exp(estimate)-1)))) %>%
mutate(model="Scar density") %>%
select(model, term, statistic, p_value, estimate, ci_2.5, ci_97.5, estimate_backtransformed) %>%
mutate(across(where(is.double), ~round(.x, 3)))
scar_density_model_output
scar_density_m2
#evaluating model fit
scar_density_m2_residuals <- DHARMa::simulateResiduals(scar_density_m2, n = 10000, use.u = T)
DHARMa::testDispersion(scar_density_m2_residuals, plot=F) #no significant overdispersion
plot(scar_density_m2_residuals) #KS test no longer significant following transformation
if (!require(here)) install.packages("here")
if (!require(purrr)) install.packages("purrr")
if (!require(tidyverse)) install.packages("tidyverse")
packages <- c("here", "purrr", "tidyverse")
sapply(packages, require, character.only = T)
stx18_bon19 <- read_csv(here("data/stx18_bon19_fish_data.csv")) %>%
mutate(date=as.Date(date, "%m/%d/%y"))
fla13_pan13 <- read.csv(here("data/fla13_pan13_fish_data.csv"), fileEncoding = "UTF-8") %>% #so accents are read in correctly
mutate(date=as.Date(date))
checking_average_segment_length <- stx18_bon19 %>%
mutate(dist_m_rnd =round(dist_m, 0)) %>%
select(site, transect, min, dist_m_rnd) %>%
distinct() %>%
filter(dist_m_rnd >=15 & dist_m_rnd <=25)
hist(checking_average_segment_length$dist_m_rnd)
#subsetting data to only include surveys between 16 to 20m
fish_df_16_to_20 <- stx18_bon19 %>%
filter(dist_m >=16 & dist_m <=20) %>%
mutate(dist_m =round(dist_m, 0)) %>%
select(region, date, site, transect, species, stage, fl_cm, n_pf, dist_m, min, depth_m)
segment_filter_df <- fish_df_16_to_20 %>%
select(region, date, site, transect, min) %>%
distinct() %>%
mutate(segment_id=cumsum(distinct_segment= min != lag(min) + 1 | is.na(min != lag(min) + 1))) %>%
group_split(segment_id) %>%
map(~.x %>% mutate(row_num=row_number(), row_to_keep=row_num %%2==1)) %>%
bind_rows() %>%
select(-segment_id, -row_num)
fish_df_filtered <- fish_df_16_to_20 %>%
dplyr::left_join(segment_filter_df) %>%
filter(row_to_keep==TRUE)
fish_replicate_check <- fish_df_filtered %>%
select(region, date, site, transect, min, dist_m) %>%
distinct() %>%
group_by(region, site) %>%
dplyr::reframe(n=n())
stx_bon19_transect_temp <- fish_df_filtered %>%
select(region, site, date, transect_old=transect, min, dist_m, depth_m) %>%
distinct() %>%
group_by(region, site) %>%
mutate(transect=1:n())
stx_bon19_metadata <- stx_bon19_transect_temp %>%
mutate(survey_w_m=5) %>%
select(region, site, date, transect, depth_m, survey_l_m= dist_m, survey_w_m) %>%
mutate(depth_m=round(depth_m, 1)) %>%
distinct()
stx18_bon19_clean <- fish_df_filtered %>%
rename(transect_old=transect, number=n_pf, phase=stage, size_cm=fl_cm) %>%
dplyr::left_join(stx_bon19_transect_temp, by = c("region", "date", "site", "min", "transect_old", "depth_m")) %>%
select(region, site, date, transect, depth_m, species,phase, size_cm, number) %>%
mutate(depth_m=round(depth_m, 1),
size_cm=as.character(size_cm))
fish_survey_metadata <- fla13_pan13 %>%
mutate(survey_l_m=25, survey_w_m=4) %>%
select(region, site, date, transect, depth_m, survey_l_m, survey_w_m) %>%
distinct() %>%
bind_rows(stx_bon19_metadata)
merged_fish_surveys <- fla13_pan13 %>%
filter(number>0) %>% #filtering to only include observations with fish
uncount(number) %>%
bind_rows(stx18_bon19_clean) %>%
select(-number)%>%
mutate(count=1)
merged_fish_surveys <- fla13_pan13 %>%
filter(number>0) %>% #filtering to only include observations with fish
uncount(number) %>%
bind_rows(stx18_bon19_clean) %>%
select(-number)%>%
mutate(count=1)
merged_fish_surveys
stx18_bon19_clean
fla13_pan13
fla13_pan13 <- read.csv(here("data/fla13_pan13_fish_data.csv"), fileEncoding = "UTF-8") %>% #so accents are read in correctly
mutate(date=as.Date(date))
fla13_pan13
