---
title: "Data analysis: Ecological drivers of parrotfish coral predation vary across spatial scales"
author: "Hannah Rempel"
date: "Last updated 17/March/2024"
output:
  pdf_document: default
  word_document: default
  html_document: default
---

# ___________________________________________________________________________________

#Setup: reading in and summarizing data

```{r Setup, echo=FALSE, message=FALSE}
if (!require(broom.mixed)) install.packages("broom.mixed") 
if (!require(cowplot)) install.packages("cowplot") 
if (!require(DHARMa)) install.packages("DHARMa") 
if (!require(ggpp)) install.packages("ggpp") 
if (!require(ggpubr)) install.packages("ggpubr") 
if (!require(ggridges)) install.packages("ggridges") 
if (!require(glmmTMB)) install.packages("glmmTMB") 
if (!require(here)) install.packages("here") 
if (!require(janitor)) install.packages("janitor") 
if (!require(magick)) install.packages("magick") 
if (!require(tidyverse)) install.packages("tidyverse") 

packages <- c("broom.mixed", "cowplot", "DHARMa", "ggpp", "ggpubr", "ggridges", "glmmTMB", "here", "janitor", "magick", "tidyverse")
sapply(packages, require, character.only = T)
```

```{r Reading in data, message = FALSE}
fish_df <- read_csv(here("data/regional_fish_data.csv")) %>%
  mutate(region= factor(region, levels = c("Panamá", "Florida",  "St. Croix", "Bonaire"))) 

coral_scar_df <- read.csv(here("data/processed_coral_scar_data_colony_level.csv"), 
                          fileEncoding = "UTF-8") %>% #UTF-8 is compatible with accents/tildes
  mutate(region= factor(region, levels = c("Panamá", "Florida", "St. Croix", "Bonaire")))

site_coordinates <- read.csv(here("data/site_coordinates.csv"), 
                          fileEncoding = "UTF-8") %>%
  mutate(region= factor(region, levels = c("Panamá", "Florida", "St. Croix", "Bonaire")))
```

```{r Table S1: Site coordinates and sampling effort}
#summary of the number of transects and depth range by site
summarized_n_depth_fish_surveys <- fish_df  %>% 
  group_by(region, site, transect) %>% 
  distinct(depth_m) %>%
  rename(fish_survey_depth_m = depth_m) %>% 
  group_by(region, site) %>%
  dplyr::reframe(n_fish_surveys=n(),
                 min_fish_survey_depth_m = min(fish_survey_depth_m),
                 med_fish_survey_depth_m = round(median(fish_survey_depth_m), 1),
                 max_fish_survey_depth_m = max(fish_survey_depth_m))

#summary of the number of surveys and depth range by site
summarized_n_depth_coral_surveys <- coral_scar_df %>% 
  group_by(region, site, transect) %>% 
  distinct(depth_m) %>%
  rename(coral_survey_depth_m = depth_m) %>% 
  group_by(region, site) %>%
  dplyr::reframe(n_coral_surveys = n(),
                 min_coral_survey_depth_m = min(coral_survey_depth_m),
                 med_coral_survey_depth_m = round(median(coral_survey_depth_m), 1),
                 max_coral_survey_depth_m = max(coral_survey_depth_m))

#joining site-level sampling effort summary with site coordinates
table_s1 <- site_coordinates %>%
  left_join(summarized_n_depth_fish_surveys) %>% 
  left_join(summarized_n_depth_coral_surveys)

write.csv(table_s1, 
          here("figures_tables/supplements_tables/table_s1_site_coordinates_sample_size.csv"),  
          fileEncoding = "UTF-8", 
          row.names=FALSE)
```

```{r SEM function}
#function to calculate the standard error of the mean
sem <- function(x) {
  sd(x, na.rm=TRUE)/sqrt(sum(!is.na(x)))
}
```

## Summarising parrotfish density and biomass data

```{r Summary of parrotfish density and biomass by transect + site + region}
# transect-level summary of fish density and biomass
pf_density_biomass_transect <- fish_df %>% 
  mutate(survey_area_m2 = survey_l_m*survey_w_m) %>% 
  group_by(region, site, date, transect, depth_m, survey_l_m, survey_w_m, survey_area_m2) %>%
  dplyr::reframe(n_major_corallivores = sum(count), 
                 sum_corallivore_weight_g = sum(weight_g)) %>% 
  mutate(density_major_corallivores = n_major_corallivores/survey_area_m2*100, #fish density (n/100 m2) 
         biomass_major_corallivores = sum_corallivore_weight_g/survey_area_m2*100) #fish biomass (g/100 m2) 

# site-level summary of fish density amd biomass
pf_density_biomass_site <- pf_density_biomass_transect %>% 
  group_by(region, site) %>%
  dplyr::reframe(
    mean_pf_n_100m2=mean(density_major_corallivores),
    sem_pf_density = sem(density_major_corallivores),
    
    mean_pf_g_100m2=mean(biomass_major_corallivores),
    sem_pf_biomass = sem(biomass_major_corallivores)
    ) %>%
  ungroup()

# region-level summary of fish density and biomass
regional_parrotfish_density_biomass <- pf_density_biomass_site %>%
  group_by(region) %>%
   dplyr::reframe(
     mean_pf_density=mean(mean_pf_n_100m2),
     sem_pf_density=sem(mean_pf_n_100m2),
     
     mean_pf_biomass=mean(mean_pf_g_100m2),
     sem_pf_biomass=sem(mean_pf_g_100m2)
     )
```

## Summarising coral and scar data

```{r Summary of coral and scar data, echo=FALSE, message=FALSE}
# transect-level summary of coral data
coral_transect <- coral_scar_df %>% 
  mutate(proportion_grazed = total_grazed_cm2/col_area_cm2) %>%
  group_by(region, site, transect, depth_m) %>%
   dplyr::reframe(
     total_col_area_cm2 = sum(col_area_cm2),
     total_scar_area_cm2 = sum(total_grazed_cm2),
     total_n_scars = sum(n_new_scars),
     n_colonies = n()) %>%
  mutate(
    pct_coral_cover = (total_col_area_cm2/300000)*100, #divide by 300000 b/c coral transects were 30m2 (=300000cm2)
    scars_m2_coral = total_n_scars/(total_col_area_cm2/10000), #divide by 10000 to convert cm2 to m2
    pct_coral_grazed = (total_scar_area_cm2/total_col_area_cm2)*100) %>% #multiplying by 100 to convert to percent
  ungroup()

# site-level summary of coral data
coral_site <- coral_transect %>%
  group_by(region, site) %>%
   dplyr::reframe(
     mean_pct_coral_cover = mean(pct_coral_cover),
     sem_coral_cover = sem(pct_coral_cover),
    
     mean_pct_coral_grazed = mean(pct_coral_grazed),
     sem_pct_grazed = sem(pct_coral_grazed),
     
     mean_scars_m2_coral = mean(scars_m2_coral),
     sem_scar_density = sem(scars_m2_coral)
     ) %>%
  ungroup()

# region-level summary of coral data
regional_coral_scar_patterns <- coral_site %>%
  group_by(region) %>%
   dplyr::reframe(
     mean_coral_cover = mean(mean_pct_coral_cover),
     sem_cover = sem(mean_pct_coral_cover),
     
     mean_scar_density = mean(mean_scars_m2_coral),
     sem_density = sem(mean_scars_m2_coral),
     
     mean_coral_area_grazed = mean(mean_pct_coral_grazed),
     sem_area_grazed = sem(mean_pct_coral_grazed)
     )

# summary mean scar size for grazed colonies by region
mean_scar_size_by_region <- coral_scar_df %>% 
  filter(mean_scar_area_cm2>0) %>%
  group_by(region) %>%
  dplyr::reframe(
    mean_scar_size_cm2 = mean(mean_scar_area_cm2), 
    sem_scar_size = sem(mean_scar_area_cm2)
    ) 
```

```{r Merging site-level fish and coral data, message=FALSE}
fish_corals_site_level <- coral_site %>% 
  left_join(pf_density_biomass_site) %>%
  mutate(region= factor(region, levels = c("Panamá", "Florida",  "St. Croix", "Bonaire"))) 
```

All palettes have been checked in a colorblindness simulator ([link](https://davidmathlogic.com/colorblind/))
```{r Color palettes for figures, include=FALSE, echo=FALSE}
parrotfish_palette <- c("#6DF3DC", "#4BCAB0", "#0D8A87", "#014D4E")
parrotfish_size_palette <- c("#87F3CA", "#66D4D3", "#248EB5", "#4E0C9E", "#2F0248") 
coral_palette <- c("#EF977F", "#DA5849", "#C92741", "#9E1831")
region_palette <- c("#00B1EA", "#FE4248", "#8266FF", "#520E44") 
```

# ___________________________________________________________________________________

#Variation in corallivory intensity and coral selectivity among regions

##Summarizing and visualizing regional trends

```{r Table 1: Regional patterns in parrotfish density + coral cover + corallivory intensity}
regional_parrotfish_coral_scar_summary <- regional_parrotfish_density_biomass %>% 
  left_join(regional_coral_scar_patterns, by = join_by(region)) %>% 
  left_join(mean_scar_size_by_region, by = join_by(region)) %>%
  mutate_at(2:7, round, 1) %>% 
  mutate_at(8:11, round, 3) %>%
  select(
    region,
    mean_pf_density, sem_pf_density, 
    mean_pf_biomass, sem_pf_biomass, 
    mean_coral_cover, sem_cover,
    mean_scar_density, sem_density,
    mean_scar_size_cm2, sem_scar_size,
    mean_coral_area_grazed, sem_area_grazed)

write.csv(regional_parrotfish_coral_scar_summary, here("figures_tables/table1_regional_patterns.csv"),
          fileEncoding = "UTF-8", 
          row.names=FALSE)
```

Note: Figure 1 is a map, made in a separate script

```{r Fig. 2: parrotfish + coral + corallivory patterns across sites and regions, echo=FALSE, message=FALSE}
#Fig 2a) parrotfish density patterns
fig2a_parrotfish_density <- ggplot()+
  geom_point(data=pf_density_biomass_transect, aes(y=fct_rev(site), x=density_major_corallivores, color=region), alpha=0.5)+
  geom_pointrange(data=fish_corals_site_level,
                  aes(y = fct_rev(site),
                      x=mean_pf_n_100m2,
                      xmin=mean_pf_n_100m2 - sem_pf_density, 
                      xmax=mean_pf_n_100m2 + sem_pf_density,
                      fill=region),
                  color="black", pch=21, size=0.5)+
  scale_x_continuous(limits = c(0, 17), expand = c(0.025, 0)) + 
  scale_color_manual(values = parrotfish_palette) + 
  scale_fill_manual(values = parrotfish_palette) + 
  facet_grid(rows = vars(region), scales = "free_y", switch = "y", space = "free") +
  labs(title = "a",  x = expression(paste("Major corallivore density (n 100 ", m^-2, ")"))) +
  theme_bw()+
  theme(axis.title.x = element_text(margin = margin(t = 1.1, r = 0, b = 0, l = 0, unit = "mm")),
        plot.title = element_text(size = 12, face = "bold"),
        strip.text.y = element_text(angle = 270, face = "bold"),
        strip.placement = "outside",
        axis.title.y = element_blank(),
        strip.text = element_text(size = 10, margin = margin(t = 1.5, r = 1.5, b = 1.5, l = 1.5, unit = "mm")),
        axis.text = element_text(size = 10),
        legend.position = "none")

#Fig 2b) coral cover patterns
fig2b_coral_cover <- ggplot() +
  geom_point(data=coral_transect, aes(y=fct_rev(site), x=pct_coral_cover, color=region), alpha=0.5)+
  geom_pointrange(data=fish_corals_site_level,
                  aes(y = fct_rev(site),
                      x=mean_pct_coral_cover,
                      xmin=mean_pct_coral_cover - sem_coral_cover, 
                      xmax=mean_pct_coral_cover + sem_coral_cover,
                      fill=region),
                  color="black", pch=21, size=0.5)+
  scale_x_continuous(limits = c(0, 65), expand = c(0.025, 0)) +
  scale_fill_manual(values = coral_palette) + 
  scale_color_manual(values = coral_palette) +
  facet_grid(rows = vars(region), scales = "free_y", switch = "y", space = "free") +
  labs(title = "b", x = "Target coral cover (%)") +
  theme_bw()+
  theme(axis.title.x = element_text(margin = margin(t = 2.2, r = 0, b = 0.8, l = 0, unit = "mm")),
        plot.title = element_text(size = 12, face = "bold"),
        plot.margin = margin(0.2, 0.2, 0.2, 0.2, unit = "cm"),
        strip.background = element_blank(),
        strip.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.x = element_text(size = 10),
        legend.position = "none")

# Fig 2c) scar density patterns w/ log transformation 
# log transformed +0.1 to visualize patterns across regions better given extremely high corallivory intensity in Florida

fig2c_scar_density_transformed <- ggplot() +
  #transect-level data contain 0's. To visualize with a log-transformed scale, 0.1 is added
geom_point(data=coral_transect, aes(y=fct_rev(site), x=(scars_m2_coral+0.1), color=region), alpha=0.5)+
  #adding 0.1 to site means to transform in the same way as the transect-level data and b/c there are two sites w/ >0 but <1 densities and when the SEM is subtracted these values become negative. The transfomation sets the bounds of the SEM at 0 for visualization purposes.
 geom_pointrange(data=fish_corals_site_level,
                 aes(y = fct_rev(site),
                     x=(mean_scars_m2_coral+0.1),
                     xmin=(mean_scars_m2_coral+0.1)-sem_scar_density,
                     xmax=(mean_scars_m2_coral+0.1)+sem_scar_density,
                     fill=region),
                 color="black", pch=21, size=0.5)+
  scale_x_continuous(trans = scales::log_trans(),
                     breaks= c(0.1, 1, 5, 25, 100, 250),
                     labels= c("0", 1, 5, 25, 100, 250)
                     )+
  scale_fill_manual(values = coral_palette) + #specified hex codes for plot colors
  scale_color_manual(values = coral_palette) + #specified hex codes for plot colors
  facet_grid(rows = vars(region), scales = "free_y", switch = "y", space = "free") +
  labs(title = "c", x = expression(paste("Scar density (n ", m^-2, " coral)")))+
  theme_bw()+
  theme(axis.title.x = element_text(margin = margin(t = 1.1, r = 0, b = 0, l = 0, unit = "mm")),
        plot.title = element_text(size = 12, face = "bold"),
        strip.text.y = element_text(angle = 270, face = "bold"),
        strip.placement = "outside",
        axis.title.y = element_blank(),
        strip.text = element_text(size = 10, margin = margin(t = 1.5, r = 1.5, b = 1.5, l = 1.5, unit = "mm")),
        axis.text = element_text(size = 10),
        legend.position = "none")

#Fig 2d) percent coral grazed patterns
# log transformed +0.01 to visualize patterns across regions better given extremely high corallivory intensity in Florida
#used log +0.01 instead of 0.1 because the percent predated had a far smaller range of values (up to ~1.5%) compared to density (up to ~250)

fig2d_percent_scar_area_transformed <- ggplot() +
  geom_point(data=coral_transect, aes(y=fct_rev(site), x=(pct_coral_grazed+0.01), color=region), alpha=0.5)+
  geom_pointrange(data=fish_corals_site_level,
                  aes(y = fct_rev(site),
                      x=(mean_pct_coral_grazed+0.01),
                      xmin=(mean_pct_coral_grazed+0.01)-sem_pct_grazed, 
                      xmax=(mean_pct_coral_grazed+0.01)+sem_pct_grazed,
                      fill=region),
                  color="black", pch=21, size=0.5)+
  scale_x_continuous(trans = scales::log_trans(),
                     breaks= c(0.01, 0.05, 0.1, 0.25, 0.5, 1),
                     labels= c("0", 0.05, 0.1, 0.25, 0.5, 1)
                     )+
  scale_fill_manual(values = coral_palette) +
  scale_color_manual(values = coral_palette) + 
  facet_grid(rows = vars(region), scales = "free_y", switch = "y", space = "free") +
  labs(title = "d", x = "Coral area preyed upon (%)") +
  theme_bw()+
  theme(axis.title.x = element_text(margin = margin(t = 2.2, r = 0, b = 0.8, l = 0, unit = "mm")),
        plot.title = element_text(size = 12, face = "bold"),
        plot.margin = margin(0.2, 0.2, 0.2, 0.2, unit = "cm"),
        strip.background = element_blank(),
        strip.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.x = element_text(size = 10),
        legend.position = "none")

#reading in coral and parrotfish icon for figure graphics
coral_icon <- orbicella_image <- magick::image_read(path=here("figures_tables/reef_images", "Orbicella_annularis.png"), density = NULL, depth = NULL, strip = TRUE)

corallivory_icon <- orbicella_image <- magick::image_read(path=here("figures_tables/reef_images", "Orbicella_annularis_grazed.png"), density = NULL, depth = NULL, strip = TRUE)

major_corallivore_icon <- magick::image_read(path=here("figures_tables/reef_images", "Major_corallivores.png"), density = NULL, depth = NULL, strip = TRUE)

#Combining individual graph into one: top panel (a-b)
fig2a_b <- ggpubr::ggarrange(fig2a_parrotfish_density, fig2b_coral_cover,
                                                      ncol=2,
                                                      widths=c(1.48, 1), #so graph widths are same size
                                                      align = "h")

#adding parrotfish and coral graphics to base figure
fig2a_b_with_graphics <- cowplot::ggdraw() +
  draw_plot(fig2a_b)+ #adds the plot (order matters to overlay the layers correctly)
  draw_image(major_corallivore_icon,  x = 0.027, y = 0.379, scale=0.1) + #adds the major pf icon
  draw_image(coral_icon, x = 0.45, y = 0.379, scale=0.08) #adds the coral

#bottom panel (c-d)
fig2c_d <- ggpubr::ggarrange(fig2c_scar_density_transformed, 
                                            fig2d_percent_scar_area_transformed,
                                            ncol=2,
                                            widths=c(1.48, 1), #adjusting graph widths to be the same size
                                            align = "h")

#adding corallivory graphics to base figure
fig2c_d_with_graphics <- cowplot::ggdraw() +
  draw_plot(fig2c_d)+ #adds the plot (order matters to overlay the layers correctly)
  draw_image(corallivory_icon,  x = 0.05, y = 0.379, scale=0.08)+ #adds the coral
  draw_image(corallivory_icon,  x = 0.45, y = 0.379, scale=0.08) #adds the coral to e

#combining figure into a four panel plot
fig2_final <- ggpubr::ggarrange(fig2a_b_with_graphics, 
                                fig2c_d_with_graphics,
                                nrow=2,
                                align = "h")

fig2_final

#saving as .jpg version (for presentations) and .pdf version (for publications)
ggsave(plot=fig2_final, 
       filename=here("figures_tables/fig2_site_level_patterns.jpg"), 
       width = 215, height = 250, dpi = 600, units = "mm") 

ggsave(plot=fig2_final, 
       filename=here("figures_tables/fig2_site_level_patterns.pdf"), 
       width = 215, height = 250, dpi = 600, units = "mm") 
```

```{r Fig. S1: parrotfish biomass by site}
#creating base figure
figs1_pf_biomass_site <- ggplot()+
  geom_point(data=pf_density_biomass_transect, aes(y=fct_rev(site), x=biomass_major_corallivores, color=region), alpha=0.5)+
  geom_pointrange(data=fish_corals_site_level,
                  aes(y = fct_rev(site),
                      x=mean_pf_g_100m2,
                      xmin=mean_pf_g_100m2 - sem_pf_biomass, 
                      xmax=mean_pf_g_100m2 + sem_pf_biomass,
                      fill=region),
                  color="black", pch=21, size=0.5)+
  scale_x_continuous(limits = c(0, 6000), expand = c(0.025, 0)) + 
  scale_color_manual(values = parrotfish_palette) + 
  scale_fill_manual(values = parrotfish_palette) + 
  facet_grid(rows = vars(region), scales = "free_y", switch = "y", space = "free") +
  labs(title="b", x = expression(paste("Major corallivore biomass (g 100 ", m^-2, ")"))) +
  theme_bw()+
  theme(axis.title.x = element_text(margin = margin(t = 2.2, r = 0, b = 0.8, l = 0, unit = "mm")),
        plot.title = element_text(size = 12, face = "bold"),
        plot.margin = margin(0.2, 0.2, 0.2, 0.2, unit = "cm"),
        strip.background = element_blank(),
        strip.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.x = element_text(size = 10),
        legend.position = "none")

#bottom panel (c-d)
figs1_combo <- ggpubr::ggarrange(fig2a_parrotfish_density, figs1_pf_biomass_site, 
                                            ncol=2,
                                            widths=c(1.48, 1), #adjusting graph widths to be the same size
                                            align = "h")

ggsave(plot=figs1_combo, 
       filename=here("figures_tables/supplements_figs/fig_s1_parrotfish_biomass_by_site.jpg"), 
       width = 215, height = 130, dpi = 600, units = "mm") 
```

```{r Summary of parrotfish density by species and size bin}
# creating fish size bins for comparison across regions
binned_fish_sizes <- fish_df %>% 
  filter(species!="No major corallivores") %>% #removing transects with no parrotfishes observed
  mutate(size_cm_binned=case_when(size_cm_est >=15 & size_cm_est <20 ~ "15 to 20",
                           size_cm_est >=20 & size_cm_est <25 ~ "20 to 25",
                           size_cm_est >=25 & size_cm_est <30 ~ "25 to 30",
                           size_cm_est >=30 & size_cm_est <35 ~ "30 to 35",
                           size_cm_est >=35 & size_cm_est <40 ~ "35 to 40"),
         size_cm_binned= factor(size_cm_binned, levels = c("15 to 20", "20 to 25", "25 to 30", "30 to 35", "35 to 40"))) 

# transect-level summary of parrotfish abundance by species and size bin
pf_by_size_species_df_temp <- binned_fish_sizes %>% 
  group_by(region, site, date, transect, depth_m, species, size_cm_binned) %>%
  dplyr::reframe(n = n()) #doesn't include 0's (no observations of pf of a given size class and species)

# empty data frame of all possible combinations of transect, species, and size classes
pf_by_size_species_df_empty <- fish_df %>% 
  mutate(survey_area_m2=survey_l_m*survey_w_m) %>% 
  select(region, site, date, transect, depth_m, survey_area_m2) %>%
  distinct() %>% #filtering distinct transect metadata
  tidyr::crossing(species=c("Scarus taeniopterus", "Scarus vetula", "Sparisoma viride"), 
                  size_cm_binned=c("15 to 20", "20 to 25", "25 to 30", "30 to 35", "35 to 40"))

#checking that df contains all possible combos
nrow(pf_by_size_species_df_empty)==276*15

# transect-level summary of fish density by species and size bin
pf_by_transect_size_species_df <- pf_by_size_species_df_empty %>%
  left_join(pf_by_size_species_df_temp) %>% #adding in all observations of species abundance by size bins
  mutate(n=replace_na(n, 0)) #adding 0s for instances where a given species and size was not observed in a transect 

# site-level summary of fish density by species and size bin
pf_by_site_size_species_df <- pf_by_transect_size_species_df %>% 
  dplyr::mutate(pf_density_100m2 = n/survey_area_m2*100) %>% #summarizing density (n/100 m2) 
  group_by(region, site, species, size_cm_binned) %>%
  dplyr::reframe(mean_pf_density_100m2=mean(pf_density_100m2)) %>%
  ungroup()

# region-level summary of fish density by species and size bin
pf_by_region_size_species_df <- pf_by_transect_size_species_df %>% 
  dplyr::mutate(pf_density_100m2 = n/survey_area_m2*100) %>% #summarizing density (n/100 m2) 
  group_by(region, species, size_cm_binned) %>%
  dplyr::reframe(mean_pf_density_100m2=mean(pf_density_100m2)) %>%
  ungroup()

pf_by_size_species_df_empty %>% 
  select(region, site, transect) %>% 
  distinct() %>%
  group_by(region)%>%
  reframe(n=n())
```

```{r Fig. S2: parrotfish density by size range and site}
fig_pf_by_site_size_species <- pf_by_site_size_species_df %>% 
  ggplot()+
  geom_bar(aes(x=mean_pf_density_100m2, y=fct_rev(site), fill=fct_rev(size_cm_binned)), position="stack", stat="identity")+
  facet_grid(rows = vars(region), cols=vars(species), scales = "free_y", switch = "y", space = "free") +
  labs(x= expression(paste("Fish density (n 100 ", m^-2, ")")), fill="Size (cm)", y="") +
  theme_bw()+
  scale_fill_manual(values = rev(parrotfish_size_palette)) +
  scale_x_continuous(limits = c(0, 5), expand = c(0.025, 0)) + #removing extra white space on left
  guides(fill=guide_legend(reverse=TRUE))+
  theme(axis.title.x = element_text(margin = margin(t = 1.1, r = 0, b = 0, l = 0, unit = "mm")),
        plot.title = element_text(size = 12, face = "bold"),
        strip.text.y = element_text(angle = 270, face = "bold"),
        strip.placement = "outside",
        axis.title.y = element_blank(),
        strip.text = element_text(size = 10, margin = margin(t = 1.5, r = 1.5, b = 1.5, l = 1.5, unit = "mm")),
        axis.text = element_text(size = 10),
        legend.position = "top")

sc_taeniopterus_icon <- magick::image_read(path=here("figures_tables/reef_images", "Scarus_taeniopterus.png"), density = NULL, depth = NULL, strip = TRUE)
sc_vetula_icon <- magick::image_read(path=here("figures_tables/reef_images", "Scarus_vetula.png"), density = NULL, depth = NULL, strip = TRUE)
sp_viride_icon <- magick::image_read(path=here("figures_tables/reef_images", "Sparisoma_viride.png"), density = NULL, depth = NULL, strip = TRUE)

#adding parrotfish graphics to figure
figs2_pf_size_dist_by_site <- cowplot::ggdraw() +
  draw_plot(fig_pf_by_site_size_species)+ 
  draw_image(sc_taeniopterus_icon,  x = -0.09, y = 0.362, scale=0.102)+ 
  draw_image(sc_vetula_icon,  x = 0.172, y = 0.362, scale=0.1)+ 
  draw_image(sp_viride_icon,  x = 0.432, y = 0.362, scale=0.105) 

ggsave(plot=figs2_pf_size_dist_by_site, 
       filename=here("figures_tables/supplements_figs/fig_s2_parrotfish_density_by_size_site.jpg"), 
       width = 215, height = 200, dpi = 600, units = "mm") 
```

```{r Summary of scar density and area grazed by genus}
# summarizing coral density and cover by transect for predated coral genera
coral_genus_count_and_area_by_transect <- coral_scar_df %>% 
  mutate(coral_genus=gsub("\\s.*", "", coral_species),
         coral_genus=case_when(coral_genus=="Branching"~"Porites",
                               TRUE~as.character(coral_genus))) %>%
  group_by(region, site, transect, coral_genus) %>%
  dplyr::reframe(n_colonies_per_30m2=n(), total_coral_area_m2=sum(col_area_cm2)/10000) %>%
  mutate(percent_coral_cover=total_coral_area_m2/30*100)

# summarizing n transects per region
transects_per_region <- coral_scar_df %>%
  group_by(region) %>%
  dplyr::reframe(n_transects_per_region=n_distinct(site, transect))
         
# creating df with all unique combos of region, site, transect, and coral genus (to account for 0's later)
regions_sites_transects_combos <- coral_genus_count_and_area_by_transect %>% 
  left_join(transects_per_region) %>%
  mutate(region_short=case_when(region=="Panamá"~"PAN",
                                region=="St. Croix"~"STX",
                                region=="Florida"~"FLA",
                                region=="Bonaire"~"BON",
                                TRUE~as.character(region)),
           region_short=factor(region_short, levels = c("PAN", "FLA", "STX", "BON"))) %>%
  distinct(region, region_short, site, n_transects_per_region, transect)

coral_genera_list <- coral_genus_count_and_area_by_transect %>% distinct(coral_genus)

unique_combos_coral_site_transect <- tidyr::crossing(regions_sites_transects_combos, coral_genera_list)

#joining coral counts/areas w/ unique combos df, then adding zeros for instances where a coral genera was not observed in a transect
coral_genus_count_and_area_with_zeros <- unique_combos_coral_site_transect %>% 
  left_join(coral_genus_count_and_area_by_transect) %>%
  mutate_at(c("n_colonies_per_30m2","total_coral_area_m2", "percent_coral_cover"), ~replace_na(.,0))
  
#summary of scar density and area per transect by coral genera
coral_scar_count_and_area_by_transect_temp <- coral_scar_df %>% 
  mutate(coral_genus=gsub("\\s.*", "", coral_species),
         coral_genus=case_when(coral_genus=="Branching"~"Porites",
                               TRUE~as.character(coral_genus))) %>%
  group_by(region, site, transect, coral_genus) %>%
  filter(n_new_scars>0) %>%
  dplyr::reframe(n_predated_colonies=n(), n_total_scars=sum(n_new_scars), total_scar_area_m2=sum(total_grazed_cm2)/10000) 

coral_scar_count_and_area_by_transect <- coral_genus_count_and_area_with_zeros %>% 
  left_join(coral_scar_count_and_area_by_transect_temp) %>%
  mutate(percent_coral_area_grazed=total_scar_area_m2/total_coral_area_m2*100,
         scars_per_m2_coral=n_total_scars/total_coral_area_m2) %>%
  mutate_at(c("n_predated_colonies","n_total_scars", "total_scar_area_m2", "percent_coral_area_grazed", "scars_per_m2_coral"), ~replace_na(.,0))
```

Boxplots of coral and scar density by coral genera showing the median, interquartile range (IQR), and whiskers extending to values up to 1.5 times the IQR, with raw data displayed as individual points in the background. 
```{r Fig. S3: Density of corals and predation scars by coral genus, fig.height = 4.33, fig.width = 8.46}
#creating preliminary figure
##fig s3a: coral density per m2 coral
fig_corals_per_m2_reef <- ggplot()+
  geom_point(data=coral_scar_count_and_area_by_transect, 
             aes(y=region_short, x=n_colonies_per_30m2, color=region_short), 
             alpha=0.5, position=position_jitter(height=0.25, width=0))+  #raw data, adj. jitter height not width bc coord flip
    geom_boxplot(data=coral_scar_count_and_area_by_transect, 
                 aes(y=region_short, x=n_colonies_per_30m2, fill=region_short), 
                 alpha=0.5, color="black", pch=21, size=0.5,outlier.shape = NA)+ 
    #removed outlier points from boxplot in line above bc raw data points are plotted and they overlap
  scale_colour_manual(values=region_palette)+
  scale_fill_manual(values=region_palette)+
  theme_bw()+
  labs(x=expression(paste("Corals per m" ^2, " reef")), y="Region")+
  facet_grid(~coral_genus)+
  coord_flip()+
  theme(legend.position = "none")

##fig s3b: scar density per m2 coral
fig_scars_per_m2_coral <- ggplot()+
  geom_point(data=coral_scar_count_and_area_by_transect, 
             aes(y=region_short, x=scars_per_m2_coral, color=region_short), 
             alpha=0.5, position=position_jitter(height=0.25))+  #raw data, adj. jitter height not width bc coord flip
    geom_boxplot(data=coral_scar_count_and_area_by_transect, 
                 aes(y=region_short, x=scars_per_m2_coral, fill=region_short), 
                 alpha=0.5, color="black", pch=21, size=0.5,outlier.shape = NA)+ 
    #removed outlier points from boxplot in line above bc raw data points are plotted and they overlap
  scale_colour_manual(values=region_palette)+
  scale_fill_manual(values=region_palette)+
  theme_bw()+
  labs(x=expression(paste("Scars per m" ^2, " coral       ")), y="Region")+ #spacing after coral intentional
  facet_grid(~coral_genus)+
  coord_flip()+
  theme(legend.position = "none")

#Making a combo figure
##removing redundant x-axis title from top figure before combing figures
fig_coral_density <-fig_corals_per_m2_reef  +
  theme(strip.text.x = element_text( margin=margin(0.25,0,1,0, "cm")),
        strip.text.y = element_text(angle = 0, hjust = 0),
        axis.title.x=element_blank(),
        axis.ticks.x=element_blank())
    
##removing redundant facet ribbon from bottom figure before combing figures
fig_scar_density <- fig_scars_per_m2_coral+
  theme(strip.background = element_blank(),
        strip.text.x = element_blank())

##combining coral density and scar density figures into one plot
fig_coral_scar_density_combo <- ggpubr::ggarrange(fig_coral_density, fig_scar_density,
                          align = c("v"),
                          labels=c("a", "b"),
                          heights = c(1.2, 1), #so graphs are same height despite ribbon on top panel
                          nrow=2, ncol=1)

#Adding coral icons to figure

##reading in coral genus icons to add to figure
agaricia_image <- magick::image_read(path=here("figures_tables/reef_images", "Agaricia_tenuifolia.png"), 
                                     density = NULL, depth = NULL, strip = TRUE)
madracis_image <- magick::image_read(path=here("figures_tables/reef_images", "Madracis_decactis.png"), 
                                     density = NULL, depth = NULL, strip = TRUE)
orbicella_image <- magick::image_read(path=here("figures_tables/reef_images", "Orbicella_annularis.png"), 
                                      density = NULL, depth = NULL, strip = TRUE)
porites_image <- magick::image_read(path=here("figures_tables/reef_images", "Porites_astreoides.png"), 
                                    density = NULL, depth = NULL, strip = TRUE)
siderastrea_image <- magick::image_read(path=here("figures_tables/reef_images", "Siderastrea_siderea.png"), 
                                        density = NULL, depth = NULL, strip = TRUE)
stephanocinea_image <- magick::image_read(path=here("figures_tables/reef_images", "Stephanocoenia_intersepta.png"), 
                                          density = NULL, depth = NULL, strip = TRUE)

##adding icons to figure (icon placement can look off in the markdown chunk output, look at the saved figure not chunk output)
fig_coral_scar_density_final <- cowplot::ggdraw() +
  draw_plot(fig_coral_scar_density_combo)+
  draw_image(agaricia_image, x = -0.345, y = 0.385, scale=0.11)+
  draw_image(madracis_image, x = -0.19, y = 0.385, scale=0.082)+
  draw_image(orbicella_image, x = -0.04, y = 0.385, scale=0.064)+
  draw_image(porites_image, x = 0.11, y = 0.385, scale=0.059)+
  draw_image(siderastrea_image, x = 0.265, y = 0.385, scale=0.049)+
  draw_image(stephanocinea_image, x = 0.415, y = 0.385, scale=0.059)

#saving figure
ggsave(plot=fig_coral_scar_density_final, filename=here("figures_tables/supplements_figs/figs3_coral_scar_density.jpg"), width = 215, height = 110, dpi = 600, units = "mm")
```

Boxplots of percent cover of corals (relative to reef area) and predation scars (relative to coral area) showing the median, interquartile range (IQR), and whiskers extending to values up to 1.5 times the IQR, with raw data displayed as individual points in the background. 
```{r Fig. S4: Percent cover of corals and predation scars, fig.height = 4.33, fig.width = 8.46}
## fig s4a: coral cover by genera and region
fig_coral_cover <- ggplot()+
  geom_point(data=coral_scar_count_and_area_by_transect, 
             aes(y=region_short, x=percent_coral_cover, color=region_short), 
             alpha=0.5, position=position_jitter(height=0.25, width=0))+ #raw data, adj. jitter height not width bc coord flip
    geom_boxplot(data=coral_scar_count_and_area_by_transect, 
                 aes(y=region_short, x=percent_coral_cover, fill=region_short), 
                 alpha=0.5, color="black", pch=21, size=0.5, outlier.shape = NA)+ 
  #removed outlier points from boxplot in line above bc raw data points are plotted and they overlap
  scale_colour_manual(values=region_palette)+
  scale_fill_manual(values=region_palette)+
  theme_bw()+
  labs(x=expression(paste("Coral cover (%)"), y="Region"))+
  facet_grid(~coral_genus)+
  coord_flip()+
  theme(legend.position = "none")

## fig b: scar area by genera and region
fig_pct_coral_predated <- ggplot()+
  geom_point(data=coral_scar_count_and_area_by_transect, 
             aes(y=region_short, x=percent_coral_area_grazed, color=region_short), 
             alpha=0.5, position=position_jitter(height=0.25))+ #raw data, adj. jitter height not width bc coord flip
    geom_boxplot(data=coral_scar_count_and_area_by_transect, 
                 aes(y=region_short, x=percent_coral_area_grazed, fill=region_short), 
                 alpha=0.5, color="black", pch=21, size=0.5,outlier.shape = NA)+ 
    #removed outlier points from boxplot in line above bc raw data points are plotted and they overlap
  scale_colour_manual(values=region_palette)+
  scale_fill_manual(values=region_palette)+
  theme_bw()+
  labs(x="Area preyed upon (%)         ", y="Region")+ #spacing after (%) intentional. hacky, but it works.
  facet_grid(~coral_genus)+
  coord_flip()+
  theme(legend.position = "none")

# making a combo figure
## removing redundant x-axis title from top figure before combing figures
fig_relative_coral_area_grazed_a <-fig_coral_cover  +
  theme(strip.text.x = element_text( margin=margin(0.25,0,1,0, "cm")),
        strip.text.y = element_text(angle = 0, hjust = 0),
        axis.title.x=element_blank(),
        axis.ticks.x=element_blank())

## removing redundant facet ribbon from bottom figure before combing figures
fig_relative_coral_area_grazed_b <- fig_pct_coral_predated+
  theme(strip.background = element_blank(),
        strip.text.x = element_blank())

## combining coral cover and percent area grazed in one plot
fig_relative_coral_area_grazed_combo <- ggpubr::ggarrange(fig_relative_coral_area_grazed_a, 
                                                          fig_relative_coral_area_grazed_b,
                          align = c("v"),
                          labels=c("a", "b"),
                          heights = c(1.2, 1), #so graphs are same height despite ribbon on top panel
                          nrow=2, ncol=1)
           
# adding coral icons to figure
## adding icons to figure (from images read in above, in prior chunk)
fig_relative_coral_area_grazed_final <- cowplot::ggdraw() +
  draw_plot(fig_relative_coral_area_grazed_combo)+ 
  draw_image(agaricia_image, x = -0.36, y = 0.385, scale=0.11)+
  draw_image(madracis_image, x = -0.21, y = 0.385, scale=0.082)+
  draw_image(orbicella_image, x = -0.05, y = 0.385, scale=0.064)+
  draw_image(porites_image, x = 0.105, y = 0.385, scale=0.059)+
  draw_image(siderastrea_image, x = 0.264, y = 0.385, scale=0.049)+
  draw_image(stephanocinea_image, x = 0.417, y = 0.385, scale=0.059)
fig_relative_coral_area_grazed_final

# saving figure
ggsave(plot=fig_relative_coral_area_grazed_final, filename=here("figures_tables/supplements_figs/figs4_coral_area_grazed.jpg"), width = 215, height = 110, dpi = 600, units = "mm")
```


##Analysis of regional trends

Analyzing regional variance in mean density (n/100m2) and biomass (g/100m2) of major corallivorous parrotfishes, coral cover (%) for species targeted by parrotfishes, predation scar density (n/m2 coral), and coral area preyed upon (%). First tested ANOVA model assumptions. When data violated ANOVA assumptions, we conducted non-parametric Kruskal-Wallis tests, with post-hoc Dunn’s tests of pairwise comparisons among regions using the Benjamini-Hochberg correction for multiple comparisons.

```{r KW test of parrotfish density by region}
model_pf_density <- aov(mean_pf_n_100m2 ~ region, data = fish_corals_site_level)

# testing model assumptions: violations of normality assumption for overall model
rstatix::shapiro_test(residuals(model_pf_density))

# testing model assumptions: violations of normality assumption by region for Panamá
fish_corals_site_level %>% group_by(region) %>% rstatix::shapiro_test(mean_pf_n_100m2)

# testing model assumptions: outliers by region via IQR method (Punta STRI in Panamá and BIRNM Lagoon in St. Croix are outliers)
fish_corals_site_level %>% group_by(region) %>% rstatix::identify_outliers(mean_pf_n_100m2)

# testing model assumptions: no evidence of significant violations of homogeneity of variance
fish_corals_site_level %>% rstatix::levene_test(mean_pf_n_100m2 ~ region) 

# Kruskal-Wallis test & post hoc Dunn test
kruskal.test(mean_pf_n_100m2 ~ region, data=fish_corals_site_level)
fish_corals_site_level %>% rstatix::dunn_test(mean_pf_n_100m2 ~ region, p.adjust.method = "BH", detailed = FALSE) #post hoc test
```

```{r KW test of parrotfish biomass by region}
model_pf_biomass <- aov(mean_pf_g_100m2 ~ region, data = fish_corals_site_level)

# testing model assumptions: violations of normality assumption for overall model
rstatix::shapiro_test(residuals(model_pf_biomass))

# testing model assumptions: significant violations of normality assumption by region for Panamá and St. Croix
fish_corals_site_level %>% group_by(region) %>% rstatix::shapiro_test(mean_pf_g_100m2)

# yesting model assumptions: outliers by region via IQR method (Punta STRI in Panamá and BIRNM Lagoon in St. Croix are outliers)
fish_corals_site_level %>% group_by(region) %>% rstatix::identify_outliers(mean_pf_g_100m2)

# testing model assumptions: no evidence of significant violations of homogeneity of variance
fish_corals_site_level %>% rstatix::levene_test(mean_pf_g_100m2 ~ region) 

# Kruskal-Wallis test & post hoc Dunn test
kruskal.test(mean_pf_g_100m2 ~ region, data=fish_corals_site_level) #sig differences by region
fish_corals_site_level %>% rstatix::dunn_test(mean_pf_g_100m2 ~ region, p.adjust.method = "BH", detailed = FALSE) 
```

```{r KW test of coral cover by region}
model_pct_coral_cover <- aov(mean_pct_coral_cover ~ region, data = fish_corals_site_level)

# testing model assumptions: no evidence of violations of normality assumption for overall model
rstatix::shapiro_test(residuals(model_pct_coral_cover))

# testing model assumptions: significant violations of normality assumption by region for Florida
fish_corals_site_level %>% group_by(region) %>% rstatix::shapiro_test(mean_pct_coral_cover)

# testing model assumptions: outliers by region via IQR method (French Reef in Florida is outlier)
fish_corals_site_level %>% group_by(region) %>% rstatix::identify_outliers(mean_pct_coral_cover)

# tTesting model assumptions: significant violations of homogeneity of variance
fish_corals_site_level %>% rstatix::levene_test(mean_pct_coral_cover ~ region) 

# Kruskal-Wallis test & post hoc Dunn test
kruskal.test(mean_pct_coral_cover ~ region, data=fish_corals_site_level) #sig differences by region
fish_corals_site_level %>%  rstatix::dunn_test(mean_pct_coral_cover ~ region, p.adjust.method = "BH", detailed = FALSE) 
```

```{r ANOVA of scar density by region}
model_scar_density_region <- aov(log(mean_scars_m2_coral) ~ region, data = fish_corals_site_level)

# testing model assumptions: no evidence of violations of normality assumption for overall model
rstatix::shapiro_test(residuals(model_scar_density_region))

# testing model assumptions: no evidence of violations of normality assumption by region
fish_corals_site_level %>% group_by(region) %>% mutate(ln_mean_scars_m2_coral=log(mean_scars_m2_coral)) %>%
  rstatix::shapiro_test(ln_mean_scars_m2_coral)

# testing model assumptions: no outliers by region via IQR method
fish_corals_site_level %>% group_by(region) %>% mutate(ln_mean_scars_m2_coral=log(mean_scars_m2_coral)) %>%
  rstatix::identify_outliers(ln_mean_scars_m2_coral)

# testing model assumptions: no significant violations of homogeneity of variance
fish_corals_site_level %>% rstatix::levene_test(log(mean_scars_m2_coral) ~ region) 

# visual assesment of model residuals
plot(model_scar_density_region)

# ANOVA model summary
summary(model_scar_density_region)
TukeyHSD(model_scar_density_region) #post hoc comparison
```

```{r KW test of percent area grazed by region}
model_pct_grazed_region <- aov(log(mean_pct_coral_grazed) ~ region, data = fish_corals_site_level)

# testing model assumptions: violations of normality for overall model
rstatix::shapiro_test(residuals(model_pct_grazed_region))

# testing model assumptions: violations of normality by region (St. Croix)
fish_corals_site_level %>% group_by(region) %>% mutate(ln_mean_pct_coral_grazed=log(mean_pct_coral_grazed)) %>%
  rstatix::shapiro_test(ln_mean_pct_coral_grazed)

# testing model assumptions: outliers by region via IQR method (Teague Bay in St. Croix is outlier)
fish_corals_site_level %>% group_by(region) %>% mutate(ln_mean_pct_coral_grazed=log(mean_pct_coral_grazed)) %>%
  rstatix::identify_outliers(ln_mean_pct_coral_grazed)

# testing model assumptions: no significant violations of homogeneity of variance
fish_corals_site_level %>% rstatix::levene_test(log(mean_pct_coral_grazed) ~ region) 

# Kruskal-Wallis test & post hoc Dunn test
kruskal.test(log(mean_pct_coral_grazed) ~ region, data = fish_corals_site_level) #sig differences by region
fish_corals_site_level %>% mutate(ln_mean_pct_coral_grazed=log(mean_pct_coral_grazed)) %>% 
  rstatix::dunn_test(ln_mean_pct_coral_grazed ~ region, p.adjust.method = "BH", detailed = FALSE) 
```

# ___________________________________________________________________________________

#Variation in corallivory intensity within and among reefs

##Visualizing patterns across reefs

```{r Fig. 3: Corallivory intensity by parrotfish density and coral cover, message=FALSE, echo=FALSE}
# scar density ~ corallivore density
site_level_scar_density_by_corallivore_density <- fish_corals_site_level %>%
  ggplot()+
  geom_smooth(aes(x=mean_pf_n_100m2, y=mean_scars_m2_coral, color=region),method="lm")+
  geom_point(aes(x=mean_pf_n_100m2, y=mean_scars_m2_coral, color=region), alpha=0.7)+
  scale_color_manual(values=region_palette)+
  scale_y_continuous(trans = scales::log_trans(),
                     breaks= c(0.05, 0.5, 5, 50, 500),
                     labels= c(0.05, 0.5, 5, 50, 500),
                     limits=c(0.04, 700))+
  scale_x_continuous(expand = c(0.025, 0))+ #values near 0 cutoff, expands x-axis to resolve issue
  labs(x=expression(paste("Major corallivore density (n 100 ", m^-2, ")")), 
       y=expression(paste("Scar density (n ", m^-2, " coral)")), 
       color="Region")  +
  theme_bw()+
  rremove("x.title") + 
  rremove("x.ticks") + 
  rremove("x.text")

# coral area grazed ~ corallivore density
site_level_coral_area_grazed_by_corallivore_density <- fish_corals_site_level %>%
  ggplot()+
  geom_smooth(aes(x=mean_pf_n_100m2, y=mean_pct_coral_grazed, color=region), method="lm")+
  geom_point(aes(x=mean_pf_n_100m2, y=mean_pct_coral_grazed, color=region), alpha=0.7)+
  scale_color_manual(values=region_palette)+
  scale_y_continuous(trans = scales::log_trans(),
                     breaks= c(0.00025, 0.0025, 0.025, 0.25, 2.5),
                     labels= c("0.00025", 0.0025, 0.025, 0.25, 2.5),
                     limits = c(0.00007,3))+
  scale_x_continuous(expand = c(0.025, 0))+ #values near 0 cutoff, expands x-axis to resolve issue
  labs(x=expression(paste("Major corallivore density (n 100 ", m^-2, ")")), 
       y=expression(paste("Coral area preyed upon (%)")), 
       color="Region") +
  theme_bw()

# scar density ~ coral cover
site_level_scar_density_by_coral_cover <- fish_corals_site_level %>%
  ggplot()+
  geom_smooth(aes(y=mean_scars_m2_coral, x=mean_pct_coral_cover, color=region), method="lm")+
  geom_jitter(aes(y=mean_scars_m2_coral, x=mean_pct_coral_cover, color=region), alpha=0.7)+
  scale_colour_manual(values=region_palette)+
  scale_y_continuous(trans = scales::log_trans(),
                     breaks= c(0.05, 0.5, 5, 50, 500),
                     labels= c(0.05, 0.5, 5, 50, 500),
                     limits=c(0.04, 700))+
  scale_x_continuous(expand = c(0.05, 0))+ #values near 0 cutoff, expands x-axis to resolve issue
  labs(y=expression(paste("Scar density (n ", m^-2, " coral)")), x="Coral cover (%)", color="Region")+
  theme_bw()+
  theme(legend.position = "top")+ 
  rremove("x.title") + 
  rremove("x.ticks") + 
  rremove("x.text")+
  rremove("y.title") + 
  rremove("y.ticks") + 
  rremove("y.text")

# coral area grazed ~ coral cover
site_level_coral_area_grazed_by_coral_cover <- fish_corals_site_level %>%
  ggplot()+
  geom_smooth(aes(y=mean_pct_coral_grazed, x=mean_pct_coral_cover, color=region), method="lm")+
  geom_jitter(aes(y=mean_pct_coral_grazed, x=mean_pct_coral_cover, color=region), alpha=0.7)+
  scale_colour_manual(values=region_palette)+
  scale_y_continuous(trans = scales::log_trans(),
                     breaks= c(0.00025, 0.0025, 0.025, 0.25, 2.5),
                     labels= c("0.00025", 0.0025, 0.025, 0.25, 2.5),
                     limits = c(0.00007,3))+
  scale_x_continuous(expand = c(0.05, 0))+ #values near 0 cutoff, expands x-axis to resolve issue
  labs(y="Coral area preyed upon (%)", x="Coral cover (%)", color="Region")+
  theme_bw()+
  theme(legend.position = "top")+
  rremove("y.title") +  
  rremove("y.ticks") + 
  rremove("y.text")
  
# making four panel plot in two parts to overcome weird spacing issues when making a four panel plot directly
site_level_corallivory_patterns_ac <- ggpubr::ggarrange(site_level_scar_density_by_corallivore_density + 
                                                          theme(plot.margin =unit(c(t = 5, r = 5, b = 5, l = 25), "pt"))+
                                                          rremove("legend"),
                                                        site_level_coral_area_grazed_by_corallivore_density+
                                                          theme(plot.margin =unit(c(t = 5, r = 5, b = 5, l = 25), "pt"),
                                                                axis.title.x = element_text(margin = margin(t = 2.5, r = 0, b = 0, l = 0)))+
                                                          rremove("legend"), labels=c("a", "c"),
                                                         nrow=2, ncol=1, align="v", heights=c(1, 1.15))

site_level_corallivory_patterns_bd <- ggpubr::ggarrange(site_level_scar_density_by_coral_cover+ 
                                                          theme(plot.margin =unit(c(t = 0, r = 5, b = 5, l = 25), "pt"))+
                                                          rremove("legend"),
                                                     site_level_coral_area_grazed_by_coral_cover+
                                                          theme(plot.margin =unit(c(t = 5, r = 5, b = 0, l = 25), "pt"),
                                                                axis.title.x = element_text(
                                                                   margin = margin(t = 7.5, r = 0, b = 0, l = 0)))+
                                                       rremove("legend"), labels=c("b", "d"),
                                                     nrow=2, ncol=1, align="v", heights=c(1, 1.15))

site_level_corallivory_patterns_temp <- ggpubr::ggarrange(site_level_corallivory_patterns_ac, 
                                                     site_level_corallivory_patterns_bd+
                                                       theme(plot.margin =unit(c(5, 5, 5, 5), "pt")),
                                                     widths=c(1.15, 1))

common_legend <- ggpubr::get_legend(site_level_scar_density_by_coral_cover) %>% 
  as_ggplot() 

site_level_corallivory_patterns <- ggpubr::ggarrange(common_legend,
                                                     site_level_corallivory_patterns_temp,
                                                     nrow=2, ncol=1, heights = c(1,10))

# image/icon placement will look off in the chunk output but correct in the saved image
site_level_corallivory_patterns_with_images <- cowplot::ggdraw() +
  draw_plot(site_level_corallivory_patterns)+ 
  draw_image(major_corallivore_icon,  x = -0.38, y = -0.47, scale=0.08) + #adds the major pf icon
  draw_image(coral_icon, x = 0.175, y = -0.47, scale=0.055)+ #adds the coral
  draw_image(corallivory_icon,  x = -0.448, y = 0.379, scale=0.055) + #adds corallivory icon
  draw_image(corallivory_icon,  x = -0.448, y = -0.04, scale=0.055) #adds corallivory icon

site_level_corallivory_patterns_with_images

#saving as .jpg version (for presentations) and .pdf version (for publications)
ggsave(plot=site_level_corallivory_patterns_with_images, 
       filename=here("figures_tables/fig3_corallivory_by_coral_and_fish.jpg"), 
       width = 215, height = 160, dpi = 600, units = "mm")

ggsave(plot=site_level_corallivory_patterns_with_images, 
       filename=here("figures_tables/fig3_corallivory_by_coral_and_fish.pdf"), 
       width = 215, height = 160, dpi = 600, units = "mm")
```


```{r Fig. S3 Supp: Corallivory intensity by parrotfish biomass, message=FALSE, echo=FALSE}
# scar density ~ corallivore biomass
site_level_scar_density_by_corallivore_biomass <- 
  fish_corals_site_level %>%
  ggplot()+
  geom_smooth(aes(x=mean_pf_g_100m2, y=mean_scars_m2_coral, color=region),method="lm")+
  geom_point(aes(x=mean_pf_g_100m2, y=mean_scars_m2_coral, color=region), alpha=0.7)+
  scale_color_manual(values=region_palette)+
 scale_y_continuous(trans = scales::log_trans(),
                     breaks= c(0.05, 0.5, 5, 50, 500),
                     labels= c(0.05, 0.5, 5, 50, 500))+
  scale_x_continuous(expand = c(0.1, 0), 
                     breaks= c(0, 500, 1000,1500, 2000, 2500),
                     labels= c(0, 500, 1000, 1500, 2000, 2500))+ #values near 0 cutoff, expands x-axis to resolve issued
  labs(x=expression(paste("Major corallivore biomass (g 100 ", m^-2, ")")), 
       y=expression(paste("Scar density (n ", m^-2, " coral)")), 
       color="Region")  +
  theme_bw()+
  theme(legend.position = "top")+ 
  rremove("x.title") + 
  rremove("x.ticks") + 
  rremove("x.text")+
  rremove("y.title") + 
  rremove("y.ticks") + 
  rremove("y.text")

# coral area grazed ~ corallivore biomass
site_level_coral_area_grazed_by_corallivore_biomass <- 
  fish_corals_site_level %>%
  ggplot()+
  geom_smooth(aes(x=mean_pf_g_100m2, y=mean_pct_coral_grazed, color=region), method="lm")+
  geom_point(aes(x=mean_pf_g_100m2, y=mean_pct_coral_grazed, color=region), alpha=0.7)+
  scale_color_manual(values=region_palette)+
  scale_y_continuous(trans = scales::log_trans(),
                     breaks= c(0.00025, 0.0025, 0.025, 0.25, 2.5),
                     labels= c("0.00025", 0.0025, 0.025, 0.25, 2.5))+
  scale_x_continuous(expand = c(0.1, 0), 
                     breaks= c(0, 500, 1000,1500, 2000, 2500),
                     labels= c(0, 500, 1000, 1500, 2000, 2500))+ #values near 0 cutoff, expands x-axis to resolve issue
  labs(x=expression(paste("Major corallivore biomass (g 100 ", m^-2, ")")), 
       y=expression(paste("Coral area preyed upon (%)")), 
       color="Region") +
  theme_bw()+
  theme(legend.position = "top")+
  rremove("y.title") +  
  rremove("y.ticks") + 
  rremove("y.text")

# making combo figure

fig_corallivory_by_pf_biomass_site <- ggarrange(site_level_scar_density_by_corallivore_biomass, 
                                                site_level_coral_area_grazed_by_corallivore_biomass, 
                                                nrow=2, ncol=1, legend="none", labels=c("b", "d"))

site_level_fish_density_biomass_temp <- ggpubr::ggarrange(site_level_corallivory_patterns_ac, 
                                                     fig_corallivory_by_pf_biomass_site+
                                                       theme(plot.margin =unit(c(5, 5, 5, 5), "pt")),
                                                     widths=c(1.15, 1))

common_legend <- ggpubr::get_legend(site_level_scar_density_by_coral_cover) %>% 
  as_ggplot() 

site_level_fish_density_biomass <- ggpubr::ggarrange(common_legend,
                                                     site_level_fish_density_biomass_temp,
                                                     nrow=2,
                                                     ncol=1,
                                                     heights = c(1,10))






# making four panel plot in two parts to overcome weird spacing issues when making a four panel plot directly
site_level_corallivory_patterns_ac <- ggpubr::ggarrange(site_level_scar_density_by_corallivore_density +
                                                       theme(plot.margin =unit(c(l=5, r=5, t=5, b=0), "pt"))+
                                                          rremove("legend"),
                                                        
                                                        site_level_scar_density_by_corallivore_biomass+ 
                                                       theme(plot.margin =unit(c(l=5, r=5, t=5, b=5), "pt"))+
                                                          rremove("legend")+
                                                          rremove("ylab"),

                                                        site_level_coral_area_grazed_by_corallivore_density+
                                                       theme(plot.margin =unit(c(l=5, r=5, t=5, b=0), "pt"))+
                                                         rremove("legend"),

                                                        site_level_coral_area_grazed_by_corallivore_biomass+
                                                       theme(plot.margin =unit(c(l=5, r=5, t=5, b=5), "pt"))+
                                                         
                                                       rremove("legend")+
                                                         rremove("ylab"),

                                                        nrow=2,
                                                        ncol=2,
                                                        labels=c("a","b","c","d"),
                                                       heights=c(1, 1.15, 1, 1.15),
                                                       common.legend = TRUE)

# making four panel plot in two parts to overcome weird spacing issues when making a four panel plot directly
site_level_corallivory_patterns_supp_bd <- ggpubr::ggarrange(site_level_scar_density_by_corallivore_biomass+ 
                                                          theme(plot.margin =unit(c(t = 0, r = 5, b = 5, l = 25), "pt"))+
                                                          rremove("legend"),
                                                     site_level_coral_area_grazed_by_corallivore_biomass+
                                                          theme(plot.margin =unit(c(t = 5, r = 5, b = 0, l = 25), "pt"),
                                                                axis.title.x = element_text(
                                                                   margin = margin(t = 7.5, r = 0, b = 0, l = 0)))+
                                                       rremove("legend"),
                                                     nrow=2,
                                                     ncol=1,
                                                     align="v", 
                                                     labels=c("b", "d"),
                                                     heights=c(1, 1.15))

site_level_corallivory_patterns_supp_temp <- ggpubr::ggarrange(site_level_corallivory_patterns_ac, #fig a-c made in previous chunk
                                                     site_level_corallivory_patterns_supp_bd+
                                                       theme(plot.margin =unit(c(5, 5, 5, 5), "pt")),
                                                     widths=c(1.15, 1))

site_level_corallivory_patterns_supp <- ggpubr::ggarrange(common_legend, #common legend object made in previous chunk
                                                     site_level_corallivory_patterns_temp,
                                                     nrow=2,
                                                     ncol=1,
                                                     heights = c(1,10))

ggsave(plot=site_level_corallivory_patterns_supp, 
       filename=here("figures_tables/supplements_figs/fig_corallivory_by_pf_biomass_density_site.jpg"), 
       width = 215, height = 160, dpi = 600, units = "mm")
```

##Analysis of patterns across reefs

**Models 1 & 3:** GLMMs of scar density in response to parrotfish density (1) or biomass (3) and coral cover.

*Random slope and intercept model:* We ran an initial model using a random slope and intercept, but the model is unidenifiable/would not converge, likely due to the random effect structure being too complex given the sample size. (See Troubleshooting with glmmTMB [https://cran.r-project.org/web/packages/glmmTMB/vignettes/troubleshooting.html]) So, we proceeded with a random intercept model.

*Random intercept model w/ interaction:* We next ran the model with a random intercept by region, and an interaction between our fixed effects. Model converged but residuals deviated from QQ plot near center and KS test was significant. After looking at historgrams of parrotfish density (very skewed) and coral cover (skewed, but not as much) we proceeded to run the model with a square-root transformation on parrotfish density and then evaluate model fit to see if this resolved the issue.

*Random intercept model w/ interaction & transformed predictor:* Model residuals looked good, transformation helped address points that deviated from the line in the QQ plot. The interaction term (parrotfish density [or biomass]*coral cover) was not significant, but there was a significant observed effect of parrotfish density. To confirm that this observed effect was still present if the interaction term was dropped, we ran a final model without the interaction term. However, since our aim is hypothesis testing and we had an a priori hypothesis that there may be an interactive effect between parrotfish density or biomass and coral cover, we present the full model with the interaction in the paper.

*Random intercept model w/ transformed predictor (no interaction):* The model without the interaction had similar results to the model with the interaction, confirming that the observed significance is not an artifact of some model trends being altered by the presence of the interaction term.

```{r GLMM M1: scar density by major corallivore density + coral cover}
set.seed(1945) #for reproducible results from random simulations of residuals

## random-slope and intercept model with interaction: warnings - model is not identifiable/won't converge (for both gaussian and t distributions)
m1_scar_pf_density_gauss <- glmmTMB::glmmTMB(log(mean_scars_m2_coral) ~ mean_pf_n_100m2*mean_pct_coral_cover + (mean_pf_n_100m2 + mean_pct_coral_cover | region), data = fish_corals_site_level, family=gaussian)

m1_scar_pf_density <- glmmTMB::glmmTMB(log(mean_scars_m2_coral) ~ mean_pf_n_100m2*mean_pct_coral_cover + (mean_pf_n_100m2 + mean_pct_coral_cover | region), data = fish_corals_site_level, family=t_family)

# random-intercept model model with interaction (no explanatory variable transformation)
# Gaussian model
m2_scar_pf_density_gauss <- glmmTMB::glmmTMB(log(mean_scars_m2_coral) ~ mean_pf_n_100m2*mean_pct_coral_cover + (1 | region), data = fish_corals_site_level, family=gaussian)

m2_scar_pf_density_residuals_gauss <- DHARMa::simulateResiduals(m2_scar_pf_density_gauss, n = 1000, use.u = T) #evaluating model fit
plot(m2_scar_pf_density_residuals_gauss) #odd residual versus predicted pattern, trying transformation

# t-family model
m2_scar_pf_density <- glmmTMB::glmmTMB(log(mean_scars_m2_coral) ~ mean_pf_n_100m2*mean_pct_coral_cover + (1 | region), data = fish_corals_site_level, family=t_family)

m2_scar_pf_density_residuals <- DHARMa::simulateResiduals(m2_scar_pf_density, n = 1000, use.u = T) #evaluating model fit
plot(m2_scar_pf_density_residuals) #odd residual versus predicted pattern, trying transformation. But, looks better than Gaussian.

# random-intercept model model with interaction
m3_scar_pf_density_gauss <- glmmTMB::glmmTMB(log(mean_scars_m2_coral) ~ sqrt(mean_pf_n_100m2)*mean_pct_coral_cover + (1 | region), data = fish_corals_site_level, family=gaussian)

m3_scar_pf_density <- glmmTMB::glmmTMB(log(mean_scars_m2_coral) ~ sqrt(mean_pf_n_100m2)*mean_pct_coral_cover + (1 | region), data = fish_corals_site_level, family=t_family)

m3_scar_pf_density_residuals <- DHARMa::simulateResiduals(m3_scar_pf_density, n = 1000, use.u = T) #evaluating model fit
plot(m3_scar_pf_density_residuals) #looks better

#looking at residuals by region - nothing seems very extreme
bind_cols(m3_scar_pf_density_residuals$fittedResiduals, fish_corals_site_level$region) %>%
  rename(y = `...1`,
         region = `...2`) %>%
  ggplot(aes(x = 1:26, y = y, color = region)) +
  geom_point()

m3_scar_pf_density %>% summary()

# random-intercept model model without interaction
m4_scar_pf_density <- glmmTMB::glmmTMB(log(mean_scars_m2_coral) ~ sqrt(mean_pf_n_100m2)+mean_pct_coral_cover + (1 | region), data = fish_corals_site_level, family=t_family)

m4_scar_pf_density_residuals <- DHARMa::simulateResiduals(m4_scar_pf_density, n = 1000, use.u = T) #evaluating model fit
plot(m4_scar_pf_density_residuals) 

m4_scar_pf_density %>% summary() #model results similar to previous model

#tidying model output and calculating confidence intervals
m3_scar_pf_density_ci <- confint(m3_scar_pf_density) %>% as_tibble() %>% select(-Estimate)

scar_pf_density_model_output <- m3_scar_pf_density %>% 
  broom.mixed::tidy() %>% 
  filter(term != "sd__Observation") %>%
  bind_cols(m3_scar_pf_density_ci) %>%
  filter(effect!="ran_pars") %>%
  janitor::clean_names() %>%
  rename(ci_2.5 = x2_5_percent, ci_97.5=x97_5_percent) %>%
  mutate(model="M1 - Scar density") %>%
  select(model, term, statistic, p_value, estimate, ci_2.5, ci_97.5) %>%
  mutate(across(where(is.double), ~round(.x, 3)))

scar_pf_density_model_output
```

**Models 2 & 4:** GLMM of natural-log transformed percent coral area grazed in response to parrotfish density (2) or biomass (4) and coral cover.

*Random slope and intercept model:* We ran an initial model using a random slope and intercept, but the model is unidenifiable/would not converge, likely due to the random effect structure being too complex given the sample size. This model is hashed out in the code as it generates a NA/NaN function evaluation warning that stops the script - the model can be run with a square-root on parrotfish density, but it still creates a convergence warning, confirming that this caused the issue.

*Random intercept model w/ interaction:* We next ran the model with a random intercept by region, and an interaction between our fixed effects. Model converged but residuals deviated from QQ plot near center and KS test was significant. After looking at historgrams of parrotfish density (very skewed) and coral cover (skewed, but not as much) we proceeded to run the model with a square-root transformation on parrotfish density and then evaluate model fit to see if this resolved the issue.

*Random intercept model w/ interaction & transformed predictor:* Model residuals looked good, transformation helped address points that deviated from the line in the QQ plot. The interaction term (parrotfish density [or biomass]*coral cover) was not significant, but there was a significant observed effect of parrotfish density. To confirm that this observed effect was still present if the interaction term was dropped, we ran a final model without the interaction term.However, since our aim is hypothesis testing and we had an a priori hypothesis that there may be an interactive effect between parrotfish density or biomass and coral cover, we present the full model with the interaction in the paper.

*Random intercept model w/ transformed predictor (no interaction):* The model without the interaction had similar results to the model with the interaction, confirming that the observed significance is not an artifact of some model trends being altered by the presence of the interaction term.

```{r GLMM M2: coral area preyed upon by parrotfish density + coral cover}
set.seed(1945) #for reproducible results from random simulations of residuals

##Random-slope and intercept model with interaction: warnings - model is not identifiable/won't converge 
#m1_pctgrazed_pfdensity <- glmmTMB::glmmTMB(log(mean_pct_coral_grazed) ~ mean_pf_n_100m2*mean_pct_coral_cover + (mean_pf_n_100m2 + mean_pct_coral_cover | region), data = fish_corals_site_level, family=gaussian)

#Random-slope model with interaction
m2_pctgrazed_pfdensity <- glmmTMB::glmmTMB(log(mean_pct_coral_grazed) ~ mean_pf_n_100m2*mean_pct_coral_cover + (1 | region), data = fish_corals_site_level,family=gaussian)

m2_pctgrazed_pfdensity_residuals <- DHARMa::simulateResiduals(m2_pctgrazed_pfdensity, n = 1000, use.u = T) #evaluating model fit
plot(m2_pctgrazed_pfdensity_residuals) #KS test is significant

#looking at distributions of predictors
hist(fish_corals_site_level$mean_pf_g_100m2) #heavily skewed
hist(sqrt(fish_corals_site_level$mean_pf_g_100m2)) #more normal w/ slight skew
hist(fish_corals_site_level$mean_pct_coral_cover) #skewed, but not as much as parrotfish density
hist(asin(sqrt(fish_corals_site_level$mean_pct_coral_cover/100))) #more normal w/ some kurtosis

#Significant quantile deviations in previous model, first using sqrt transformation on pf density only to try to address this
m3_pctgrazed_pfdensity <- glmmTMB::glmmTMB(log(mean_pct_coral_grazed) ~ sqrt(mean_pf_n_100m2)*mean_pct_coral_cover + (1 | region), data = fish_corals_site_level,family=gaussian)

m3_pctgrazed_pfdensity_residuals <- DHARMa::simulateResiduals(m3_pctgrazed_pfdensity, n = 1000, use.u = T) #evaluating model fit
plot(m3_pctgrazed_pfdensity_residuals) #QQ plot looks better and no sig issues

#looking at residuals by region
#2 slightly more extreme points (1 in STX and 1 in PAN), but no consistent differences by region
bind_cols(m3_pctgrazed_pfdensity_residuals$fittedResiduals, fish_corals_site_level$region) %>%
  rename(y = `...1`,
         region = `...2`) %>%
  ggplot(aes(x = 1:26, y = y, color = region)) +
  geom_point() 

m3_pctgrazed_pfdensity %>% summary() #viewing model results

#since interaction is NS, confirming that observed patterns are similar when interaction term is dropped
m4_pctgrazed_pfdensity <- glmmTMB::glmmTMB(log(mean_pct_coral_grazed) ~ sqrt(mean_pf_n_100m2)+mean_pct_coral_cover + (1 | region), data = fish_corals_site_level,family=gaussian)
m4_pctgrazed_pfdensity %>% summary() #similar results when interaction is dropped

#tidying model output and calculating confidence intervals (of model 3, with the interaction)
pctgrazed_pfdensity_m2_ci <- confint(pctgrazed_pfdensity_m2) %>% as_tibble() %>% select(-Estimate)

proportion_grazed_pfdensity_model_output <- pctgrazed_pfdensity_m2 %>% 
  broom.mixed::tidy() %>% 
  filter(term != "sd__Observation") %>%
  bind_cols(pctgrazed_pfdensity_m2_ci) %>%
  filter(effect!="ran_pars") %>%
  janitor::clean_names() %>%
  rename(ci_2.5 = x2_5_percent, ci_97.5=x97_5_percent) %>%
  mutate(model="M3 - Coral area preyed upon (%)") %>%
  select(model, term, statistic, p_value, estimate, ci_2.5, ci_97.5) %>%
  mutate(across(where(is.double), ~round(.x, 3)))
```

Notably, the following model residuals look okay without a square root transformation on parrotfish biomass. However, since in all other models parrotfish density or biomass were square-root transformed for a better model fit, and because the model residuals still look okay with the square root transformation, we're using that transformation for consistency/better comparability between models.

```{r GLMM M3: scar density by major corallivore biomass + coral cover}
set.seed(1945) #for reproducible results from random simulations of residuals

#random-slope and intercept model with interaction: warnings - model is not identifiable/won't converge (for both gaussian and t distribution)
m1_scar_density_biomass_gauss <- glmmTMB::glmmTMB(log(mean_scars_m2_coral) ~ mean_pf_g_100m2*mean_pct_coral_cover + (mean_pf_n_100m2 + mean_pct_coral_cover | region), data = fish_corals_site_level, family=gaussian)

m1_scar_density_biomass <- glmmTMB::glmmTMB(log(mean_scars_m2_coral) ~ mean_pf_g_100m2*mean_pct_coral_cover + (mean_pf_n_100m2 + mean_pct_coral_cover | region), data = fish_corals_site_level, family=t_family)

#random-intercept model 
# Gaussian model
m2_scar_density_biomass_gauss <- glmmTMB::glmmTMB(log(mean_scars_m2_coral) ~ mean_pf_g_100m2*mean_pct_coral_cover + (1 | region), data = fish_corals_site_level, family=t_family)

scar_density_biomass_m2_residuals_gauss <- DHARMa::simulateResiduals(m2_scar_density_biomass_gauss, n = 1000, use.u = T) 
plot(scar_density_biomass_m2_residuals_gauss) 

# t-family model
m2_scar_density_biomass <- glmmTMB::glmmTMB(log(mean_scars_m2_coral) ~ mean_pf_g_100m2*mean_pct_coral_cover + (1 | region), data = fish_corals_site_level, family=t_family)

scar_density_biomass_m2_residuals <- DHARMa::simulateResiduals(scar_density_biomass_m2, n = 1000, use.u = T) 
plot(scar_density_biomass_m2_residuals) #residuals look better than Gaussian (lines more horizontal)

m2_scar_density_biomass %>% summary() #viewing model results

hist(fish_corals_site_level$mean_pf_g_100m2)
hist(sqrt(fish_corals_site_level$mean_pf_g_100m2)) #not perfect, but less skewness with sqrt transformation

#rerunning model with square-root transformation of corallivore density to attempt to address KS test issues
#using transformation to make it consistent and more comparable to other models
m3_scar_density_biomass <- glmmTMB::glmmTMB(log(mean_scars_m2_coral) ~sqrt(mean_pf_g_100m2)*(mean_pct_coral_cover)+ (1 | region), data = fish_corals_site_level, family=t_family)

#evaluating model fit
m3_scar_density_biomass_residuals <- DHARMa::simulateResiduals(m3_scar_density_biomass, n = 1000, use.u = T) 
plot(m3_scar_density_biomass_residuals) #QQ plot looks good but quantile deviations detected, taking a closer look at residuals

#looking at residuals by region - nothing seems very extreme
bind_cols(m3_scar_density_biomass_residuals$fittedResiduals, fish_corals_site_level$region) %>%
  rename(y = `...1`,
         region = `...2`) %>%
  ggplot(aes(x = 1:26, y = y, color = region)) +
  geom_point()

m3_scar_density_biomass %>% summary() #viewing model results

#since interaction is NS, confirming that observed patterns are similar when interaction term is dropped
m4_scar_density_biomass <- glmmTMB::glmmTMB(log(mean_scars_m2_coral) ~sqrt(mean_pf_g_100m2)+(mean_pct_coral_cover)+ (1 | region), data = fish_corals_site_level, family=t_family)
m4_scar_density_biomass %>% summary() #similar results when interaction is dropped

#tidying model output and calculating confidence intervals
m3_scar_density_biomass_ci <- confint(m3_scar_density_biomass) %>% as_tibble() %>% select(-Estimate)

scar_density_biomass_model_output <- m3_scar_density_biomass %>% 
  broom.mixed::tidy() %>% 
  filter(term != "sd__Observation") %>%
  bind_cols(m3_scar_density_biomass_ci) %>%
  filter(effect!="ran_pars") %>%
  janitor::clean_names() %>%
  rename(ci_2.5 = x2_5_percent, ci_97.5=x97_5_percent) %>%
  mutate(model="M2 - Scar density") %>%
  select(model, term, statistic, p_value, estimate, ci_2.5, ci_97.5) %>%
  mutate(across(where(is.double), ~round(.x, 3)))

scar_density_biomass_model_output
```

```{r GLMM M4: coral area preyed upon by parrotfish biomass + coral cover}
set.seed(1945) #for reproducible results from random simulations of residuals

##Random-slope and intercept model with interaction: warnings - model is not identifiable/won't converge 
m1_pct_grazed_biomass <- glmmTMB::glmmTMB(log(mean_pct_coral_grazed) ~ mean_pf_g_100m2*mean_pct_coral_cover + (mean_pf_g_100m2 + mean_pct_coral_cover | region), data = fish_corals_site_level, family=gaussian)

#Random-slope model with interaction
m2_pct_grazed_biomass <- glmmTMB::glmmTMB(log(mean_pct_coral_grazed) ~ mean_pf_g_100m2*mean_pct_coral_cover +(1 | region), data = fish_corals_site_level, family=gaussian)

m2_pct_grazed_biomass_residuals <- DHARMa::simulateResiduals(m2_pct_grazed_biomass, n = 1000, use.u = T) 
plot(m2_pct_grazed_biomass_residuals) #significant quantile deviations, QQ plot shows variation in center not tails

#Significant quantile deviations in previous model, using transformation of predictor to address this
m3_pct_grazed_biomass <- glmmTMB::glmmTMB(log(mean_pct_coral_grazed) ~ sqrt(mean_pf_g_100m2)*mean_pct_coral_cover +(1 | region), data = fish_corals_site_level, family=gaussian)

m3_pct_grazed_biomass_residuals <- DHARMa::simulateResiduals(m3_pct_grazed_biomass, n = 1000, use.u = T) 
plot(m3_pct_grazed_biomass_residuals) #still some quantile deviations but adjusted test NS, diagnostic plots look much better

#looking at residuals by region
#same as previous: 2 more extreme points (1 in STX and 1 in PAN), but no consistent differences by region
bind_cols(m3_pct_grazed_biomass_residuals$fittedResiduals, fish_corals_site_level$region) %>%
  rename(y = `...1`,
         region = `...2`) %>%
  ggplot(aes(x = 1:26, y = y, color = region)) +
  geom_point() 

m4_pct_grazed_biomass <- glmmTMB::glmmTMB(log(mean_pct_coral_grazed) ~ sqrt(mean_pf_g_100m2)+mean_pct_coral_cover +(1 | region), data = fish_corals_site_level, family=gaussian)

m4_pct_grazed_biomass_residuals <- DHARMa::simulateResiduals(m4_pct_grazed_biomass, n = 1000, use.u = T) 
plot(m4_pct_grazed_biomass_residuals) #still some quantile deviations but adjusted test NS, diagnostic plots look much better
m4_pct_grazed_biomass %>% summary() #same overall sig as findings to model w/ interaction, just different effect size

#viewing model results
m3_pct_grazed_biomass %>% summary()

#since interaction is NS, confirming that observed patterns are similar when interaction term is dropped
m4_pct_grazed_biomass <- glmmTMB::glmmTMB(log(mean_pct_coral_grazed) ~sqrt(mean_pf_g_100m2)+(mean_pct_coral_cover)+ (1 | region), data = fish_corals_site_level, family=gaussian)
m4_pct_grazed_biomass %>% summary() #similar results when interaction is dropped

#tidying model output and calculating confidence intervals
m3_pct_grazed_biomass_ci <- confint(m3_pct_grazed_biomass) %>% as_tibble() %>% select(-Estimate)

proportion_grazed_biomass_model_output <- m3_pct_grazed_biomass %>% 
  broom.mixed::tidy() %>% 
  filter(term != "sd__Observation") %>%
  bind_cols(m3_pct_grazed_biomass_ci) %>%
  filter(effect!="ran_pars") %>%
  janitor::clean_names() %>%
  rename(ci_2.5 = x2_5_percent, ci_97.5=x97_5_percent) %>%
  mutate(model="M4 - Coral area preyed upon (%)") %>%
  select(model, term, statistic, p_value, estimate, ci_2.5, ci_97.5) %>%
  mutate(across(where(is.double), ~round(.x, 3)))
```
Table summarizing the results of both site-level GLMMs
```{r Table S4: Summary of site-level GLMM results}
table_s4 <- scar_pf_density_model_output %>% 
  bind_rows(proportion_grazed_pfdensity_model_output) %>%
  bind_rows(scar_density_biomass_model_output) %>%
  bind_rows(proportion_grazed_biomass_model_output)

write_csv(table_s4, here("figures_tables/supplements_tables/table_s4_site_level_glmm_results.csv"))
```

## Transect-level effects of coral diversity and taxa-specific coral cover

We calculated diversity using the Shannon Index (H')
```{r Summarizing coral diversity by transect}
set.seed(1945) #for reproducible results from random simulations of residuals

# total abundance of colonies per transect
total_coral_abundance <- coral_scar_df %>% 
  group_by(region, site, transect, depth_m) %>% 
  reframe(total_n_colonies=n())

# calculating transect-level coral diversity and coral cover
coral_taxa_abundance_cover <- coral_scar_df %>% 
  group_by(region, site, transect, depth_m, coral_species) %>% 
  reframe(n_colonies=n(), #transect-level abundance of coral colonies per species 
          pct_coral_cover_species=(sum(col_area_cm2)/300000)*100) %>% #coral cover by species
  left_join(total_coral_abundance) #total coral abundance per transect
  
# calculating coral diversity and total coral cover per transect
coral_diversity_and_cover <- coral_taxa_abundance_cover %>%
  mutate(prop_abundance=n_colonies/total_n_colonies, #proportional abundance of coral taxa          
         p_ln_prop_abundance=prop_abundance*log(prop_abundance)) %>% #for diversity calculations
  group_by(region, site, transect, depth_m) %>%
  reframe(coral_diversity=sum(p_ln_prop_abundance)*-1, #summarizing diversity per transect
          pct_coral_cover=sum(pct_coral_cover_species)) #summarizing transect-level coral cover
  
# abundance of colonies per species per transect
n_colonies_species_transect <- coral_scar_df %>% 
  group_by(region, site, transect, depth_m, coral_species) %>% 
  dplyr::reframe(n_colonies=n()) %>% #transect-level abundance of coral colonies per species 
  left_join(total_coral_abundance, by = join_by(region, site, transect, depth_m))

# transect-level summary of the number of grazed colonies of four heavily predated taxa
transect_level_corallivory <- coral_scar_df %>% 
  group_by(region, site, transect, depth_m, coral_species) %>% 
  filter(n_new_scars>0) %>%
  dplyr::reframe(n_colonies_grazed=n())

transect_corallivory_diversity_df <- coral_taxa_abundance_cover %>% 
  left_join(transect_level_corallivory, by = join_by(region, site, transect, depth_m, coral_species)) %>%
  mutate(n_colonies_grazed=replace_na(n_colonies_grazed, 0)) %>%
  select(region, site, transect, depth_m, coral_species, pct_coral_cover_species, n_colonies_grazed, n_colonies) %>%
  filter(coral_species %in% c("Orbicella annularis", "Porites astreoides", "Branching Porites spp.", "Siderastrea siderea")) %>%
  left_join(coral_diversity_and_cover, by = join_by(region, site, transect, depth_m)) %>%
  mutate(proportional_cover=pct_coral_cover_species/pct_coral_cover)
```

**Model:** GLMM of the number of colonies grazed (per 30 m2 transect) in response to coral diversity (H'), coral species (OANN, PAST, Branching Porites, SSID), species-specific coral cover, transect depth (m), and region, with random effects of transect nested within site.

```{r Data analysis: Influence of coral diversity and cover on transect-level n cols grazed, warning=FALSE, message=FALSE}
set.seed(1945) #for reproducible results from random simulations of residuals

#looking at data distributions
transect_corallivory_diversity_df %>%
  ggplot(aes(n_colonies_grazed))+
  geom_histogram()

#coral cover is severely skewed
transect_corallivory_diversity_df %>%
  ggplot(aes(pct_coral_cover_species))+
  geom_histogram()

#checking that species percent cover does not have 0's
summary(transect_corallivory_diversity_df$pct_coral_cover_species)

#log-transformation normalized coral cover distribution
transect_corallivory_diversity_df %>%
  ggplot(aes(log(pct_coral_cover_species)))+
  geom_histogram()

#scar abundance per colony with poisson
n_grazed_diversity_poisson <- glmmTMB::glmmTMB(n_colonies_grazed ~ coral_diversity+ coral_species+coral_species:log(proportional_cover)+ depth_m+ region+
                              (1 | site/transect), #transects nested within sites within regions
                              family=poisson,
                              data = transect_corallivory_diversity_df)

#scar abundance per colony with negative binomial distribution (without zero-inflation)
n_grazed_diversity_nbinom <- glmmTMB::glmmTMB(n_colonies_grazed ~ coral_diversity+ coral_species+ coral_species:log(proportional_cover)+ depth_m+ region+
                              (1 | site/transect), #transects nested within sites within regions
                              zi=~0, #non zero-inflated
                              family=nbinom2(link = "log"),
                              data = transect_corallivory_diversity_df)
plot(DHARMa::simulateResiduals(n_grazed_diversity_nbinom, n = 1000, use.u = T))

#scar abundance per colony with negative binomial distribution (with zero-inflation)

n_grazed_diversity_nbinom_zi  <- glmmTMB::glmmTMB(n_colonies_grazed ~ coral_diversity+ coral_species+ coral_species:log(proportional_cover)+ depth_m+ region+
                              (1 | site/transect), #transects nested within sites within regions
                              zi=~1, # zero-inflated
                              family=nbinom2(link = "log"),
                              data = transect_corallivory_diversity_df)
plot(DHARMa::simulateResiduals(n_grazed_diversity_nbinom, n = 1000, use.u = T))

hist(log(transect_corallivory_diversity_df$proportional_cover))
hist(sqrt(transect_corallivory_diversity_df$proportional_cover))

#likelihood ratio tests suggest NS difference between poisson and negative binomial
anova(n_grazed_diversity_poisson, n_grazed_diversity_nbinom) 

#likelihood ratio tests suggest NS difference between negative binomial w/ or w/o zero inflation... supports using non zi model
anova(n_grazed_diversity_nbinom_zi, n_grazed_diversity_nbinom) 

#simulating residuals and evaluating model fit
n_grazed_diversity_poisson_residuals <- DHARMa::simulateResiduals(n_grazed_diversity_poisson, n = 1000, use.u = T)
plot(n_grazed_diversity_poisson_residuals) #diagnostic plot: KS test significant

n_grazed_diversity_nbinom_residuals <- DHARMa::simulateResiduals(n_grazed_diversity_nbinom, n = 1000, use.u = T)
plot(n_grazed_diversity_nbinom_residuals) #diagnostic plot indicates no sig problems: using nbinom distribution
DHARMa::testZeroInflation(n_grazed_diversity_nbinom_residuals) #secondary check that there's no evidence of zero inflation (in addition to likelihood ratio test)

n_grazed_diversity_nbinom %>% summary()
```

```{r Table S5: Summary of transect-level GLMM results}
n_grazed_diversity_nbinom_ci <- confint(n_grazed_diversity_nbinom) %>% 
  as_tibble() %>%
  select(-Estimate)

#tidying model output
transect_level_model_output <- n_grazed_diversity_nbinom %>% 
  broom.mixed::tidy() %>% 
  bind_cols(n_grazed_diversity_nbinom_ci) %>%
  filter(effect!="ran_pars") %>%
  janitor::clean_names() %>%
  rename(ci_2.5 = x2_5_percent, ci_97.5=x97_5_percent) %>%
  mutate(model="Colonies grazed") %>%
  select(model, term, statistic, p_value, estimate, ci_2.5, ci_97.5) %>%
  mutate(across(where(is.double), ~round(.x, 3))) %>%
  mutate(term=str_replace(term, "coral_species", "")) %>%
  mutate(term=str_replace(term, "region", ""))

#back transforming estimated effect sizes (see paper supplements for description)
transect_level_model_output %>%
  #exponentiating all independent variables except proportional cover, which was log transformed
    mutate(estimate_backtransformed = exp(estimate)) %>%
  mutate(across(where(is.double), ~round(.x, 3)))

write_csv(transect_level_model_output, here("figures_tables/supplements_tables/table_s5_transect_level_grazed_coral_abundance_results.csv"))
```

```{r Summarizing predation intensity by coral species}
# total number of coral colonies observed across all transects
nrow(coral_scar_df)

# total number of colonies grazed (for coral taxa with 3+ predated cols across observations)
n_grazed_cols <- coral_scar_df %>% 
  filter(n_new_scars>0) %>% 
  distinct(colony_id) %>% 
  nrow()
n_grazed_cols

# number of grazed colonies by taxa (for coral taxa with 3+ predated cols across observations)
coral_scar_df %>% 
  filter(n_new_scars>0) %>%
  group_by(coral_species) %>%
  tally() %>%
  arrange(-n)

# total number of colonies grazed for top four predated species
n_top_4_grazed <- coral_scar_df %>% 
  filter(n_new_scars>0) %>%
  filter(coral_species %in% c("Orbicella annularis", "Branching Porites spp.", "Porites astreoides", "Siderastrea siderea")) %>% 
  distinct(colony_id) %>% 
  nrow()

#percentage of predation scars observed on these four coral species compared to total number of recent scars
round(n_top_4_grazed/n_grazed_cols*100, 1)
```

```{r Fig. S5: Abundance corals grazed by coral diversity, fig.height = 3.15, fig.width = 8.46}
corallivory_by_diversity_fig <- transect_corallivory_diversity_df %>%
  mutate(coral_species=factor(coral_species, levels = c("Orbicella annularis", "Branching Porites spp.", "Porites astreoides", "Siderastrea siderea"))) %>% 
  mutate(region= factor(region, levels = c("Panamá", "Florida",  "St. Croix", "Bonaire"))) %>%
  ggplot(aes(x=coral_diversity, y=n_colonies_grazed, color=region))+
  geom_point(alpha=0.6)+
  scale_y_continuous(breaks = c(0,2,4,6,8,10), 
                     labels= c(0,2,4,6,8,10),
                     limits=c(0,10.2))+
  theme_bw()+
  scale_color_manual(values=region_palette)+
  scale_fill_manual(values=region_palette)+
  facet_wrap(~coral_species)+
  labs(x = "Coral diversity (H')",
       y = expression(paste("Colonies preyed upon per 30 m" ^2)),
       color="Region",
       fill="Region")+
  theme_bw()+
  theme(legend.position = "top")

#reading in coral genus icons
branching_porties_image <- magick::image_read(path=here("figures_tables/reef_images", "Branching_porties.png"), density = NULL, depth = NULL, strip = TRUE)
orbicella_image <- magick::image_read(path=here("figures_tables/reef_images", "Orbicella_annularis.png"), density = NULL, depth = NULL, strip = TRUE)
porites_astreoides_image <- magick::image_read(path=here("figures_tables/reef_images", "Porites_astreoides.png"), density = NULL, depth = NULL, strip = TRUE)
siderastrea_image <- magick::image_read(path=here("figures_tables/reef_images", "Siderastrea_siderea.png"), density = NULL, depth = NULL, strip = TRUE)

#adding coral images to figure (image placement is off in R, but good in ggsave generated png)
corallivory_by_diversity_fig_final <- cowplot::ggdraw() +
  draw_plot(corallivory_by_diversity_fig)+ #adds the plot (order matters to overlay the layers correctly)
  draw_image(orbicella_image, x = -0.385, y = 0.29, scale=0.075)+
  draw_image(branching_porties_image, x = 0.081, y = 0.29, scale=0.08)+
  draw_image(porites_astreoides_image, x = -0.385, y = -0.113, scale=0.062)+
  draw_image(siderastrea_image, x = 0.08, y = -0.11, scale=0.063)

#saving figure
ggsave(plot=corallivory_by_diversity_fig_final, filename=here("figures_tables/supplements_figs/fig_s5_corallivory_by_coral_diversity.png"), width = 190, height = 140, dpi = 600, units = "mm")

corallivory_by_diversity_fig_final
```
# ___________________________________________________________________________________

## Colony-level analysis

We analyzed the effect of coral colony surface area and coral taxa on the abundance of scars per coral colony using GLMM with a negative binomial distribution. We tested for zero-inflation, which was significant. Since the poisson error distribution assumes the mean and variance are the same, but negative binomial models have different means and variance, a negative binomial model is more appropriate for these data.

```{r Data analysis: Scar abundance by colony size + coral species + region}
set.seed(1945) #for reproducible results from random simulations of residuals

# scar abundance per colony with poisson
n_scars_col_level_poisson <- glmmTMB::glmmTMB(n_new_scars ~ col_area_cm2 + coral_species + depth_m + region+
                              (1 | site/transect), #transects nested within sites within regions
                              family=poisson,
                              data = coral_scar_df)
n_scars_col_level_poisson %>% summary()

# scar abundance per colony with negative binomial distribution (without zero-inflation)
n_scars_col_level_nbinom <- glmmTMB::glmmTMB(n_new_scars ~ col_area_cm2 + coral_species + depth_m+ region+ 
                              (1 | site/transect), #transects nested within sites within regions
                              zi=~0, #non zero-inflated
                              family=nbinom2(link = "log"),
                              data = coral_scar_df)

#comparing with zero-inflated model
n_scars_col_level_nbinom_zi <- glmmTMB::glmmTMB(n_new_scars ~ col_area_cm2 + coral_species + depth_m+ region+ 
                              (1 | site/transect), #transects nested within sites within regions
                              zi=~0, #zero-inflated
                              family=nbinom2(link = "log"),
                              data = coral_scar_df)

# likelihood ratio test of model using poisson versus negative binomial distribution: nbinom sig better
anova(n_scars_col_level_poisson, n_scars_col_level_nbinom)

# likelihood ratio test of model using ZI versus non-ZI negative binomial distribution: no sig diff, suggesting no ZI
anova(n_scars_col_level_nbinom_zi, n_scars_col_level_nbinom)

# simulating residuals and testing
n_scars_col_level_residuals <- DHARMa::simulateResiduals(n_scars_col_level_nbinom2, n = 1000, use.u = T) 

# evaluating model residuals
plot(n_scars_col_level_residuals) #NS overdispersion, outliers, or KS
testZeroInflation(n_scars_col_level_residuals) #secondary test to confirm no ZI, test show NS ZI

# model output
n_scars_col_level_nbinom2 %>% summary()

# summary of mean number of new scars per colony by region
coral_scar_df %>% 
  group_by(region) %>% 
  dplyr::reframe(mean_n_new_scars=mean(n_new_scars)) %>%
  mutate(mean_n_new_scars=round(mean_n_new_scars, 3))

coral_scar_df %>% 
  group_by(coral_species) %>% 
  reframe(mean_new_scars=mean(n_new_scars),
          sem=sem(n_new_scars))
```

```{r Table S6: Colony-level scar abundance model output}
# tidying model output and calculating confidence intervals
n_scars_col_level_ci <- confint(n_scars_col_level_nbinom) %>% 
  as_tibble() %>%
  select(-Estimate)

# tidying model output
n_scars_col_level_model_output <- n_scars_col_level_nbinom %>% 
  broom.mixed::tidy() %>% 
  bind_cols(n_scars_col_level_ci) %>%
  filter(effect!="ran_pars") %>%
  janitor::clean_names() %>%
  rename(ci_2.5 = x2_5_percent, ci_97.5=x97_5_percent) %>%
  mutate(model="Scar abundance") %>%
  select(model, term, statistic, p_value, estimate, ci_2.5, ci_97.5) %>%
  mutate(across(where(is.double), ~round(.x, 3))) %>%
  mutate(term=str_replace(term, "coral_species", ""))

# back transforming estimated effect sizes (see paper supplements for description)
n_scars_col_level_model_output %>%
  #exponentiating all independent variables
  mutate(estimate_backtransformed = exp(estimate)) %>%
  mutate(across(where(is.double), ~round(.x, 3)))

n_scars_col_level_model_output

write_csv(n_scars_col_level_model_output, here("figures_tables/supplements_tables/table_s6_colony_level_scar_abundance_results.csv"))
```

```{r Data processing: Filtering data to only include colonies with predation scars}
predated_colonies_subset <- coral_scar_df %>% 
  mutate(pct_grazed=total_grazed_cm2/col_area_cm2*100) %>%
  filter(n_new_scars>0) %>%
  #organizing as factor so the Branching Porites spp. cat is grouped with P. astreoides
  mutate(coral_species=factor(coral_species, levels = c("Agaricia agaricites", "Agaricia humilis", "Agaricia tenuifolia", "Agaricia spp.", "Madracis auretenra", "Madracis decactis", "Orbicella annularis", "Orbicella faveolata", "Branching Porites spp.", "Porites astreoides", "Siderastrea siderea", "Stephanocoenia intersepta"))) %>%
  mutate(region= factor(region, levels = c("Panamá", "Florida",  "St. Croix", "Bonaire"))) 

coral_scar_df %>% 
  filter(n_new_scars>0)
```

**Model:** GLMM of natural-log transformed mean scar area per predated colony in response to colony size, species, and region with the random nested effects of transect within site.

There are four outlier data points, however, based on the DHARMA '?outlier' details, 4 outliers in a dataset with 323 data points and 1000 simulations is expected/normal. Upon closer examination of residual versus predicted the model seems to have a good fit and while there are quantile deviations they do not appear extreme and the combined adjusted quantile test is not significant. Proceeding to interpret the model with outliers rather than filter them out.

```{r Data analysis: Mean scar area by coral size + species + region}
set.seed(1945) #for reproducible results from random simulations of residuals

#comparing model with gaussian versus t distributions
mean_scar_size_gaussian <- glmmTMB::glmmTMB(log(mean_scar_area_cm2) ~ log(col_area_cm2) + coral_species + depth_m+ region+
                              (1 | site/transect), #transects nested within sites within regions
                              family=gaussian,
                              data = predated_colonies_subset)

mean_scar_size_t <- glmmTMB::glmmTMB(log(mean_scar_area_cm2) ~ log(col_area_cm2) + coral_species + depth_m + region+
                              (1 | site/transect), #transects nested within sites within regions
                              family=t_family,
                              data = predated_colonies_subset)

# likelihood ratio test of model using t-distribution versus Gaussian distribution: t-dist sig better
anova(mean_scar_size_t, mean_scar_size_gaussian)

# simulating residuals and visualizing model fit: visuals confirm t-distribution 
mean_scar_size_gaussian_residuals <- DHARMa::simulateResiduals(mean_scar_size_gaussian, n = 1000, use.u = T) 
mean_scar_size_t_residuals <- DHARMa::simulateResiduals(mean_scar_size_t, n = 1000, use.u = T) 

#diagnostic plots confirm t-distribution is a better fit
plot(mean_scar_size_gaussian_residuals)
plot(mean_scar_size_t_residuals) 

#checking model results
mean_scar_size_t %>% summary()
```

```{r Table S7: Colony-level mean scar size model output}
mean_scar_size_col_level_ci <- confint(mean_scar_size_t) %>% 
  as_tibble() %>%
  select(-Estimate)

mean_scar_size_col_level_model_output <- mean_scar_size_t %>% 
  broom.mixed::tidy() %>% 
  filter(term != "sd__Observation") %>%
  bind_cols(mean_scar_size_col_level_ci) %>%
  filter(effect!="ran_pars") %>%
  janitor::clean_names() %>%
  rename(ci_2.5 = x2_5_percent, ci_97.5=x97_5_percent) %>%
  mutate(model="Colony-level mean scar size") %>%
  select(model, term, statistic, p_value, estimate, ci_2.5, ci_97.5) %>%
  mutate(across(where(is.double), ~round(.x, 3))) %>%
  mutate(term=str_replace(term, "coral_species", ""))

#back transforming estimated effect sizes (see paper supplements for description)
mean_scar_size_col_level_model_output %>%
  #exponentiating all independent variables except coral area, which was log transformed
    mutate(estimate_backtransformed = case_when(term!="log(col_area_cm2)"~exp(estimate),
                                                TRUE~as.double(estimate))) %>%
   mutate(across(where(is.double), ~round(.x, 3)))
  
write_csv(mean_scar_size_col_level_model_output, here("figures_tables/supplements_tables/table_s7_colony_level_mean_scar_size_results.csv"))
```

**Model:** GLMM of natural-log transformed percent area grazed per predated colony in response to colony size, species, and region with the random nested effects of transect within site.

See note on prior model regarding outliers. Choosing to interpret the model including the three outliers rather than filter them out, as a model based on this ammount of data and this many simulations is expected to have a few outliers (according to DHARMA).

```{r Data analysis: Percent colony grazed by coral size + species + region, warning=FALSE}
set.seed(1945) #for reproducible results from random simulations of residuals

pct_grazed_gaussian <- glmmTMB::glmmTMB(log(pct_grazed) ~ log(col_area_cm2) + coral_species+ depth_m + region+
                              (1 | site/transect), #transects nested within sites within regions
                              family=gaussian,
                              data = predated_colonies_subset)

pct_grazed_t <- glmmTMB::glmmTMB(log(pct_grazed) ~ log(col_area_cm2) + coral_species + depth_m + region+
                              (1 | site/transect), #transects nested within sites within regions
                              family=t_family,
                              data = predated_colonies_subset)

# likelihood ratio test of model using t-distribution versus Gaussian distribution: no sig diff
anova(pct_grazed_t, pct_grazed_gaussian)

# simulating residuals and visualizing model fit: visuals confirm t-distribution 
pct_grazed_gaussian_residuals <- DHARMa::simulateResiduals(pct_grazed_gaussian, n = 1000, use.u = T) 
mean_scar_size_t_residuals <- DHARMa::simulateResiduals(pct_grazed_t, n = 1000, use.u = T) 

#diagnostic plots confirm t-distribution is a better fit
plot(pct_grazed_gaussian_residuals)
plot(mean_scar_size_t_residuals) 

#model results
pct_grazed_t %>% summary()
```

```{r Table S8: Colony-level percent coral grazed model output}
pct_grazed_col_level_ci <- confint(pct_grazed_t) %>% 
  as_tibble() %>%
  select(-Estimate)

pct_grazed_col_level_model_output <- pct_grazed_t %>% 
  broom.mixed::tidy() %>% 
  filter(term != "sd__Observation") %>%
  bind_cols(pct_grazed_col_level_ci) %>%
  filter(effect!="ran_pars") %>%
  janitor::clean_names() %>%
  rename(ci_2.5 = x2_5_percent, ci_97.5=x97_5_percent) %>%
  mutate(model="Colony-level percent coral grazed") %>%
  select(model, term, statistic, p_value, estimate, ci_2.5, ci_97.5) %>%
  mutate(across(where(is.double), ~round(.x, 3))) %>%
  mutate(term=str_replace(term, "coral_species", ""))

#back transforming estimated effect sizes (see paper supplements for description)
pct_grazed_col_level_model_output %>%
  #exponentiating all independent variables except coral area, which was log transformed
    mutate(estimate_backtransformed = case_when(term!="log(col_area_cm2)"~exp(estimate),
                                                TRUE~as.double(estimate))) %>%
   mutate(across(where(is.double), ~round(.x, 3)))

write_csv(pct_grazed_col_level_model_output, here("figures_tables/supplements_tables/table_s8_colony_level_percent_coral_grazed_results.csv"))
```

```{r Fig. 4 (a) Scar area and (b) percent colony grazed by taxa + region, predated_coral_patterns, fig.height = 3.15, fig.width = 8.46}
#list of coral species arranged by the total number of colonies with scars
coral_species_arranged_by_n_grazed <- predated_colonies_subset %>% 
  group_by(coral_species) %>% 
  dplyr::reframe(n_grazed=n()) %>% 
  arrange(-n_grazed)

#used in graphs to simultaneously jitter and nudge points to avoid overlap
jitter_nudge <- ggpp::position_jitternudge(height = 0.08, y = -0.1, nudge.from = "jittered")

#summarizing y min and max for axis limits in following figure
predated_colonies_subset %>%
  dplyr::reframe(min(mean_scar_area_cm2), max(mean_scar_area_cm2))

#first figure in set
fig_mean_scar_taxa <-predated_colonies_subset %>%
  #for consistent order of regions
  mutate(region= factor(region, levels = c("Panamá", "Florida",  "St. Croix", "Bonaire"))) %>%
  #arranging coral species by the number of colonies with scars
  mutate(coral_species= factor(coral_species, levels = c("Porites astreoides", "Branching Porites spp.", "Orbicella annularis","Siderastrea siderea","Agaricia agaricites","Agaricia tenuifolia", "Madracis decactis", "Orbicella faveolata", "Agaricia humilis", "Madracis auretenra", "Agaricia spp.", "Stephanocoenia intersepta"))) %>%
  ggplot()+
  ggridges::geom_density_ridges(aes(x=mean_scar_area_cm2, y=coral_species), alpha=0.7, scale=0.7)+
  geom_point(aes(x=mean_scar_area_cm2, y=coral_species, color=region), size=0.7, alpha=0.5,
            position=jitter_nudge)+
  scale_color_manual(values=region_palette)+
  scale_fill_manual(values=region_palette)+
  scale_y_discrete(expand = c(0.1, 0), limits = rev)+ 
  scale_x_continuous(trans = scales::log_trans(),
                     breaks = c(0.01, 0.1, 1, 10, 55), 
                     labels= c(0.01, 0.1, 1, 10, 55),
                     limits=c(0.009,56))+
  labs(x = expression(paste("Mean scar surface area (cm" ^2, ")")),
       y = "Coral taxa",
       color="Region",
       fill="Region")+
  theme_bw()+
  theme(legend.position = "top",
        axis.text.y= element_text(face="italic", size = 8),
        axis.text.x=element_text(size = 8),
        axis.title=element_text(size = 10))

#summarizing y min and max for axis limits in following figure
predated_colonies_subset %>%  
  dplyr::reframe(min(pct_grazed), max(pct_grazed))

#second figure in set
fig_pctgrazed_taxa <- predated_colonies_subset %>%
  mutate(region= factor(region, levels = c("Panamá", "Florida",  "St. Croix", "Bonaire"))) %>%
  mutate(coral_species= factor(coral_species, levels = c("Porites astreoides", "Branching Porites spp.", "Orbicella annularis","Siderastrea siderea","Agaricia agaricites","Agaricia tenuifolia", "Madracis decactis", "Orbicella faveolata", "Agaricia humilis", "Madracis auretenra", "Agaricia spp.", "Stephanocoenia intersepta"))) %>%
  ggplot()+
  ggridges::geom_density_ridges(aes(x=pct_grazed, y=coral_species), alpha=0.7, scale=0.7)+
  geom_point(aes(x=pct_grazed, y=coral_species, color=region), size=0.7, alpha=0.6, position=jitter_nudge)+
  scale_color_manual(values=region_palette)+
  scale_fill_manual(values=region_palette)+
  scale_y_discrete(expand = c(0.1, 0), limits = rev)+ #so corals are in alphabetical order
  scale_x_continuous(trans = scales::log_trans(),
                     breaks = c(0.001,  0.01, 0.1, 1, 10, 75), 
                     labels= c(0.001, 0.01, 0.1, 1, 10, 75),
                     limits=c(0.001,75))+
  labs(x = expression(paste("Coral area preyed upon (%)")),
       y = "",
       color="Region",
       fill="Region")+
  theme_bw()+
  theme(legend.position = "top",
       axis.text.y= element_blank(),
       axis.ticks.y=element_blank(),
       axis.text.x=element_text(size = 8),
       axis.title=element_text(size = 10))

#summarizing x min and max for axis limits in following figure
predated_colonies_subset %>%  
  dplyr::reframe(min(col_area_cm2), max(col_area_cm2))

#third figure in set
fig_pctgrazed_colsize <- predated_colonies_subset %>%
  mutate(region= factor(region, levels = c("Panamá", "Florida",  "St. Croix", "Bonaire"))) %>%
  ggplot(aes(y=pct_grazed, x=col_area_cm2, color=region))+
  geom_point(size=0.8, alpha=0.75)+
  geom_smooth(method="lm")+
  scale_colour_manual(values=region_palette)+
  theme_bw()+
  labs(x = expression(paste("Coral colony surface area (", cm^2, ")")),
       y = expression(paste("Coral area preyed upon (%)")), 
       color="Region")+
  scale_y_continuous(trans = scales::log_trans(),
                     breaks = c(0.0001, 0.001, 0.01, 0.1, 1, 10, 25, 75), 
                     labels= c("0.0001", 0.001, 0.01, 0.1, 1, 10, 25, 75),
                     limits=c(0.0001,75))+
  scale_x_continuous(trans = scales::log_trans(),
                    breaks = c(5, 10, 50, 250, 1000, 5000, 20000), 
                    labels= c(5, 10, 50, 250, 1000, 5000, 20000),
                    limits=c(5,20000))+
  theme(legend.position	="none",
       axis.text.x=element_text(size = 8),
       axis.title=element_text(size = 10))

#creating combined three-panel figure
predated_coral_patterns <- ggpubr::ggarrange(fig_mean_scar_taxa, 
                                             fig_pctgrazed_taxa, 
                                             fig_pctgrazed_colsize, 
                                             ncol=3, 
                                             align="h", 
                                             common.legend = TRUE, 
                                             labels=c("a","b", "c"), 
                                             widths=c(1.5,1,1.2), 
                                             legend="top")

predated_coral_patterns

#saving as .jpg version (for presentations) and .pdf version (for publications)
ggsave(plot=predated_coral_patterns, filename=here("figures_tables/fig4_predated_coral_patterns.jpg"), width = 215, height = 80, dpi = 600, units = "mm")

ggsave(plot=predated_coral_patterns, filename=here("figures_tables/fig4_predated_coral_patterns.pdf"), width = 215, height = 80, dpi = 600, units = "mm")
```