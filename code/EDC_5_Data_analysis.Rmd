---
title: "Data analysis: Ecological drivers of parrotfish coral predation vary across spatial scales"
author: "Hannah Rempel"
date: "Last updated 2/Sep/2023"
output:
  pdf_document: default
  word_document: default
  html_document: default
---

# ___________________________________________________________________________________

#Setup: reading in and summarizing data

```{r Setting R markdown options, echo=FALSE, message=FALSE, warning=FALSE}
library(knitr)
opts_chunk$set(tidy.opts=list(width.cutoff=60),tidy=TRUE)
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=80), tidy=TRUE)
```

```{r Setup, echo=FALSE, message=FALSE}
if (!require(broom)) install.packages("broom") 
if (!require(broom.mixed)) install.packages("broom.mixed") 
if (!require(cowplot)) install.packages("cowplot") 
if (!require(DHARMa)) install.packages("DHARMa") 
if (!require(electivity)) install.packages("electivity") 
if (!require(ggpp)) install.packages("ggpp") 
if (!require(ggpubr)) install.packages("ggpubr") 
if (!require(ggridges)) install.packages("ggridges") 
if (!require(glmmTMB)) install.packages("glmmTMB") 
if (!require(here)) install.packages("here") 
if (!require(janitor)) install.packages("janitor") 
if (!require(magick)) install.packages("magick") 
if (!require(moderndive)) install.packages("moderndive") 
if (!require(tidyverse)) install.packages("tidyverse") 

packages <- c("broom", "broom.mixed", "cowplot", "DHARMa", "electivity", "ggpp", "ggpubr", "ggridges", "glmmTMB", "here", "janitor", "magick", "moderndive", "tidyverse")
sapply(packages, require, character.only = T)
```

```{r Reading in coral and scar data, message = FALSE}
fish_df <- read_csv(here("data/regional_fish_data.csv")) %>%
  mutate(region= factor(region, levels = c("Panamá", "Florida",  "St. Croix", "Bonaire"))) 

coral_scar_df <- read.csv(here("data/processed_coral_scar_data_colony_level.csv"), 
                          fileEncoding = "UTF-8") %>% #UTF-8 is compatible with accents/tildes
  mutate(region= factor(region, levels = c("Panamá", "Florida", "St. Croix", "Bonaire")))

site_coordinates <- read.csv(here("data/site_coordinates.csv"), 
                          fileEncoding = "UTF-8") %>%
  mutate(region= factor(region, levels = c("Panamá", "Florida", "St. Croix", "Bonaire")))
```

```{r Table S1: Site coordinates and sampling effort}
n_coral_surveys <- coral_scar_df %>% 
  group_by(region, site) %>% 
  distinct(transect) %>% 
  dplyr::reframe(n_coral_surveys=n())

n_surveys <- fish_df %>% 
  group_by(region, site) %>% 
  distinct(transect) %>% 
  dplyr::reframe(n_fish_surveys=n()) %>%
  left_join(n_coral_surveys, by = join_by(region, site))

table_s1 <- site_coordinates %>% 
  left_join(n_surveys)

write.csv(table_s1, 
          here("supplements/table_s1_site_coordinates_sample_size.csv"),  
          fileEncoding = "UTF-8", 
          row.names=FALSE)
```

## Summarising parrotfish density data

Parrotfish density estimates are for parrotfishes that were at least 15cm fork length. We classified major corallivores as species that, on average, take at least 1% of their foraging bites on coral: *Sc. taeniopterus, Sc. vetula, Sp. viride*. See manuscript for details. 

```{r Summary of parrotfish density data}
# Transect-level summary of fish density
major_corallivores_df <- fish_df %>% 
  filter(species %in% c("Scarus taeniopterus", "Scarus vetula", "Sparisoma viride")) %>%
  group_by(region, site, date, transect, depth_m, survey_l_m, survey_w_m) %>%
   dplyr::reframe(n_major_corallivores=n()) 

#merging data in transect-level summary of parrotfish denisty
pf_density_transect <- fish_df %>% 
  select(region, site, date, transect, depth_m, survey_l_m, survey_w_m) %>%
  mutate(survey_area_m2=survey_l_m*survey_w_m) %>% #summarizing transect metadata
  distinct() %>% 
  left_join(major_corallivores_df) %>% #adding in fish data
  mutate(n_major_corallivores = replace_na(n_major_corallivores, 0), #replacing NA with 0 for surveys with no parrotfishes
         density_major_corallivores = n_major_corallivores/survey_area_m2*100) %>% # calculating density (fish/100 m2) 
  ungroup()

# Site-level summary of fish density
pf_density_site<- pf_density_transect %>% 
  group_by(region, site) %>%
  dplyr::reframe(mean_density_major_corallivores=mean(density_major_corallivores)) %>%
  ungroup()

#function to calculate the standard error of the mean
sem <- function(x) {
  sd(x, na.rm=TRUE)/sqrt(sum(!is.na(x)))
}

# Region-level summary of fish density
regional_parrotfish_density <- pf_density_site %>%
  group_by(region) %>%
   dplyr::reframe(mean_density_major=mean(mean_density_major_corallivores),
            sem_major=sem(mean_density_major_corallivores))
```

```{r Summary of parrotfish size distributions}
#creating  df for Panamá data only (b/c in this region fish size was recorded in 5cm bins)
PAN_fish_df <- fish_df %>% 
  filter(region=="Panamá")
PAN_fish_df %>% 
  distinct(size_cm) #checking distinct of size distributions bins

#creating seperate df for all other regions, where fish size was recorded to the nearest cm
OTHER_fish_df <- fish_df %>% 
  filter(region %in% c("Florida", "St. Croix", "Bonaire")) %>%
  mutate(size_cm=as.double(size_cm))
range(OTHER_fish_df$size_cm) #checking range of size distributions

# creating a combined df of fish surveys with size in 5cm bins to compare across regions
binned_fish_sizes <- OTHER_fish_df %>% #binning fish sizes to pair with Panamá data
  mutate(size_cm=case_when(size_cm>=15 & size_cm<20 ~ "15 to 20",
                           size_cm>=20 & size_cm<25 ~ "20 to 25",
                           size_cm>=25 & size_cm<30 ~ "25 to 30",
                           size_cm>=30 & size_cm<35 ~ "30 to 35",
                           size_cm>=35 & size_cm<40 ~ "35 to 40")) %>%
  bind_rows(PAN_fish_df) %>% #adding panama data
  filter(species!="No parrotfishes") %>% #removing transects with no parrotfishes observed
  mutate(size_cm= factor(size_cm, levels = c("15 to 20", "20 to 25", "25 to 30", "30 to 35", "35 to 40"))) %>%
  mutate(region= factor(region, levels = c("Panamá", "Florida",  "St. Croix", "Bonaire"))) %>%
  filter(species %in% c("Scarus taeniopterus", "Scarus vetula", "Sparisoma viride")) #major corallivores

# First step of transect-level summary of fish density by species and size bin 
#This df doesn't account for 0 observations, that's done in the next section
pf_by_size_species_df_temp <- binned_fish_sizes %>% 
  group_by(region, site, date, transect, depth_m, species, size_cm) %>%
   dplyr::reframe(n=n()) 

# transect-level summary of fish density by species and size bin
size_cm <- c("15 to 20", "20 to 25", "25 to 30", "30 to 35", "35 to 40")
species <- c("Scarus taeniopterus", "Scarus vetula", "Sparisoma viride")

pf_by_transect_size_species_df <- fish_df %>% 
  mutate(survey_area_m2=survey_l_m*survey_w_m) %>% #summarizing transect metadata
  select(region, site, date, transect, depth_m, survey_area_m2) %>%
  distinct() %>% #filtering to only keep distinct transect metadata
  tidyr::crossing(species, size_cm) %>% #adding all unique combos of transects, species, and size bins
  left_join(pf_by_size_species_df_temp) %>% #adding in all observations of species abundance by size bins
  mutate(n=replace_na(n, 0)) #adding 0s for instances where a given species and size was not observed in a transect 

# site-level summary of fish density by size bin (does not include species)
pf_by_site_size_df <- pf_by_transect_size_species_df %>% 
  dplyr::mutate(pf_density_100m2 = n/survey_area_m2*100) %>% #summarizing density (n/100 m2) 
  group_by(region, site, size_cm) %>%
  dplyr::reframe(mean_pf_density_100m2=mean(pf_density_100m2)) %>%
  ungroup() %>%
  mutate(size_cm= factor(size_cm, levels = c("15 to 20", "20 to 25", "25 to 30", "30 to 35", "35 to 40")))

# region-level summary of fish density by species and size bin
pf_by_region_size_species_df <- pf_by_transect_size_species_df %>% 
  dplyr::mutate(pf_density_100m2 = n/survey_area_m2*100) %>% #summarizing density (n/100 m2) 
  group_by(region, species, size_cm) %>%
  dplyr::reframe(mean_pf_density_100m2=mean(pf_density_100m2)) %>%
  ungroup()
```

## Summarising coral and scar data

```{r Summary of coral and scar data, echo=FALSE, message=FALSE}
# Transect and genus-level summary of coral data
coral_transect_and_genus <- coral_scar_df %>% 
    mutate(coral_genus=gsub("\\s.*", "", coral_species),
         coral_genus=case_when(coral_genus=="Branching"~"Porites",
                               TRUE~as.character(coral_genus))) %>%
  mutate(proportion_grazed=total_grazed_cm2/col_area_cm2) %>%
  group_by(region, site, transect, depth_m, coral_genus) %>%
   dplyr::reframe(genus_total_col_area_cm2=sum(col_area_cm2),
            genus_total_scar_area_cm2=sum(total_grazed_cm2),
            genus_total_n_scars=sum(n_new_scars),
            mean_proportion_grazed=mean(proportion_grazed)) %>%
  mutate(pct_coral_cover_by_genera=(genus_total_col_area_cm2/300000)*100,
         scars_m2_coral_by_genera=genus_total_n_scars/(genus_total_col_area_cm2/10000),
         pct_coral_grazed_by_genera=(genus_total_scar_area_cm2/genus_total_col_area_cm2)*100) %>%
  ungroup()

# Transect-level summary of coral data
coral_transect <- coral_scar_df %>% 
  mutate(proportion_grazed=total_grazed_cm2/col_area_cm2) %>%
  group_by(region, site, transect, depth_m) %>%
   dplyr::reframe(total_col_area_cm2=sum(col_area_cm2),
            total_scar_area_cm2=sum(total_grazed_cm2),
            total_n_scars=sum(n_new_scars),
            mean_proportion_grazed=mean(proportion_grazed),
            n_colonies=n()) %>%
  mutate(pct_coral_cover=(total_col_area_cm2/300000)*100,
         scars_m2_coral=total_n_scars/(total_col_area_cm2/10000),
         pct_coral_grazed=(total_scar_area_cm2/total_col_area_cm2)*100) %>%
  ungroup()

# Site-level summary of coral data
coral_site <- coral_transect %>%
  group_by(region, site) %>%
   dplyr::reframe(mean_pct_coral_cover=mean(pct_coral_cover),
            sem_coral_cover=sem(pct_coral_cover),
            mean_pct_coral_grazed=mean(pct_coral_grazed),
            sem_pct_grazed=sem(pct_coral_grazed),
            mean_scars_m2_coral= mean(scars_m2_coral),
            sem_scar_density=sem(scars_m2_coral)) %>%
  ungroup()

# Regional summary of coral data
regional_coral_scar_patterns <- coral_site %>%
  group_by(region) %>%
   dplyr::reframe(mean_coral_cover=mean(mean_pct_coral_cover),
            sem_cover=sem(mean_pct_coral_cover),
            mean_scar_density=mean(mean_scars_m2_coral),
            sem_density=sem(mean_scars_m2_coral),
            mean_coral_area_grazed=mean(mean_pct_coral_grazed),
            sem_area_grazed=sem(mean_pct_coral_grazed))

# Regional summary mean scar size for grazed colonies
mean_scar_size_by_region <- coral_scar_df %>% 
  filter(mean_scar_area_cm2>0) %>%
  group_by(region) %>%
  dplyr::reframe(mean_scar_size_cm2=mean(mean_scar_area_cm2), #regional mean calculated from mean scar size per colony with grazing scars
                 sem_scar_size=sem(mean_scar_area_cm2)) 
```

```{r Merging site-level fish and coral data, message=FALSE}
fish_corals_site_level <- coral_site %>% 
  left_join(pf_density_site) %>%
  mutate(region= factor(region, levels = c("Panamá", "Florida",  "St. Croix", "Bonaire"))) 
```

All palettes have been checked in a colorblindness simulator ([link](https://davidmathlogic.com/colorblind/))
```{r Color palettes for figures, include=FALSE, echo=FALSE}
parrotfish_palette <- c("#6DF3DC", "#4BCAB0", "#0D8A87", "#014D4E")

parrotfish_size_palette <- c("#6DF3DC", "#56CBB3", "#199E8F", "#067F7C", "#014D4E")

coral_palette <- c("#EF977F", "#DA5849", "#C92741", "#9E1831")

region_palette <- c("#00B1EA", "#FE4248", "#8266FF", "#520E44") 
```

# ___________________________________________________________________________________

#Variation in corallivory intensity and coral selectivity among regions

##Summarizing and visualizing regional trends

**Table 1.** Regional means ± S.E. of major corallivore density, cover of coral species targeted by parrotfishes (%), scar density, mean scar area on predated corals, and mean coral colony area predated (%). 
```{r Table 1: Regional patterns in parrotfish density + coral cover + corallivory intensity}
regional_parrotfish_coral_scar_summary <- regional_parrotfish_density %>% 
  left_join(regional_coral_scar_patterns, by = join_by(region)) %>% 
  left_join(mean_scar_size_by_region, by = join_by(region)) %>%
  mutate_at(2:7, round, 1) %>% 
  mutate_at(8:11, round, 3)

write.csv(regional_parrotfish_coral_scar_summary, here("figures_tables/table1_regional_patterns.csv"),
          fileEncoding = "UTF-8", 
          row.names=FALSE)
```

```{r Summarizing data at site-level for visualization, message=FALSE}
regional_vars_graph_df <- pf_density_transect %>%
  group_by(region, site) %>%
   dplyr::reframe(pf_n_100m2_major=mean(density_major_corallivores),
            sem_major_corallivores=plotrix::std.error(density_major_corallivores)) %>%
  left_join(coral_site, by = join_by(region, site)) 
```

```{r Fig. 2: parrotfish + coral + corallivory patterns across sites and regions, echo=FALSE, message=FALSE}
#summarizing data for visualization
regional_vars_graph_df <- pf_density_transect %>%
  group_by(region, site) %>%
   dplyr::reframe(pf_n_100m2_major=mean(density_major_corallivores),
            sem_major_corallivores=plotrix::std.error(density_major_corallivores)) %>%
  left_join(coral_site, by = join_by(region, site)) 

#Fig 2a) parrotfish density patterns
fig2a_parrotfish_density <- ggplot()+
  geom_point(data=pf_density_transect, aes(y=fct_rev(site), x=density_major_corallivores, color=region), alpha=0.5)+
  geom_pointrange(data=regional_vars_graph_df,
                  aes(y = fct_rev(site),
                      x=pf_n_100m2_major,
                      xmin=pf_n_100m2_major-sem_major_corallivores, 
                      xmax=pf_n_100m2_major+sem_major_corallivores,
                      fill=region),
                  color="black", pch=21, size=0.5)+
  scale_x_continuous(limits = c(0, 17), expand = c(0.025, 0)) + 
  scale_color_manual(values = parrotfish_palette) + 
  scale_fill_manual(values = parrotfish_palette) + 
  facet_grid(rows = vars(region), scales = "free_y", switch = "y", space = "free") +
  labs(title = "a",  x = expression(paste("Major corallivores (n 100 ", m^-2, ")"))) +
  theme_bw()+
  theme(axis.title.x = element_text(margin = margin(t = 1.1, r = 0, b = 0, l = 0, unit = "mm")),
        plot.title = element_text(size = 12, face = "bold"),
        strip.text.y = element_text(angle = 270, face = "bold"),
        strip.placement = "outside",
        axis.title.y = element_blank(),
        strip.text = element_text(size = 10, margin = margin(t = 1.5, r = 1.5, b = 1.5, l = 1.5, unit = "mm")),
        axis.text = element_text(size = 10),
        legend.position = "none")

#Fig 2b) coral cover patterns
fig2b_coral_cover <- ggplot() +
  geom_point(data=coral_transect, aes(y=fct_rev(site), x=pct_coral_cover, color=region), alpha=0.5)+
  geom_pointrange(data=regional_vars_graph_df,
                  aes(y = fct_rev(site),
                      x=mean_pct_coral_cover,
                      xmin=mean_pct_coral_cover-sem_coral_cover, 
                      xmax=mean_pct_coral_cover+sem_coral_cover,
                      fill=region),
                  color="black", pch=21, size=0.5)+
  scale_x_continuous(limits = c(0, 65), expand = c(0.025, 0)) +
  scale_fill_manual(values = coral_palette) + 
  scale_color_manual(values = coral_palette) +
  facet_grid(rows = vars(region), scales = "free_y", switch = "y", space = "free") +
  labs(title = "b", x = "Target coral cover (%)") +
  theme_bw()+
  theme(axis.title.x = element_text(margin = margin(t = 2.2, r = 0, b = 0.8, l = 0, unit = "mm")),
        plot.title = element_text(size = 12, face = "bold"),
        plot.margin = margin(0.2, 0.2, 0.2, 0.2, unit = "cm"),
        strip.background = element_blank(),
        strip.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.x = element_text(size = 10),
        legend.position = "none")

# Fig 2c) scar density patterns w/ log transformation 
# log transformed +0.1 to visualize patterns across regions better given extremely high corallivory intensity in Florida
fig2c_scar_density_transformed <- ggplot() +
  #transect-level data contain 0's. To visualize with a log-transformed scale, 0.1 is added
geom_point(data=coral_transect, aes(y=fct_rev(site), x=(scars_m2_coral+0.1), color=region), alpha=0.5)+
  #adding 0.1 to site means to transform in the same way as the transect-level data and b/c there are two sites w/ >0 but <1 densities and when the SEM is subtracted these values become negative. The transfomation sets the bounds of the SEM at 0 for visualization purposes.
 geom_pointrange(data=regional_vars_graph_df,
                 aes(y = fct_rev(site),
                     x=(mean_scars_m2_coral+0.1),
                     xmin=(mean_scars_m2_coral+0.1)-sem_scar_density,
                     xmax=(mean_scars_m2_coral+0.1)+sem_scar_density,
                     fill=region),
                 color="black", pch=21, size=0.5)+
  scale_x_continuous(trans = scales::log_trans(),
                     breaks= c(0.1, 1, 5, 25, 100, 250),
                     labels= c("0", 1, 5, 25, 100, 250)
                     )+
  scale_fill_manual(values = coral_palette) + #specified hex codes for plot colors
  scale_color_manual(values = coral_palette) + #specified hex codes for plot colors
  facet_grid(rows = vars(region), scales = "free_y", switch = "y", space = "free") +
  labs(title = "c", x = expression(paste("Scar density (n ", m^-2, " coral)")))+
  theme_bw()+
  theme(axis.title.x = element_text(margin = margin(t = 1.1, r = 0, b = 0, l = 0, unit = "mm")),
        plot.title = element_text(size = 12, face = "bold"),
        strip.text.y = element_text(angle = 270, face = "bold"),
        strip.placement = "outside",
        axis.title.y = element_blank(),
        strip.text = element_text(size = 10, margin = margin(t = 1.5, r = 1.5, b = 1.5, l = 1.5, unit = "mm")),
        axis.text = element_text(size = 10),
        legend.position = "none")

##Fig 2c) scar density patterns (not on a log transformed scale)
# fig2c_scar_density <- ggplot() +
#   geom_point(data=coral_transect, aes(y=fct_rev(site), x=scars_m2_coral, color=region), alpha=0.5)+
#   geom_pointrange(data=regional_vars_graph_df,
#                   aes(y = fct_rev(site),
#                       x=mean_scars_m2_coral,
#                       xmin=mean_scars_m2_coral-sem_scar_density, 
#                       xmax=mean_scars_m2_coral+sem_scar_density,
#                       fill=region),
#                   color="black", pch=21, size=0.5)+
#   scale_x_continuous(limits = c(0, 268), expand = c(0.025, 0)) +
#   scale_fill_manual(values = coral_palette) + #specified hex codes for plot colors
#   scale_color_manual(values = coral_palette) + #specified hex codes for plot colors
#   facet_grid(rows = vars(region), scales = "free_y", switch = "y", space = "free") +
#   labs(title = "c", x = expression(paste("Scar density (n ", m^-2, " coral)")))+
#   theme_bw()+
#   theme(axis.title.x = element_text(margin = margin(t = 1.1, r = 0, b = 0, l = 0, unit = "mm")),
#         plot.title = element_text(size = 12, face = "bold"),
#         strip.text.y = element_text(angle = 270, face = "bold"),
#         strip.placement = "outside",
#         axis.title.y = element_blank(),
#         strip.text = element_text(size = 10, margin = margin(t = 1.5, r = 1.5, b = 1.5, l = 1.5, unit = "mm")),
#         axis.text = element_text(size = 10),
#         legend.position = "none")

#Fig 2d) percent coral grazed patterns
# log transformed +0.01 to visualize patterns across regions better given extremely high corallivory intensity in Florida
#used log +0.01 instead of 0.1 because the percent predated had a far smaller range of values (up to ~1.5%) compared to density (up to ~250)
fig2d_percent_scar_area_transformed <- ggplot() +
  geom_point(data=coral_transect, aes(y=fct_rev(site), x=(pct_coral_grazed+0.01), color=region), alpha=0.5)+
  geom_pointrange(data=regional_vars_graph_df,
                  aes(y = fct_rev(site),
                      x=(mean_pct_coral_grazed+0.01),
                      xmin=(mean_pct_coral_grazed+0.01)-sem_pct_grazed, 
                      xmax=(mean_pct_coral_grazed+0.01)+sem_pct_grazed,
                      fill=region),
                  color="black", pch=21, size=0.5)+
  scale_x_continuous(trans = scales::log_trans(),
                     breaks= c(0.01, 0.05, 0.1, 0.25, 0.5, 1),
                     labels= c("0", 0.05, 0.1, 0.25, 0.5, 1)
                     )+
  scale_fill_manual(values = coral_palette) +
  scale_color_manual(values = coral_palette) + 
  facet_grid(rows = vars(region), scales = "free_y", switch = "y", space = "free") +
  labs(title = "d", x = "Coral area predated (%)") +
  theme_bw()+
  theme(axis.title.x = element_text(margin = margin(t = 2.2, r = 0, b = 0.8, l = 0, unit = "mm")),
        plot.title = element_text(size = 12, face = "bold"),
        plot.margin = margin(0.2, 0.2, 0.2, 0.2, unit = "cm"),
        strip.background = element_blank(),
        strip.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.x = element_text(size = 10),
        legend.position = "none")

##Fig 2d) percent coral grazed patterns (not on a log transformed scale)
# fig2d_percent_scar_area <- ggplot() +
#   geom_point(data=coral_transect, aes(y=fct_rev(site), x=pct_coral_grazed, color=region), alpha=0.5)+
#   geom_pointrange(data=regional_vars_graph_df,
#                   aes(y = fct_rev(site),
#                       x=mean_pct_coral_grazed,
#                       xmin=mean_pct_coral_grazed-sem_pct_grazed, 
#                       xmax=mean_pct_coral_grazed+sem_pct_grazed,
#                       fill=region),
#                   color="black", pch=21, size=0.5)+
#   scale_x_continuous(limits = c(0, 1.5), expand = c(0.025, 0)) +
#   scale_fill_manual(values = coral_palette) +
#   scale_color_manual(values = coral_palette) + 
#   facet_grid(rows = vars(region), scales = "free_y", switch = "y", space = "free") +
#   labs(title = "d", x = "Coral area predated (%)") +
#   theme_bw()+
#   theme(axis.title.x = element_text(margin = margin(t = 2.2, r = 0, b = 0.8, l = 0, unit = "mm")),
#         plot.title = element_text(size = 12, face = "bold"),
#         plot.margin = margin(0.2, 0.2, 0.2, 0.2, unit = "cm"),
#         strip.background = element_blank(),
#         strip.text.y = element_blank(),
#         axis.title.y = element_blank(),
#         axis.text.y=element_blank(),
#         axis.ticks.y=element_blank(),
#         axis.text.x = element_text(size = 10),
#         legend.position = "none")

#reading in coral and parrotfish icon for figure graphics
coral_icon <- orbicella_image <- magick::image_read(path=here("figures_tables/reef_images", "Orbicella_annularis.png"), density = NULL, depth = NULL, strip = TRUE)

corallivory_icon <- orbicella_image <- magick::image_read(path=here("figures_tables/reef_images", "Orbicella_annularis_grazed.png"), density = NULL, depth = NULL, strip = TRUE)

major_corallivore_icon <- magick::image_read(path=here("figures_tables/reef_images", "Major_corallivores.png"), density = NULL, depth = NULL, strip = TRUE)

#Combining individual graph into one: top panel (a-b)
fig2a_b <- ggpubr::ggarrange(fig2a_parrotfish_density, fig2b_coral_cover,
                                                      ncol=2,
                                                      widths=c(1.48, 1), #so graph widths are same size
                                                      align = "h")

#adding parrotfish and coral graphics to base figure
fig2a_b_with_graphics <- cowplot::ggdraw() +
  draw_plot(fig2a_b)+ #adds the plot (order matters to overlay the layers correctly)
  draw_image(major_corallivore_icon,  x = 0.027, y = 0.379, scale=0.1) + #adds the major pf icon
  draw_image(coral_icon, x = 0.45, y = 0.379, scale=0.08) #adds the coral

#bottom panel (c-d)
fig2c_d <- ggpubr::ggarrange(fig2c_scar_density_transformed, 
                                            fig2d_percent_scar_area_transformed,
                                            ncol=2,
                                            widths=c(1.48, 1), #adjusting graph widths to be the same size
                                            align = "h")

#adding corallivory graphics to base figure
fig2c_d_with_graphics <- cowplot::ggdraw() +
  draw_plot(fig2c_d)+ #adds the plot (order matters to overlay the layers correctly)
  draw_image(corallivory_icon,  x = 0.05, y = 0.379, scale=0.08)+ #adds the coral
  draw_image(corallivory_icon,  x = 0.45, y = 0.379, scale=0.08) #adds the coral to e

#combining figure into a four panel plot
fig2_final <- ggpubr::ggarrange(fig2a_b_with_graphics, 
                                fig2c_d_with_graphics,
                                nrow=2,
                                align = "h")

ggsave(plot=fig2_final, 
       filename=here("figures_tables/fig2_site_level_patterns.jpg"), 
       width = 215, height = 250, dpi = 600, units = "mm") 

fig2_final
```

**Fig. 2.** Site-level means (points with black outlines) ± S.E. of the (a) density of major corallivorous parrotfishes, (b) cover of coral species targeted by parrotfishes, (c) density of parrotfish predation scars, and (d) coral area predated. Raw data points are shown transparently in the background.

```{r Fig. S1: parrotfish density by size range and species}
figs1_pf_size_dist <- pf_by_region_size_species_df %>% 
  ggplot()+
  geom_bar(aes(x=size_cm, y=mean_pf_density_100m2, fill=species), position="stack", stat="identity")+
  facet_wrap(~region, nrow=4)+
  scale_fill_manual(values = parrotfish_palette)+
  labs(x="Size (cm)", y = expression(paste("Major corallivores (n 100 ", m^-2, ")")), fill="Species") +
  ylim(0,3)+
  theme_bw()+
  theme(strip.text.x = element_text(face = "bold", size = 10),
        legend.text = element_text(face = "italic", size = 10),
        axis.text = element_text(size = 10),
        legend.position = "right")

ggsave(plot=figs1_pf_size_dist, 
       filename=here("supplements/fig_s1_parrotfish_density_by_size_species.jpg"), 
       width = 215, height = 200, dpi = 600, units = "mm") 

figs1_pf_size_dist
```
**Fig. S1.** Regional mean density of major corallivorous parrotfishes by species and body size in 5 cm bins for individuals ≥15 cm fork length. We conducted 2 to 32 fish density surveys per site stratified across depths ranging from ~1.5 to 18 m (Table S1), then averaged site-level data to calculate regional mean densities.

```{r Fig. S2: parrotfish density by size range and site}
figs2_pf_size_dist_by_site <- pf_by_site_size_df %>% 
  ggplot()+
  geom_bar(aes(x=mean_pf_density_100m2, y=fct_rev(site), fill=fct_rev(size_cm)), position="stack", stat="identity")+
  facet_grid(rows = vars(region), scales = "free_y", switch = "y", space = "free") +
  labs(x= expression(paste("Major corallivores (n 100 ", m^-2, ")")), fill="Size (cm)", y="") +
  xlim(0,3)+
  theme_bw()+
  scale_fill_manual(values = rev(parrotfish_size_palette)) +
  scale_x_continuous(limits = c(0, 3), expand = c(0.025, 0)) + #removing extra white space on left
   guides(fill=guide_legend(reverse=TRUE))+
  theme(axis.title.x = element_text(margin = margin(t = 1.1, r = 0, b = 0, l = 0, unit = "mm")),
        plot.title = element_text(size = 12, face = "bold"),
        strip.text.y = element_text(angle = 270, face = "bold"),
        strip.placement = "outside",
        axis.title.y = element_blank(),
        strip.text = element_text(size = 10, margin = margin(t = 1.5, r = 1.5, b = 1.5, l = 1.5, unit = "mm")),
        axis.text = element_text(size = 10),
        legend.position = "top")

ggsave(plot=figs2_pf_size_dist_by_site, 
       filename=here("supplements/fig_s2_parrotfish_density_by_size_site.jpg"), 
       width = 215, height = 200, dpi = 600, units = "mm") 

figs2_pf_size_dist_by_site
```
**Fig. S2.** Site-level mean density of major corallivorous parrotfishes by body size in 5 cm bins for individuals ≥15 cm fork length. We conducted 2 to 32 fish density surveys per site stratified across depths ranging from ~1.5 to 18 m (Table S1), then averaged transect-level data to calculate site-level mean densities.
       
##Analysis of regional trends

Kruskal-Wallis tests of the density of major corallivores and  target coral cover (%), with post-hoc Dunn’s tests of pairwise comparisons among regions using the Benjamini-Hochberg correction for multiple comparisons.

```{r Data analysis: KW test of parrotfish density and coral cover by region}
#corallivore density ~ region has a non-normal distribution of the residual
rstatix::shapiro_test(residuals(aov(mean_density_major_corallivores~region, data = fish_corals_site_level))) #data violate normality assumption
fish_corals_site_level %>% rstatix::levene_test(mean_density_major_corallivores ~ region) 

#coral cover ~ region has a non-normal homogeneity of variance
rstatix::shapiro_test(residuals(aov(mean_pct_coral_cover~region, data = fish_corals_site_level))) 
fish_corals_site_level %>% rstatix::levene_test(mean_pct_coral_cover ~ region) #data violate homogeneity of variance assumption

#Kruskal-Wallis test of corallivore density by region and post-hoc Dunn test
KW_test_major_corallivore_density <- kruskal.test(mean_density_major_corallivores ~ region, data=fish_corals_site_level) %>% 
  tidy() 
KW_test_major_corallivore_density

Dunn_test_major_corallivore_density <- fish_corals_site_level %>% 
  rstatix::dunn_test(mean_density_major_corallivores ~ region, p.adjust.method = "BH", detailed = FALSE) 
Dunn_test_major_corallivore_density

#Kruskal-Wallis test of coral cover by region and post-hoc Dunn test
KW_test_coral_cover <- kruskal.test(mean_pct_coral_cover ~ region, data=fish_corals_site_level) %>% 
  tidy() 
KW_test_coral_cover

Dunn_test_coral_cover <- fish_corals_site_level %>% 
  rstatix::dunn_test(mean_pct_coral_cover ~ region, p.adjust.method = "BH", detailed = FALSE) 
Dunn_test_coral_cover 
```

**Model:** ANOVA of regional variation in natural-log transformed scar density, with a Tukey Honest Significant Differences post-hoc comparison for significant differences. 

```{r Data analysis: ANOVA of scar density by region}
model_scar_density_region <- aov(log(mean_scars_m2_coral)~region, data = fish_corals_site_level)

#Testing model assumptions: outliers by region via IQR method (none)
fish_corals_site_level %>%
  group_by(region) %>%
  mutate(lm_mean_scars_m2_coral=log(mean_scars_m2_coral)) %>%
  rstatix::identify_outliers(lm_mean_scars_m2_coral)

#Testing model assumptions: no significant violations of homogeneity of variance
fish_corals_site_level %>%
  mutate(lm_mean_scars_m2_coral=log(mean_scars_m2_coral)) %>% 
  rstatix::levene_test(lm_mean_scars_m2_coral ~ region)

#Testing model assumptions: no significant violations of normality assumption by region
fish_corals_site_level %>%
  group_by(region) %>%
  mutate(lm_mean_scars_m2_coral=log(mean_scars_m2_coral)) %>%
  rstatix::shapiro_test(lm_mean_scars_m2_coral)

#Testing model assumptions: no significant violations of normality assumption for overall model
rstatix::shapiro_test(residuals(model_scar_density_region))

#Testing model assumptions: visual assessment of residuals
plot(model_scar_density_region) 

#Model meets assumptions, so proceeding with interpreting model output
summary(model_scar_density_region)

#Testing for pairwise differences in scar density by region and estimated marginal means
TukeyHSD(model_scar_density_region) %>% broom::tidy()
```

**Model:** KW  of regional variation in natural-log percent coral area grazed, with a Dunn's test for post-hoc comparisons. 

```{r Data analysis: ANOVA of percent area grazed by region}
model_pct_grazed_region <- aov(log(mean_pct_coral_grazed)~region, data = fish_corals_site_level)

#Testing model assumptions: significant violations of normality assumption for overall model
rstatix::shapiro_test(residuals(model_pct_grazed_region))

#Testing model assumptions: significant violations of normality assumption by region for St. Croix
fish_corals_site_level %>%
  group_by(region) %>%
  mutate(lm_mean_pct_coral_grazed=log(mean_pct_coral_grazed)) %>%
  rstatix::shapiro_test(lm_mean_pct_coral_grazed)

#Testing model assumptions: outliers by region via IQR method (Teague Bay in St. Croix sig. outlier)
fish_corals_site_level %>%
  group_by(region) %>%
  mutate(lm_mean_pct_coral_grazed=log(mean_pct_coral_grazed)) %>%
  rstatix::identify_outliers(lm_mean_pct_coral_grazed)

#Testing model assumptions: no significant violations of homogeneity of variance
fish_corals_site_level %>% mutate(ln_mean_pct_coral_grazed=log(mean_pct_coral_grazed)) %>% rstatix::levene_test(ln_mean_pct_coral_grazed ~ region) 

#Using non-parametric test instead due to normality violations
#Kruskal-Wallis test of percent coral grazed by region and post-hoc Dunn test
KW_test_pct_coral_grazed <- kruskal.test(mean_pct_coral_grazed ~ region, data=fish_corals_site_level) %>% 
  tidy() 
KW_test_pct_coral_grazed

#post hoc test
Dunn_test_pct_coral_grazed <- fish_corals_site_level %>% 
  rstatix::dunn_test(mean_pct_coral_grazed ~ region, p.adjust.method = "BH", detailed = FALSE) 
Dunn_test_pct_coral_grazed 
```

## Coral selectivty by region

We calculated genus-based elecitivity across regions using Vanderploeg and Scavia's E * index. We compared both abundance-based elecitity (scar abundance to coral abundance) and area-based elecitivty (scar area to coral area).

```{r Summarizing coral genera selectivity by region}
#raw selectivity data
selectivity_df_genus <- coral_scar_df %>%
  mutate(coral_genus=gsub("\\s.*", "", coral_species),
         coral_genus=case_when(coral_genus=="Branching"~"Porites",
                               TRUE~as.character(coral_genus))) %>%
  group_by(region, site, coral_genus) %>%
   dplyr::reframe(total_n_scars=sum(n_new_scars),
                  total_n_colonies=n(),
                  total_scar_area=sum(total_grazed_cm2),
                  total_colony_area=sum(col_area_cm2)) %>%
  #Vanderploeg and Scavia’s relativised electivity, E*
  mutate(n_elect_vs= electivity::vs_electivity(total_n_scars, total_n_colonies),
         area_elect_vs= electivity::vs_electivity(total_scar_area, total_colony_area),
         percent_cover=(total_colony_area/300000)*100) %>%
  mutate(region_short=case_when(region=="Panamá"~"PAN",
                                region=="St. Croix"~"STX",
                                region=="Florida"~"FLA",
                                region=="Bonaire"~"BON",
                                TRUE~as.character(region)),
         region_short=factor(region_short, levels = c("PAN", "FLA", "STX", "BON")))

#mean selectivity and 95% confidence intervals
selectivity_summary_stats_genus <- selectivity_df_genus %>%
  group_by(region, region_short, coral_genus) %>%
   dplyr::reframe(mean_n_elect_vs=mean(n_elect_vs),
                  sd_n_elect_vs= sd(n_elect_vs), 
                  mean_area_elect_vs=mean(area_elect_vs),
                  sd_area_elect_vs= sd(area_elect_vs),
                  n=n()) %>%
  #calculating mean and 95% CI
  mutate(ci_lower_n_elect=mean_n_elect_vs-(qnorm(0.975)*sd_n_elect_vs/sqrt(n)),
         ci_upper_n_elect=mean_n_elect_vs+(qnorm(0.975)*sd_n_elect_vs/sqrt(n)),
         ci_lower_area_elect=mean_area_elect_vs-(qnorm(0.975)*sd_area_elect_vs/sqrt(n)),
         ci_upper_area_elect=mean_area_elect_vs+(qnorm(0.975)*sd_area_elect_vs/sqrt(n))) %>%
  #limiting bounds to between -1 and 1 (as values beyond this have no meanining in the electivity index)
  mutate(ci_lower_n_elect=case_when(ci_lower_n_elect < -1 ~ -1,
                                    TRUE~as.double(ci_lower_n_elect)),
         ci_upper_n_elect=case_when(ci_upper_n_elect > 1 ~ 1,
                                    TRUE~as.double(ci_upper_n_elect)),
         ci_lower_area_elect=case_when(ci_lower_area_elect < -1 ~ -1,
                                    TRUE~as.double(ci_lower_area_elect)),
         ci_upper_area_elect=case_when(ci_upper_area_elect > 1 ~ 1,
                                    TRUE~as.double(ci_upper_area_elect))) %>%
  #determing significance (sig. avoidance if 95% CIs are <0, sig. preference if >0, neutral if the 95% CI crosses 0)
  mutate(abundance_selectivity_sig=case_when(ci_lower_n_elect <0 & ci_upper_n_elect>0~"NS",
                                   ci_lower_n_elect <0 & ci_upper_n_elect<0~"Avoidance",
                                   ci_lower_n_elect >0 & ci_upper_n_elect>0~"Preference"),
         area_selectivity_sig=case_when(ci_lower_area_elect <0 & ci_upper_area_elect>0~"NS",
                                   ci_lower_area_elect <0 & ci_upper_area_elect<0~"Avoidance",
                                   ci_lower_area_elect >0 & ci_upper_area_elect>0~"Preference")) 

#creating longer form selectivity summary stats and raw data
abundance_subset_genus <- selectivity_summary_stats_genus %>%
  select(region_short, coral_genus, mean_electivity=mean_n_elect_vs, ci_lower=ci_lower_n_elect, ci_upper=ci_upper_n_elect) %>%
  mutate(metric="Abundance-based")

area_subset_genus <-selectivity_summary_stats_genus %>%
  select(region_short, coral_genus, mean_electivity=mean_area_elect_vs, ci_lower=ci_lower_area_elect, ci_upper=ci_upper_area_elect) %>%
  mutate(metric="Area-based")
 
combined_selectivity_summary_genus <- bind_rows(abundance_subset_genus, area_subset_genus) %>%
  mutate(interpretation=case_when(ci_lower<0 & ci_upper<0~"Avoidance",
                                  ci_lower>0 & ci_upper>0~"Preference",
                                  ci_lower>0 & ci_upper<0 ~"NS",
                                  ci_lower<0 & ci_upper>0 ~"NS"))

selectivity_raw_genus <- selectivity_df_genus %>%
  ungroup() %>%
  select(region_short, site, coral_genus, n_elect_vs, area_elect_vs) %>%
  pivot_longer(n_elect_vs:area_elect_vs, names_to = "index", values_to="electivity") %>%
  mutate(metric=case_when(grepl("n_elect", index)~"Abundance-based",
                          grepl("area_elect", index)~"Area-based")) %>%
  select(-index) 
```

```{r Fig. 3: Coral genera selectivity by site and region, fig.height = 4.33, fig.width = 8.46}
#creating preliminary figure
selectivity_genus_temp <- ggplot()+
  geom_point(data=selectivity_raw_genus, aes(y=region_short, x=electivity, color=region_short), alpha=0.5, position=position_jitter(height=0.1))+ #raw data points
    geom_pointrange(data=combined_selectivity_summary_genus, aes(y=region_short, x=mean_electivity, xmin=ci_lower, xmax=ci_upper, fill=region_short), color="black", pch=21, size=0.5)+ #mean and 95% CI
  scale_x_discrete(limits = rev)+ #so regions are in same order as in previous figs
  scale_colour_manual(values=region_palette)+
  scale_fill_manual(values=region_palette)+
  xlim(-1.1,1.1)+ #slightly larger than -1 and 1 so that jitter isn't out of bounds
  geom_vline(xintercept=0,linetype=2)+ #dashed line at 0 (no electivity)
  theme_bw()+
  labs(x="V.S. relativized electivity (E*)", y="Region")+
  facet_grid(metric~coral_genus)+ 
  coord_flip()+ 
  theme(legend.position = "none")

#reading in coral genus icons
agaricia_image <- magick::image_read(path=here("figures_tables/reef_images", "Agaricia_tenuifolia.png"), density = NULL, depth = NULL, strip = TRUE)
madracis_image <- magick::image_read(path=here("figures_tables/reef_images", "Madracis_decactis.png"), density = NULL, depth = NULL, strip = TRUE)
orbicella_image <- magick::image_read(path=here("figures_tables/reef_images", "Orbicella_annularis.png"), density = NULL, depth = NULL, strip = TRUE)
porites_image <- magick::image_read(path=here("figures_tables/reef_images", "Porites_astreoides.png"), density = NULL, depth = NULL, strip = TRUE)
siderastrea_image <- magick::image_read(path=here("figures_tables/reef_images", "Siderastrea_siderea.png"), density = NULL, depth = NULL, strip = TRUE)
stephanocinea_image <- magick::image_read(path=here("figures_tables/reef_images", "Stephanocoenia_intersepta.png"), density = NULL, depth = NULL, strip = TRUE)

#adding coral images to figure (image placement is off in R, but good in ggsave generated png)
selectivity_genus_final <- cowplot::ggdraw() +
  draw_plot(selectivity_genus_temp)+ #adds the plot (order matters to overlay the layers correctly)
  draw_image(agaricia_image, x = -0.32, y = 0.385, scale=0.11)+
  draw_image(madracis_image, x = -0.17, y = 0.385, scale=0.082)+
  draw_image(orbicella_image, x = -0.02, y = 0.38, scale=0.064)+
  draw_image(porites_image, x = 0.13, y = 0.386, scale=0.059)+
  draw_image(siderastrea_image, x = 0.28, y = 0.387, scale=0.049)+
  draw_image(stephanocinea_image, x = 0.429, y = 0.387, scale=0.059)

 #saving figure
ggsave(plot=selectivity_genus_final, filename=here("figures_tables/fig3_selectivity_by_genera.jpg"), width = 215, height = 110, dpi = 600, units = "mm")

selectivity_genus_final
```

**Fig. 3.** Mean Vanderploeg and Scavia’s relativized electivity by region (point with black outline) ± 95% C.I. for genera of targeted corals across Panamá, Florida, St. Croix, and Bonaire. Electivity was calculated based on scar abundance relative to coral abundance (top panel) and scar area relative to coral area (bottom panel). Site-level values are shown transparently in the background. Positive values indicate a preference, values crossing 0 indicate random feeding, and negative values indicate avoidance. 

```{r Summarizing predation intensity by coral species}
#Total number of colonies grazed (for coral taxa with 3+ predated cols across observations)
n_grazed_cols <- coral_scar_df %>% 
  filter(n_new_scars>0) %>% 
  distinct(colony_id) %>% 
  nrow()

#Number of grazed colonies by taxa
coral_scar_df %>% 
  filter(n_new_scars>0) %>%
  group_by(coral_species) %>%
  tally() %>%
  arrange(-n)

#Total number of colonies grazed for top four predated species
n_top_4_grazed <- coral_scar_df %>% 
  filter(n_new_scars>0) %>%
  filter(coral_species %in% c("Orbicella annularis", "Branching Porites spp.", "Porites astreoides", "Siderastrea siderea")) %>% 
  distinct(colony_id) %>% 
  nrow()

#>80% of observed predation was on these four coral species
n_top_4_grazed/n_grazed_cols*100
```
```{r Summarizing coral species selectivity by region for heavily targeted taxa}
#raw selectivity data
selectivity_df_species <- coral_scar_df %>%
  filter(coral_species %in% c("Orbicella annularis", "Branching Porites spp.", "Porites astreoides", "Siderastrea siderea")) %>%
  mutate(coral_species=factor(coral_species, levels = c("Orbicella annularis", "Branching Porites spp.", "Porites astreoides", "Siderastrea siderea"))) %>% 
    group_by(region, site, coral_species) %>%
   dplyr::reframe(total_n_scars=sum(n_new_scars),
                  total_n_colonies=n(),
                  total_scar_area=sum(total_grazed_cm2),
                  total_colony_area=sum(col_area_cm2)) %>%
  #Vanderploeg and Scavia’s relativised electivity, E*
  mutate(n_elect_vs= electivity::vs_electivity(total_n_scars, total_n_colonies),
         area_elect_vs= electivity::vs_electivity(total_scar_area, total_colony_area),
         percent_cover=(total_colony_area/300000)*100) %>%
  mutate(region_short=case_when(region=="Panamá"~"PAN",
                                region=="St. Croix"~"STX",
                                region=="Florida"~"FLA",
                                region=="Bonaire"~"BON",
                                TRUE~as.character(region)),
         region_short=factor(region_short, levels = c("PAN", "FLA", "STX", "BON"))) %>%
  mutate(n_elect_vs=case_when(n_elect_vs=="NaN"~-1,
                   TRUE~as.double(n_elect_vs)),
         area_elect_vs=case_when(area_elect_vs=="NaN"~-1,
                   TRUE~as.double(area_elect_vs))) %>%
  ungroup()
  
#mean selectivity and 95% confidence intervals
species_selectivity_summary_stats <- selectivity_df_species %>%
  group_by(region, region_short, coral_species) %>%
   dplyr::reframe(mean_n_elect_vs=mean(n_elect_vs),
                  sd_n_elect_vs= sd(n_elect_vs),
                  mean_area_elect_vs=mean(area_elect_vs),
                  sd_area_elect_vs= sd(area_elect_vs),
                  n=n()) %>%
  #calculating mean and 95% CI
  mutate(ci_lower_n_elect=mean_n_elect_vs-(qnorm(0.975)*sd_n_elect_vs/sqrt(n)),
         ci_upper_n_elect=mean_n_elect_vs+(qnorm(0.975)*sd_n_elect_vs/sqrt(n)),
         ci_lower_area_elect=mean_area_elect_vs-(qnorm(0.975)*sd_area_elect_vs/sqrt(n)),
         ci_upper_area_elect=mean_area_elect_vs+(qnorm(0.975)*sd_area_elect_vs/sqrt(n))) %>%
  #limiting bounds to between -1 and 1 (as values beyond this have no meanining in the electivity index)
  mutate(ci_lower_n_elect=case_when(ci_lower_n_elect < -1 ~ -1,
                                    TRUE~as.double(ci_lower_n_elect)),
         ci_upper_n_elect=case_when(ci_upper_n_elect > 1 ~ 1,
                                    TRUE~as.double(ci_upper_n_elect)),
         ci_lower_area_elect=case_when(ci_lower_area_elect < -1 ~ -1,
                                    TRUE~as.double(ci_lower_area_elect)),
         ci_upper_area_elect=case_when(ci_upper_area_elect > 1 ~ 1,
                                    TRUE~as.double(ci_upper_area_elect))) %>%
  #determing significance (sig. avoidance if 95% CIs are <0, sig. preference if >0, neutral if the 95% CI crosses 0)
  mutate(abundance_selectivity_sig=case_when(ci_lower_n_elect <0 & ci_upper_n_elect>0~"NS",
                                   ci_lower_n_elect <0 & ci_upper_n_elect<0~"Avoidance",
                                   ci_lower_n_elect >0 & ci_upper_n_elect>0~"Preference"),
         area_selectivity_sig=case_when(ci_lower_area_elect <0 & ci_upper_area_elect>0~"NS",
                                   ci_lower_area_elect <0 & ci_upper_area_elect<0~"Avoidance",
                                   ci_lower_area_elect >0 & ci_upper_area_elect>0~"Preference")) %>%
  ungroup()

#creating longer form selectivity summary stats and raw data
abundance_subset <- species_selectivity_summary_stats %>%
  select(region_short, coral_species, mean_electivity=mean_n_elect_vs, ci_lower=ci_lower_n_elect, ci_upper=ci_upper_n_elect) %>%
  mutate(metric="Abundance-based")

area_subset <-species_selectivity_summary_stats %>%
  select(region_short, coral_species, mean_electivity=mean_area_elect_vs, ci_lower=ci_lower_area_elect, ci_upper=ci_upper_area_elect) %>%
  mutate(metric="Area-based")
 
combined_selectivity_summary <- bind_rows(abundance_subset, area_subset) 

selectivity_raw <- selectivity_df_species %>%
  ungroup() %>%
  select(region_short, site, coral_species, n_elect_vs, area_elect_vs) %>%
  pivot_longer(n_elect_vs:area_elect_vs, names_to = "index", values_to="electivity") %>%
  mutate(metric=case_when(grepl("n_elect", index)~"Abundance-based",
                          grepl("area_elect", index)~"Area-based")) %>%
  select(-index) 
```

```{r Fig. S3: Coral taxa selectivity by site and region, fig.height = 4.33, fig.width = 8.46}
#creating preliminary figure
selectivity_combo_fig <- ggplot()+
  geom_point(data=selectivity_raw, aes(y=region_short, x=electivity, color=region_short), alpha=0.5, position=position_jitter(height=0.1))+ #raw data points
  geom_pointrange(data=combined_selectivity_summary, aes(y=region_short, x=mean_electivity, xmin=ci_lower, xmax=ci_upper, fill=region_short), color="black", pch=21, size=0.5)+ #mean and 95% CI
  scale_x_discrete(limits = rev)+ #so regions are in same order as in previous figs
  scale_colour_manual(values=region_palette)+
  scale_fill_manual(values=region_palette)+
  xlim(-1.1,1.1)+ #slightly larger than -1 and 1 so that jitter isn't out of bounds
  geom_vline(xintercept=0,linetype=2)+ #dashed line at 0 (no electivity)
  theme_bw()+
  labs(x="V.S. relativized electivity (E*)", y="Region")+
  facet_grid(metric~coral_species)+ 
  coord_flip()+ 
  theme(legend.position = "none")

#reading in coral genus icons
branching_porties_image <- magick::image_read(path=here("figures_tables/reef_images", "Branching_porties.png"), density = NULL, depth = NULL, strip = TRUE)
orbicella_image <- magick::image_read(path=here("figures_tables/reef_images", "Orbicella_annularis.png"), density = NULL, depth = NULL, strip = TRUE)
porites_astreoides_image <- magick::image_read(path=here("figures_tables/reef_images", "Porites_astreoides.png"), density = NULL, depth = NULL, strip = TRUE)
siderastrea_image <- magick::image_read(path=here("figures_tables/reef_images", "Siderastrea_siderea.png"), density = NULL, depth = NULL, strip = TRUE)

#adding coral images to figure (image placement is off in R, but good in ggsave generated png)
selectivity_combo_final <- cowplot::ggdraw() +
  draw_plot(selectivity_combo_fig)+ #adds the plot (order matters to overlay the layers correctly)
  draw_image(orbicella_image, x = -0.245, y = 0.377, scale=0.07)+
  draw_image(branching_porties_image, x = -0.019, y = 0.375, scale=0.09)+
  draw_image(porites_astreoides_image, x = 0.205, y = 0.38, scale=0.07)+
  draw_image(siderastrea_image, x = 0.43, y = 0.38, scale=0.06)

#saving figure
ggsave(plot=selectivity_combo_final, filename=here("supplements/fig_s3_selectivity_by_species.png"), width = 215, height = 110, dpi = 600, units = "mm")

selectivity_combo_final
```

**Fig. S3.** Mean Vanderploeg and Scavia’s relativized electivity by region (point with black outline) ± 95% C.I. for four frequently targeted coral taxa across Panamá, Florida, St. Croix, and Bonaire. Electivity was calculated based on scar abundance relative to coral abundance (top panel) and scar area relative to coral area (bottom panel). Site-level values are shown transparently in the background. Positive values indicate a preference, values crossing 0 indicate random feeding, and negative values indicate avoidance. >80% of all observed recent predation scars were found on *Orbicella annularis*, Branching *Porites* spp., *Porites astreoides*, and *Siderastrea siderea*.

# ___________________________________________________________________________________

#Variation in corallivory intensity within and among reefs

##Visualizing patterns across reefs

```{r Fig. 4: Corallivory intensity by parrotfish density and coral cover, message=FALSE, echo=FALSE}
#scar density ~ corallivore density
site_level_scar_density_by_corallivore_density <- fish_corals_site_level %>%
  ggplot()+
  geom_smooth(aes(x=mean_density_major_corallivores, y=mean_scars_m2_coral, color=region),method="lm")+
  geom_point(aes(x=mean_density_major_corallivores, y=mean_scars_m2_coral, color=region), alpha=0.7)+
  scale_color_manual(values=region_palette)+
  scale_y_continuous(trans = scales::log_trans(),
                     breaks= c(0.1, 1, 10, 100),
                     labels= c(0.1, 1, 10, 100))+
  scale_x_continuous(expand = c(0.1, 0))+ #values near 0 cutoff, expands x-axis to resolve issue
  labs(x=expression(paste("Major corallivore density (n 100 ", m^-2, ")")), 
       y=expression(paste("Scar density (n ", m^-2, " coral)")), 
       color="Region")  +
  theme_bw()+
  rremove("x.title") + 
  rremove("x.ticks") + 
  rremove("x.text")

#coral area grazed ~ corallivore density
site_level_coral_area_grazed_by_corallivore_density <- fish_corals_site_level %>%
  ggplot()+
  geom_smooth(aes(x=mean_density_major_corallivores, y=mean_pct_coral_grazed, color=region), method="lm")+
  geom_point(aes(x=mean_density_major_corallivores, y=mean_pct_coral_grazed, color=region), alpha=0.7)+
  scale_color_manual(values=region_palette)+
  scale_y_continuous(trans = scales::log_trans(),
                     breaks= c(0.00025, 0.0025, 0.025, 0.25, 2.5, 0.25),
                     labels= c(0.00025, 0.0025, 0.025, 0.25, 2.5, 0.25))+
  scale_x_continuous(expand = c(0.1, 0))+ #values near 0 cutoff, expands x-axis to resolve issue
  labs(x=expression(paste("Major corallivore density (n 100 ", m^-2, ")")), 
       y=expression(paste("Coral area predated (%)")), 
       color="Region") +
  theme_bw()

#scar density ~ coral cover
site_level_scar_density_by_coral_cover <- fish_corals_site_level %>%
  ggplot()+
  geom_smooth(aes(y=mean_scars_m2_coral, x=mean_pct_coral_cover, color=region), method="lm")+
  geom_jitter(aes(y=mean_scars_m2_coral, x=mean_pct_coral_cover, color=region), alpha=0.7)+
  scale_colour_manual(values=region_palette)+
  scale_y_continuous(trans = scales::log_trans(),
                     breaks= c(0.1, 1, 10, 100),
                     labels= c(0.1, 1, 10, 100))+
  labs(y=expression(paste("Scar density (n ", m^-2, " coral)")), x="Coral cover (%)", color="Region")+
  theme_bw()+
  theme(legend.position = "top")+ 
  rremove("x.title") + 
  rremove("x.ticks") + 
  rremove("x.text")+
  rremove("y.title") + 
  rremove("y.ticks") + 
  rremove("y.text")

#coral area grazed ~ coral cover
site_level_coral_area_grazed_by_coral_cover <- fish_corals_site_level %>%
  ggplot()+
  geom_smooth(aes(y=mean_pct_coral_grazed, x=mean_pct_coral_cover, color=region), method="lm")+
  geom_jitter(aes(y=mean_pct_coral_grazed, x=mean_pct_coral_cover, color=region), alpha=0.7)+
  scale_colour_manual(values=region_palette)+
  scale_y_continuous(trans = scales::log_trans(),
                     breaks= c(0.00025, 0.0025, 0.025, 0.25, 2.5, 0.25),
                     labels= c(0.00025, 0.0025, 0.025, 0.25, 2.5, 0.25))+
  labs(y="Coral area predated (%)", x="Coral cover (%)", color="Region")+
  theme_bw()+
  theme(legend.position = "top")+
  rremove("y.title") +  
  rremove("y.ticks") + 
  rremove("y.text")
  
#a regular ggarrange plot with all four fig panels had weird spacing, this is a hacky get around for that
site_level_corallivory_patterns_ac <- ggpubr::ggarrange(site_level_scar_density_by_corallivore_density + 
                                                          theme(plot.margin =unit(c(t = 5, r = 5, b = 5, l = 25), "pt"))+
                                                          rremove("legend"),
                                                        site_level_coral_area_grazed_by_corallivore_density+
                                                          theme(plot.margin =unit(c(t = 5, r = 5, b = 5, l = 25), "pt"),
                                                                axis.title.x = element_text(margin = margin(t = 2.5, r = 0, b = 0, l = 0)))+
                                                           rremove("legend"),
                                                         nrow=2,
                                                         ncol=1,
                                                         align="v", 
                                                         labels=c("a", "c"),
                                                         heights=c(1, 1.15))

site_level_corallivory_patterns_bd <- ggpubr::ggarrange(site_level_scar_density_by_coral_cover+ 
                                                          theme(plot.margin =unit(c(t = 0, r = 5, b = 5, l = 25), "pt"))+
                                                          rremove("legend"),
                                                     site_level_coral_area_grazed_by_coral_cover+
                                                          theme(plot.margin =unit(c(t = 5, r = 5, b = 0, l = 25), "pt"),
                                                                axis.title.x = element_text(
                                                                   margin = margin(t = 7.5, r = 0, b = 0, l = 0)))+
                                                       rremove("legend"),
                                                     nrow=2,
                                                     ncol=1,
                                                     align="v", 
                                                     labels=c("b", "d"),
                                                     heights=c(1, 1.15))

site_level_corallivory_patterns_temp <- ggpubr::ggarrange(site_level_corallivory_patterns_ac, 
                                                     site_level_corallivory_patterns_bd+
                                                       theme(plot.margin =unit(c(5, 5, 5, 5), "pt")),
                                                     widths=c(1.2, 1))

common_legend <- ggpubr::get_legend(site_level_scar_density_by_coral_cover) %>% 
  as_ggplot() 

site_level_corallivory_patterns <- ggpubr::ggarrange(common_legend,
                                                     site_level_corallivory_patterns_temp,
                                                     nrow=2,
                                                     ncol=1,
                                                     heights = c(1,10))

site_level_corallivory_patterns_with_images <- cowplot::ggdraw() +
  draw_plot(site_level_corallivory_patterns)+ 
  draw_image(major_corallivore_icon,  x = -0.38, y = -0.47, scale=0.08) + #adds the major pf icon
  draw_image(coral_icon, x = 0.175, y = -0.47, scale=0.055)+ #adds the coral
  draw_image(corallivory_icon,  x = -0.448, y = 0.379, scale=0.055) + #adds corallivory icon
  draw_image(corallivory_icon,  x = -0.448, y = -0.05, scale=0.055) #adds corallivory icon

ggsave(plot=site_level_corallivory_patterns_with_images, 
       filename=here("figures_tables/fig4_corallivory_by_coral_and_fish.jpg"), 
       width = 215, height = 160, dpi = 600, units = "mm")

site_level_corallivory_patterns_with_images
```

**Fig. 4.** (a & b) Site-level predation scar density and (c & d) percent coral area predated in response to major corallivorous parrotfish density (a & c) and the percent cover of target coral species (b & d). Relative scar density and percent coral area predated are shown on a log-transformed scale. The line of best fit by region and 95% confidence intervals are included.

##Analysis of patterns across reefs

**Model:** GLMM of natural-log transformed scar density in response to parrotfish density and coral cover.

*Random slope and intercept model:* Initially, we ran models using a random slope and intercept, but the high correlation of the random effects was problematic for model convergence and can compromise the power of the models. This may have been caused by not having enough data to properly estimate the random slope components given the observed variance. Therefore, we used reran the model using a random intercept but not a random slope.

*Model with interaction:* We tested for an interaction between corallivore density and coral cover. As this interaction was not significant, we removed the interaction term in the final model.

*Final model:* The final model was fit with a random intercept by region and the fixed effects of corallivore density and coral cover (with no interaction). 

```{r Data analysis: Scar density by major corallivore density + coral cover, warning=FALSE, message=FALSE}
set.seed(1945) #for reproducible results from random simulations of residuals

#random-slope and intercept model with interaction
scar_density_m1_randslope_interaction <- glmmTMB::glmmTMB(log(mean_scars_m2_coral) ~ mean_density_major_corallivores*mean_pct_coral_cover + (mean_density_major_corallivores + mean_pct_coral_cover | region), #transects nested within sites within regions
                              data = fish_corals_site_level,
                              family=gaussian)

#high correlation of random slopes, using random-intercept only model
scar_density_m1_randslope_interaction %>% summary() 

#random-intercept model 
scar_density_m1 <- glmmTMB::glmmTMB(log(mean_scars_m2_coral) ~ mean_density_major_corallivores*mean_pct_coral_cover +
                              (1 | region), #transects nested within sites within regions
                              data = fish_corals_site_level,
                              family=gaussian)

#evaluating model fit
scar_density_m1_residuals <- DHARMa::simulateResiduals(scar_density_m1, n = 10000, use.u = T) 
DHARMa::testDispersion(scar_density_m1_residuals, plot=F) #no significant overdispersion
plot(scar_density_m1_residuals) #KS test significant

hist(fish_corals_site_level$mean_density_major_corallivores) #skewness may be influencing KS test significance
hist(sqrt(fish_corals_site_level$mean_density_major_corallivores)) #not perfect, but less skewness with sqrt transformation

#rerunning model with square-root tranformation of corallivore density to attempt to address KS test issues
scar_density_m2 <- glmmTMB::glmmTMB(log(mean_scars_m2_coral) ~ sqrt(mean_density_major_corallivores)*(mean_pct_coral_cover) +
                              (1 | region), #transects nested within sites within regions
                              data = fish_corals_site_level,
                              family=gaussian)

#evaluating model fit
scar_density_m2_residuals <- DHARMa::simulateResiduals(scar_density_m2, n = 10000, use.u = T) 
DHARMa::testDispersion(scar_density_m2_residuals, plot=F) #no significant overdispersion
plot(scar_density_m2_residuals) #KS test no longer significant following transformation

#viewing model results
scar_density_m2 %>% summary()

#tidying model output and calculating confidence intervals
scar_density_m1_ci <- confint(scar_density_m1) %>% 
  as_tibble() %>%
  select(-Estimate)

scar_density_model_output <- scar_density_m1 %>% 
  broom.mixed::tidy() %>% 
  filter(term != "sd__Observation") %>%
  bind_cols(scar_density_m1_ci) %>%
  filter(effect!="ran_pars") %>%
  janitor::clean_names() %>%
  rename(ci_2.5 = x2_5_percent, ci_97.5=x97_5_percent) %>%
  mutate(model="Scar density") %>%
  select(model, term, statistic, p_value, estimate, ci_2.5, ci_97.5) %>%
  mutate(across(where(is.double), ~round(.x, 3)))

scar_density_model_output
```

**Model:** GLMM of natural-log transformed percent coral area grazed in response to parrotfish density and coral cover.

*Random slope and intercept model:* Initially, we ran models using a random slope and intercept, but the high correlation of the random effects was problematic for model convergence and can compromise the power of the models. Therefore, we used reran the model using a random intercept but not a random slope.

*Model with interaction:* Additionally, we tested for an interaction between corallivore density and coral cover. As this interaction was not significant, we dropped the interaction term.

*Final model:* The final model was fit with a random intercept by region and the fixed effects of corallivore density and coral cover (with no interaction). 

```{r Data analysis: Coral area grazed by parrotfish density + coral cover, warning=FALSE, message=FALSE}
set.seed(1945) #for reproducible results from random simulations of residuals

# Random-slope and intercept model with interaction
proportion_grazed_m1_randslope_interaction <- glmmTMB::glmmTMB(log(mean_pct_coral_grazed) ~ mean_density_major_corallivores*mean_pct_coral_cover +
                              (mean_density_major_corallivores + mean_pct_coral_cover | region), #transects nested within sites within regions
                              data = fish_corals_site_level,
                              family=gaussian)

proportion_grazed_m1_randslope_interaction %>% summary() #high correlation of random slopes and intercepts for mean_density_major_corallivores causing issue, using random-intercept only model

#Random-slope model with interaction
proportion_grazed_m1 <- glmmTMB::glmmTMB(log(mean_pct_coral_grazed) ~ mean_density_major_corallivores*mean_pct_coral_cover +
                              (1 | region), #transects nested within sites within regions
                              data = fish_corals_site_level,
                              family=gaussian)

proportion_grazed_m1_residuals <- DHARMa::simulateResiduals(proportion_grazed_m1, n = 10000, use.u = T) 
DHARMa::testDispersion(proportion_grazed_m1_residuals, plot=F) #no significant overdispersion
plot(proportion_grazed_m1_residuals) #no sig quantile deviations, but compare with transformation of corallivore density as with prior model

#Significant quantile deviations in previous model, using transformation of predictor to address this
proportion_grazed_m2 <- glmmTMB::glmmTMB(log(mean_pct_coral_grazed) ~ sqrt(mean_density_major_corallivores)*mean_pct_coral_cover +
                              (1 | region), #transects nested within sites within regions
                              data = fish_corals_site_level,
                              family=gaussian)

proportion_grazed_m2_residuals <- DHARMa::simulateResiduals(proportion_grazed_m2, n = 10000, use.u = T) 
DHARMa::testDispersion(proportion_grazed_m2_residuals, plot=F) #no significant overdispersion
plot(proportion_grazed_m2_residuals) #no sig deviations and residual vs predicted plot look  better post transformation

#viewing model results
proportion_grazed_m2 %>% summary()

#tidying model output and calculating confidence intervals
proportion_grazed_m1_ci <- confint(proportion_grazed_m1) %>% 
  as_tibble() %>%
  select(-Estimate)

proportion_grazed_model_output <- proportion_grazed_m1 %>% 
  broom.mixed::tidy() %>% 
  filter(term != "sd__Observation") %>%
  bind_cols(proportion_grazed_m1_ci) %>%
  filter(effect!="ran_pars") %>%
  janitor::clean_names() %>%
  rename(ci_2.5 = x2_5_percent, ci_97.5=x97_5_percent) %>%
  mutate(model="Percent grazed") %>%
  select(model, term, statistic, p_value, estimate, ci_2.5, ci_97.5) %>%
  mutate(across(where(is.double), ~round(.x, 3)))
```

Table summarizing the results of both site-level GLMMs
```{r Table S4: Summary of site-level GLMM results}
table_s4 <- scar_density_model_output %>% 
  bind_rows(proportion_grazed_model_output)

write_csv(table_s4, here("supplements/table_s4_site_level_glmm_results.csv"))
```

## Transect-level effects of coral diversity and taxa-specific coral cover

We calculated diversity using the Shannon Index (H')

```{r Summarizing coral diversity by transect}
set.seed(1945) #for reproducible results from random simulations of residuals

# total abundance of colonies per transect
total_coral_abundance <- coral_scar_df %>% 
  group_by(region, site, transect, depth_m) %>% 
  reframe(total_n_colonies=n())

# calculating transect-level coral diversity and coral cover
coral_taxa_abundance_cover <- coral_scar_df %>% 
  group_by(region, site, transect, depth_m, coral_species) %>% 
  reframe(n_colonies=n(), #transect-level abundance of coral colonies per species 
          pct_coral_cover_species=(sum(col_area_cm2)/300000)*100) %>% #coral cover by species
  left_join(total_coral_abundance) #total coral abundance per transect
  
# calculating coral diversity and total coral cover per transect
coral_diversity_and_cover <- coral_taxa_abundance_cover %>%
  mutate(prop_abundance=n_colonies/total_n_colonies, #proportional abundance of coral taxa          
         p_ln_prop_abundance=prop_abundance*log(prop_abundance)) %>% #for diversity calculations
  group_by(region, site, transect, depth_m) %>%
  reframe(coral_diversity=sum(p_ln_prop_abundance)*-1, #summarizing diversity per transect
          pct_coral_cover=sum(pct_coral_cover_species)) #summarizing transect-level coral cover
  
# abundance of colonies per species per transect
n_colonies_species_transect <- coral_scar_df %>% 
  group_by(region, site, transect, depth_m, coral_species) %>% 
  dplyr::reframe(n_colonies=n()) %>% #transect-level abundance of coral colonies per species 
  left_join(total_coral_abundance, by = join_by(region, site, transect, depth_m))

# transect-level summary of the number of grazed colonies of four heavily predated taxa
transect_level_corallivory <- coral_scar_df %>% 
  group_by(region, site, transect, depth_m, coral_species) %>% 
  filter(n_new_scars>0) %>%
  dplyr::reframe(n_colonies_grazed=n())

transect_corallivory_diversity_df <- coral_taxa_abundance_cover %>% 
  left_join(transect_level_corallivory, by = join_by(region, site, transect, depth_m, coral_species)) %>%
  mutate(n_colonies_grazed=replace_na(n_colonies_grazed, 0)) %>%
  select(region, site, transect, depth_m, coral_species, pct_coral_cover_species, n_colonies_grazed, n_colonies) %>%
  filter(coral_species %in% c("Orbicella annularis", "Porites astreoides", "Branching Porites spp.", "Siderastrea siderea")) %>%
  left_join(coral_diversity_and_cover, by = join_by(region, site, transect, depth_m)) %>%
  mutate(proportional_cover=pct_coral_cover_species/pct_coral_cover)
```

**Model:** GLMM of the number of colonies grazed (per 30 m2 transect) in response to coral diversity (H'), coral species (OANN, PAST, Branching Porites, SSID), species-specific coral cover, transect depth (m), and region, with random effects of transect nested within site.

```{r Data analysis: Influence of coral diversity and cover on transect-level n cols grazed, warning=FALSE, message=FALSE}
set.seed(1945) #for reproducible results from random simulations of residuals

#looking at data distributions
transect_corallivory_diversity_df %>%
  ggplot(aes(n_colonies_grazed))+
  geom_histogram()

#coral cover is severely skewed
transect_corallivory_diversity_df %>%
  ggplot(aes(pct_coral_cover_species))+
  geom_histogram()

#checking that species percent cover does not have 0's
summary(transect_corallivory_diversity_df$pct_coral_cover_species)

#log-transformation normalized coral cover distribution
transect_corallivory_diversity_df %>%
  ggplot(aes(log(pct_coral_cover_species)))+
  geom_histogram()

#scar abundance per colony with poisson
n_grazed_diversity_poisson <- glmmTMB::glmmTMB(n_colonies_grazed ~ coral_diversity+ coral_species+coral_species:log(proportional_cover)+ depth_m+ region+
                              (1 | site/transect), #transects nested within sites within regions
                              family=poisson,
                              data = transect_corallivory_diversity_df)

#scar abundance per colony with negative binomial distribution (without zero-inflation)
n_grazed_diversity_nbinom <- glmmTMB::glmmTMB(n_colonies_grazed ~ coral_diversity+ coral_species+ coral_species:log(proportional_cover)+ depth_m+ region+
                              (1 | site/transect), #transects nested within sites within regions
                              zi=~0, #non zero-inflated
                              family=nbinom2(link = "log"),
                              data = transect_corallivory_diversity_df)

#likelihood ratio tests suggest NS difference between poisson and negative binomial
anova(n_grazed_diversity_poisson, n_grazed_diversity_nbinom) 

#simulating residuals and evaluating model fit
n_grazed_diversity_poisson_residuals <- DHARMa::simulateResiduals(n_grazed_diversity_poisson, n = 10000, use.u = T)
n_grazed_diversity_nbinom_residuals <- DHARMa::simulateResiduals(n_grazed_diversity_nbinom, n = 10000, use.u = T)

plot(n_grazed_diversity_poisson_residuals) #diagnostic plot indicates no sign problems

#testing for overdispersion, zero inflation, and outliers
DHARMa::testDispersion(n_grazed_diversity_poisson_residuals, plot=FALSE) #no significant overdispersion
DHARMa::testZeroInflation(n_grazed_diversity_poisson) #NS zero inflation
DHARMa::testOutliers(n_grazed_diversity_poisson) #NS outliers

n_grazed_diversity_poisson %>% summary()
```

```{r Table S5: Summary of transect-level GLMM results}
n_grazed_diversity_nbinom_ci <- confint(n_grazed_diversity_nbinom) %>% 
  as_tibble() %>%
  select(-Estimate)

#tidying model output
transect_level_model_output <- n_grazed_diversity_nbinom %>% 
  tidy() %>% 
  bind_cols(n_grazed_diversity_nbinom_ci) %>%
  filter(effect!="ran_pars") %>%
  janitor::clean_names() %>%
  rename(ci_2.5 = x2_5_percent, ci_97.5=x97_5_percent) %>%
  mutate(model="Colonies grazed") %>%
  select(model, term, statistic, p_value, estimate, ci_2.5, ci_97.5) %>%
  mutate(across(where(is.double), ~round(.x, 3))) %>%
  mutate(term=str_replace(term, "coral_species", "")) %>%
  mutate(term=str_replace(term, "region", ""))

#back transforming estimated effect sizes (see paper supplements for description)
transect_level_model_output %>%
  #exponentiating all independent variables except proportional cover, which was log transformed
    mutate(estimate_backtransformed = case_when(term!="Branching Porites spp.:log(proportional_cover)"~exp(estimate),
                                                TRUE~as.double(estimate))) %>%
  mutate(across(where(is.double), ~round(.x, 3)))

write_csv(transect_level_model_output, here("supplements/table_s5_transect_level_grazed_coral_abundance_results.csv"))
```

```{r Fig. S4: Abundance corals grazed by coral diversity, fig.height = 3.15, fig.width = 8.46}
corallivory_by_diversity_fig <- transect_corallivory_diversity_df %>%
  mutate(coral_species=factor(coral_species, levels = c("Orbicella annularis", "Branching Porites spp.", "Porites astreoides", "Siderastrea siderea"))) %>% 
  mutate(region= factor(region, levels = c("Panamá", "Florida",  "St. Croix", "Bonaire"))) %>%
  ggplot(aes(x=coral_diversity, y=n_colonies_grazed, color=region))+
  geom_point(alpha=0.6)+
  scale_y_continuous(breaks = c(0,2,4,6,8,10), 
                     labels= c(0,2,4,6,8,10),
                     limits=c(0,10.2))+
  theme_bw()+
  scale_color_manual(values=region_palette)+
  scale_fill_manual(values=region_palette)+
  facet_wrap(~coral_species)+
  labs(x = "Coral diversity (H')",
       y = expression(paste("Colonies predated per 30 m" ^2)),
       color="Region",
       fill="Region")+
  theme_bw()+
  theme(legend.position = "top")

#reading in coral genus icons
branching_porties_image <- magick::image_read(path=here("figures_tables/reef_images", "Branching_porties.png"), density = NULL, depth = NULL, strip = TRUE)
orbicella_image <- magick::image_read(path=here("figures_tables/reef_images", "Orbicella_annularis.png"), density = NULL, depth = NULL, strip = TRUE)
porites_astreoides_image <- magick::image_read(path=here("figures_tables/reef_images", "Porites_astreoides.png"), density = NULL, depth = NULL, strip = TRUE)
siderastrea_image <- magick::image_read(path=here("figures_tables/reef_images", "Siderastrea_siderea.png"), density = NULL, depth = NULL, strip = TRUE)

#adding coral images to figure (image placement is off in R, but good in ggsave generated png)
corallivory_by_diversity_fig_final <- cowplot::ggdraw() +
  draw_plot(corallivory_by_diversity_fig)+ #adds the plot (order matters to overlay the layers correctly)
  draw_image(orbicella_image, x = -0.385, y = 0.29, scale=0.075)+
  draw_image(branching_porties_image, x = 0.081, y = 0.29, scale=0.08)+
  draw_image(porites_astreoides_image, x = -0.385, y = -0.113, scale=0.062)+
  draw_image(siderastrea_image, x = 0.08, y = -0.11, scale=0.063)

#saving figure
ggsave(plot=corallivory_by_diversity_fig_final, filename=here("supplements/fig_s4_corallivory_by_coral_diversity.png"), width = 190, height = 140, dpi = 600, units = "mm")

corallivory_by_diversity_fig_final
```

**Fig. S4.** Number of Orbicella annularis, Branching Porites spp., Porites astreoides, and Siderastrea siderea coral colonies predated per 30 m^2 reef area in response to the diversity of target coral taxa within the area (n=441 total colonies of these species present within transects). We calculated diversity using the Shannon Diversity Index (H’) based on the richness and evenness of the number of target coral colonies within a given transect. We focused on evaluated the abundance of corals predated for these four taxa as they accounted for >80% of observed colonies with recent predation scars. 

# ___________________________________________________________________________________

## Colony-level analysis

We analyzed the effect of coral colony surface area and coral taxa on the abundance of scars per coral colony using GLMM with a poisson distribution. We tested for zero-inflation, which was significant. Since the poisson error distribution assumes the mean and variance are the same, but negative binomial models have different means and variance, a negative binomial model is more appropriate for these data.

```{r Data analysis: Scar abundance by colony size + coral species + region}
set.seed(1945) #for reproducible results from random simulations of residuals

#scar abundance per colony with poisson
n_scars_col_level_poisson <- glmmTMB::glmmTMB(n_new_scars ~ col_area_cm2 + coral_species + region+
                              (1 | site/transect), #transects nested within sites within regions
                              family=poisson,
                              data = coral_scar_df)

n_scars_col_level_poisson %>% summary()

#scar abundance per colony with negative binomial distribution (without zero-inflation)
n_scars_col_level_nbinom <- glmmTMB::glmmTMB(n_new_scars ~ col_area_cm2 + coral_species + region+
                              (1 | site/transect), #transects nested within sites within regions
                              zi=~0, #non zero-inflated
                              family=nbinom2(link = "log"),
                              data = coral_scar_df)

#likelihood ratio test of model using poisson versus negative binomial distribution
anova(n_scars_col_level_poisson, n_scars_col_level_nbinom)

#simulating residuals and testing
n_scars_col_level_residuals <- DHARMa::simulateResiduals(n_scars_col_level_nbinom, n = 10000, use.u = T)

#testing for zero-inflation in negative binomial model: zero-inflation not significant
n_scars_col_level_zero_inf_test<- DHARMa::testZeroInflation(n_scars_col_level_residuals)
n_scars_col_level_zero_inf_test

DHARMa::testDispersion(n_scars_col_level_residuals, plot=FALSE) #no significant overdispersion
plot(n_scars_col_level_residuals) #NS overdispersion or outliers

#model output
n_scars_col_level_nbinom %>% summary()

#summary of mean number of new scars per colony by region
coral_scar_df %>% 
  group_by(region) %>% 
  dplyr::reframe(mean_n_new_scars=mean(n_new_scars)) %>%
  mutate(mean_n_new_scars=round(mean_n_new_scars, 3))

coral_scar_df %>% 
  group_by(coral_species) %>% 
  reframe(mean_new_scars=mean(n_new_scars),
          sem=sem(n_new_scars))
```

```{r Table S6: Colony-level scar abundance model output}
#tidying model output and calculating confidence intervals
n_scars_col_level_ci <- confint(n_scars_col_level_nbinom) %>% 
  as_tibble() %>%
  select(-Estimate)

#tidying model output
n_scars_col_level_model_output <- n_scars_col_level_nbinom %>% 
  tidy() %>% 
  bind_cols(n_scars_col_level_ci) %>%
  filter(effect!="ran_pars") %>%
  janitor::clean_names() %>%
  rename(ci_2.5 = x2_5_percent, ci_97.5=x97_5_percent) %>%
  mutate(model="Scar abundance") %>%
  select(model, term, statistic, p_value, estimate, ci_2.5, ci_97.5) %>%
  mutate(across(where(is.double), ~round(.x, 3))) %>%
  mutate(term=str_replace(term, "coral_species", ""))

#back transforming estimated effect sizes (see paper supplements for description)
n_scars_col_level_model_output %>%
  #exponentiating all independent variables
  mutate(estimate_backtransformed = exp(estimate)) %>%
  mutate(across(where(is.double), ~round(.x, 3)))

n_scars_col_level_model_output

write_csv(n_scars_col_level_model_output, here("supplements/table_s6_colony_level_scar_abundance_results.csv"))
```

```{r Data processing: Filtering data to only include colonies with predation scars}
predated_colonies_subset <- coral_scar_df %>% 
  mutate(pct_grazed=total_grazed_cm2/col_area_cm2*100) %>%
  filter(n_new_scars>0) %>%
  #organizing as factor so the Branching Porites spp. cat is grouped with P. astreoides
  mutate(coral_species=factor(coral_species, levels = c("Agaricia agaricites", "Agaricia humilis", "Agaricia tenuifolia", "Agaricia spp.", "Madracis auretenra", "Madracis decactis", "Orbicella annularis", "Orbicella faveolata", "Branching Porites spp.", "Porites astreoides", "Siderastrea siderea", "Stephanocoenia intersepta"))) %>%
  mutate(region= factor(region, levels = c("Panamá", "Florida",  "St. Croix", "Bonaire"))) 

coral_scar_df %>% 
  filter(n_new_scars>0)
```

**Model:** GLMM of natural-log transformed mean scar area per predated colony in response to colony size, species, and region with the random nested effects of transect within site.

```{r Data analysis: Mean scar area by coral size + species + region}
set.seed(1945) #for reproducible results from random simulations of residuals

mean_scar_size <- glmmTMB::glmmTMB(log(mean_scar_area_cm2) ~ log(col_area_cm2) + coral_species + region+
                              (1 | site/transect), #transects nested within sites within regions
                              family=gaussian,
                              data = predated_colonies_subset)

#checking model residuals
mean_scar_size_residuals <- DHARMa::simulateResiduals(mean_scar_size, n = 10000, use.u = T) 
DHARMa::testDispersion(mean_scar_size_residuals) #no sig. overdispersion
plot(mean_scar_size_residuals) #KS test NS, NS  outliers

#checking model results
mean_scar_size %>% summary()
```

```{r Table S7: Colony-level mean scar size model output}
mean_scar_size_col_level_ci <- confint(mean_scar_size) %>% 
  as_tibble() %>%
  select(-Estimate)

mean_scar_size_col_level_model_output <- mean_scar_size %>% 
  tidy() %>% 
  filter(term != "sd__Observation") %>%
  bind_cols(mean_scar_size_col_level_ci) %>%
  filter(effect!="ran_pars") %>%
  janitor::clean_names() %>%
  rename(ci_2.5 = x2_5_percent, ci_97.5=x97_5_percent) %>%
  mutate(model="Colony-level mean scar size") %>%
  select(model, term, statistic, p_value, estimate, ci_2.5, ci_97.5) %>%
  mutate(across(where(is.double), ~round(.x, 3))) %>%
  mutate(term=str_replace(term, "coral_species", ""))

#back transforming estimated effect sizes (see paper supplements for description)
mean_scar_size_col_level_model_output %>%
  #exponentiating all independent variables except coral area, which was log transformed
    mutate(estimate_backtransformed = case_when(term!="log(col_area_cm2)"~exp(estimate),
                                                TRUE~as.double(estimate))) %>%
   mutate(across(where(is.double), ~round(.x, 3)))
  
write_csv(mean_scar_size_col_level_model_output, here("supplements/table_s7_colony_level_mean_scar_size_results.csv"))
```

**Model:** GLMM of natural-log transformed percent area grazed per predated colony in response to colony size, species, and region with the random nested effects of transect within site.

```{r Data analysis: Percent colony grazed by coral size + species + region, warning=FALSE}
set.seed(1945) #for reproducible results from random simulations of residuals

pct_grazed <- glmmTMB::glmmTMB(log(pct_grazed) ~ log(col_area_cm2) + coral_species + region+
                              (1 | site/transect), #transects nested within sites within regions
                              family=gaussian,
                              data = predated_colonies_subset)

#checking model residuals
pct_grazed_residuals <- DHARMa::simulateResiduals(pct_grazed, n = 10000, use.u = T) 
DHARMa::testDispersion(pct_grazed_residuals) #no significant overdispersion
plot(pct_grazed_residuals) #dispersion, outliers, and KS all good

#model results
pct_grazed %>% summary()
```

```{r Table S8: Colony-level percent coral grazed model output}
pct_grazed_col_level_ci <- confint(pct_grazed) %>% 
  as_tibble() %>%
  select(-Estimate)

pct_grazed_col_level_model_output <- pct_grazed %>% 
  tidy() %>% 
  filter(term != "sd__Observation") %>%
  bind_cols(pct_grazed_col_level_ci) %>%
  filter(effect!="ran_pars") %>%
  janitor::clean_names() %>%
  rename(ci_2.5 = x2_5_percent, ci_97.5=x97_5_percent) %>%
  mutate(model="Colony-level percent coral grazed") %>%
  select(model, term, statistic, p_value, estimate, ci_2.5, ci_97.5) %>%
  mutate(across(where(is.double), ~round(.x, 3))) %>%
  mutate(term=str_replace(term, "coral_species", ""))

#back transforming estimated effect sizes (see paper supplements for description)
pct_grazed_col_level_model_output %>%
  #exponentiating all independent variables except coral area, which was log transformed
    mutate(estimate_backtransformed = case_when(term!="log(col_area_cm2)"~exp(estimate),
                                                TRUE~as.double(estimate))) %>%
   mutate(across(where(is.double), ~round(.x, 3)))

write_csv(pct_grazed_col_level_model_output,  here("supplements/table_s8_colony_level_percent_coral_grazed_results.csv"))
```

```{r Fig. 5 (a) Scar area and (b) percent colony grazed by taxa + region, predated_coral_patterns, fig.height = 3.15, fig.width = 8.46}
#list of coral species arranged by the total number of colonies with scars
coral_species_arranged_by_n_grazed <- predated_colonies_subset %>% 
  group_by(coral_species) %>% 
  dplyr::reframe(n_grazed=n()) %>% 
  arrange(-n_grazed)

#used in graphs to simultaneously jitter and nudge points to avoid overlap
jitter_nudge <- ggpp::position_jitternudge(height = 0.08, y = -0.1, nudge.from = "jittered")

#summarizing y min and max for axis limits in following figure
predated_colonies_subset %>%
  dplyr::reframe(min(mean_scar_area_cm2), max(mean_scar_area_cm2))

#first figure in set
fig_mean_scar_taxa <-predated_colonies_subset %>%
  #for consistent order of regions
  mutate(region= factor(region, levels = c("Panamá", "Florida",  "St. Croix", "Bonaire"))) %>%
  #arranging coral species by the number of colonies with scars
  mutate(coral_species= factor(coral_species, levels = c("Porites astreoides", "Branching Porites spp.", "Orbicella annularis","Siderastrea siderea","Agaricia agaricites","Agaricia tenuifolia", "Madracis decactis", "Orbicella faveolata", "Agaricia humilis", "Madracis auretenra", "Agaricia spp.", "Stephanocoenia intersepta"))) %>%
  ggplot()+
  ggridges::geom_density_ridges(aes(x=mean_scar_area_cm2, y=coral_species), alpha=0.7, scale=0.7)+
  geom_point(aes(x=mean_scar_area_cm2, y=coral_species, color=region), size=0.7, alpha=0.5,
            position=jitter_nudge)+
  scale_color_manual(values=region_palette)+
  scale_fill_manual(values=region_palette)+
  scale_y_discrete(expand = c(0.1, 0), limits = rev)+ 
  scale_x_continuous(trans = scales::log_trans(),
                     breaks = c(0.01, 0.1, 1, 10, 55), 
                     labels= c(0.01, 0.1, 1, 10, 55),
                     limits=c(0.009,56))+
  labs(x = expression(paste("Mean scar surface area (cm" ^2, ")")),
       y = "Coral taxa",
       color="Region",
       fill="Region")+
  theme_bw()+
  theme(legend.position = "top",
        axis.text.y= element_text(face="italic", size = 8),
        axis.text.x=element_text(size = 8),
        axis.title=element_text(size = 10))

#summarizing y min and max for axis limits in following figure
predated_colonies_subset %>%  
  dplyr::reframe(min(pct_grazed), max(pct_grazed))

#second figure in set
fig_pctgrazed_taxa <- predated_colonies_subset %>%
  mutate(region= factor(region, levels = c("Panamá", "Florida",  "St. Croix", "Bonaire"))) %>%
  mutate(coral_species= factor(coral_species, levels = c("Porites astreoides", "Branching Porites spp.", "Orbicella annularis","Siderastrea siderea","Agaricia agaricites","Agaricia tenuifolia", "Madracis decactis", "Orbicella faveolata", "Agaricia humilis", "Madracis auretenra", "Agaricia spp.", "Stephanocoenia intersepta"))) %>%
  ggplot()+
  ggridges::geom_density_ridges(aes(x=pct_grazed, y=coral_species), alpha=0.7, scale=0.7)+
  geom_point(aes(x=pct_grazed, y=coral_species, color=region), size=0.7, alpha=0.6, position=jitter_nudge)+
  scale_color_manual(values=region_palette)+
  scale_fill_manual(values=region_palette)+
  scale_y_discrete(expand = c(0.1, 0), limits = rev)+ #so corals are in alphabetical order
  scale_x_continuous(trans = scales::log_trans(),
                     breaks = c(0.001,  0.01, 0.1, 1, 10, 75), 
                     labels= c(0.001, 0.01, 0.1, 1, 10, 75),
                     limits=c(0.001,75))+
  labs(x = expression(paste("Coral area predated (%)")),
       y = "",
       color="Region",
       fill="Region")+
  theme_bw()+
  theme(legend.position = "top",
       axis.text.y= element_blank(),
       axis.ticks.y=element_blank(),
       axis.text.x=element_text(size = 8),
       axis.title=element_text(size = 10))

#summarizing x min and max for axis limits in following figure
predated_colonies_subset %>%  
  dplyr::reframe(min(col_area_cm2), max(col_area_cm2))

#third figure in set
fig_pctgrazed_colsize <- predated_colonies_subset %>%
  mutate(region= factor(region, levels = c("Panamá", "Florida",  "St. Croix", "Bonaire"))) %>%
  ggplot(aes(y=pct_grazed, x=col_area_cm2, color=region))+
  geom_point(size=0.8, alpha=0.75)+
  geom_smooth(method="lm")+
  scale_colour_manual(values=region_palette)+
  theme_bw()+
  labs(x = expression(paste("Coral colony surface area (", cm^2, ")")),
       y = expression(paste("Coral area predated (%)")), 
       color="Region")+
  scale_y_continuous(trans = scales::log_trans(),
                     breaks = c(0.0001, 0.001, 0.01, 0.1, 1, 10, 25, 75), 
                     labels= c("0.0001", 0.001, 0.01, 0.1, 1, 10, 25, 75),
                     limits=c(0.0001,75))+
  scale_x_continuous(trans = scales::log_trans(),
                    breaks = c(5, 10, 50, 250, 1000, 5000, 20000), 
                    labels= c(5, 10, 50, 250, 1000, 5000, 20000),
                    limits=c(5,20000))+
  theme(legend.position	="none",
       axis.text.x=element_text(size = 8),
       axis.title=element_text(size = 10))

#creating combined three-panel figure
predated_coral_patterns <- ggpubr::ggarrange(fig_mean_scar_taxa, 
                                             fig_pctgrazed_taxa, 
                                             fig_pctgrazed_colsize, 
                                             ncol=3, 
                                             align="h", 
                                             common.legend = TRUE, 
                                             labels=c("a","b", "c"), 
                                             widths=c(1.5,1,1.2), 
                                             legend="top")

#saving figure
ggsave(plot=predated_coral_patterns, filename=here("figures_tables/fig5_predated_coral_patterns.jpg"), width = 215, height = 80, dpi = 600, units = "mm")

predated_coral_patterns
```

**Fig. 5.** Distributions of the natural-log transformed (a) mean predation scar surface area and (b) colony area predated for all target coral taxa. Coral taxa are arranged by the number of observed colonies with recent scars from the highest to lowest. (c) Coral colony area predated (%) in response to colony surface area on a natural-log transformed scale, with the line of best fit by region and 95% confidence interval. Raw data points are shown transparently in the background. 